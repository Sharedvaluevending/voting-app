<%- include('partials/header') %>

<div class="section-header">
  <h2 style="color:#fff;font-size:22px;">Historical Backtest</h2>
  <p style="color:#9ca3af;font-size:13px;margin-top:6px;">Simulate the full trading engine on historical candles. Toggle features to compare performance.</p>
</div>

<!-- Form -->
<div class="section" style="margin-bottom:24px;">
  <h3 style="color:#e5e7eb;margin-bottom:12px;">Backtest Parameters</h3>
  <form id="backtest-form" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;align-items:end;">
    <div>
      <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:4px;">Coin</label>
      <select name="coinId" id="coinId" style="width:100%;padding:8px 12px;background:#0d1320;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;font-size:13px;">
        <option value="">All coins (first 6, ~30s)</option>
        <% if (typeof TRACKED_COINS !== 'undefined' && TRACKED_COINS) { %>
          <% TRACKED_COINS.forEach(function(cid) { %>
            <option value="<%= cid %>"><%= cid %></option>
          <% }); %>
        <% } else { %>
          <option value="bitcoin">bitcoin</option>
          <option value="ethereum">ethereum</option>
          <option value="solana">solana</option>
        <% } %>
      </select>
    </div>
    <div>
      <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:4px;">Start Date</label>
      <input type="date" name="startDate" id="startDate" style="width:100%;padding:8px 12px;background:#0d1320;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;font-size:13px;">
    </div>
    <div>
      <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:4px;">End Date</label>
      <input type="date" name="endDate" id="endDate" style="width:100%;padding:8px 12px;background:#0d1320;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;font-size:13px;">
    </div>
    <div>
      <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:4px;">Min Score</label>
      <input type="number" name="minScore" id="minScore" value="52" min="40" max="80" style="width:100%;padding:8px 12px;background:#0d1320;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;font-size:13px;">
    </div>
    <div>
      <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:4px;">Leverage</label>
      <input type="number" name="leverage" id="leverage" value="2" min="1" max="10" style="width:100%;padding:8px 12px;background:#0d1320;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;font-size:13px;">
    </div>
    <div>
      <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:4px;">Initial Balance ($)</label>
      <input type="number" name="initialBalance" id="initialBalance" value="10000" min="100" max="1000000" step="1" style="width:100%;padding:8px 12px;background:#0d1320;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;font-size:13px;">
    </div>
    <div>
      <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:4px;">Risk Mode</label>
      <select name="riskMode" id="riskMode" style="width:100%;padding:8px 12px;background:#0d1320;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;font-size:13px;">
        <option value="percent">% of balance</option>
        <option value="dollar">Fixed $ per trade</option>
      </select>
    </div>
    <div id="bt-risk-pct-wrap">
      <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:4px;">Risk per trade (%)</label>
      <input type="number" name="riskPerTrade" id="riskPerTrade" value="2" min="0.1" max="10" step="0.1" style="width:100%;padding:8px 12px;background:#0d1320;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;font-size:13px;">
    </div>
    <div id="bt-risk-dollar-wrap" style="display:none;">
      <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:4px;">Risk per trade ($)</label>
      <input type="number" name="riskDollarsPerTrade" id="riskDollarsPerTrade" value="200" min="1" max="10000" step="1" style="width:100%;padding:8px 12px;background:#0d1320;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;font-size:13px;">
    </div>
    <div>
      <button type="submit" class="btn btn-primary" id="run-btn">Run Backtest</button>
    </div>
  </form>
</div>

<!-- Feature Toggles -->
<div class="section" style="margin-bottom:24px;">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;cursor:pointer;" onclick="document.getElementById('feature-toggles').style.display = document.getElementById('feature-toggles').style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-arrow').textContent = document.getElementById('feature-toggles').style.display === 'none' ? '\u25B6' : '\u25BC';">
    <h3 style="color:#e5e7eb;margin:0;">Feature Toggles</h3>
    <span class="toggle-arrow" style="color:#6b7280;font-size:14px;">&#x25BC;</span>
  </div>
  <div id="feature-toggles">
    <p style="color:#6b7280;font-size:12px;margin-bottom:12px;">Toggle individual features on/off to compare performance. All ON = matches live system exactly.</p>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:8px;">
      <!-- Signal Filters -->
      <label class="ft-toggle" title="Block altcoin LONGs when BTC is STRONG_SELL, block SHORTs when BTC is STRONG_BUY">
        <input type="checkbox" id="ft-btcFilter" checked> <span class="ft-badge ft-signal">SIGNAL</span> BTC Signal Filter
      </label>
      <label class="ft-toggle" title="Penalize score up to -8 when coin is highly correlated with BTC but trading against BTC direction">
        <input type="checkbox" id="ft-btcCorrelation" checked> <span class="ft-badge ft-signal">SIGNAL</span> BTC Correlation Penalty
      </label>
      <label class="ft-toggle" title="Apply session penalty (-5 score) outside 12-22 UTC peak hours">
        <input type="checkbox" id="ft-sessionFilter" checked> <span class="ft-badge ft-signal">SIGNAL</span> Session Filter (12-22 UTC)
      </label>

      <!-- Position Management -->
      <label class="ft-toggle" title="TP1 closes 40%, TP2 closes 30%, TP3 closes remaining 30%. OFF = close 100% at TP1">
        <input type="checkbox" id="ft-partialTP" checked> <span class="ft-badge ft-pos">TP</span> Partial Take Profits (40/30/30)
      </label>
      <label class="ft-toggle" title="Move stop to entry price when trade reaches 1R profit">
        <input type="checkbox" id="ft-breakeven" checked> <span class="ft-badge ft-pos">BE</span> Breakeven at 1R
      </label>
      <label class="ft-toggle" title="Trail stop 1R behind best price after 1.5R profit">
        <input type="checkbox" id="ft-trailingStop" checked> <span class="ft-badge ft-pos">TS</span> Trailing Stop (1.5R)
      </label>
      <label class="ft-toggle" title="Lock stop at 0.5R/0.75R/1R as trade progresses 50%/75%/90% toward TP2">
        <input type="checkbox" id="ft-lockIn" checked> <span class="ft-badge ft-pos">LOCK</span> Stepped Lock-In
      </label>

      <!-- Risk Management -->
      <label class="ft-toggle" title="Use bar close for SL check (matches live system). OFF = use candle wicks (conservative, more stops)">
        <input type="checkbox" id="ft-closeBasedStops" checked> <span class="ft-badge ft-fix">FIX</span> Close-Based Stops (realistic)
      </label>
      <label class="ft-toggle" title="Widen stops tighter than 1x ATR to prevent noise-level stop-outs">
        <input type="checkbox" id="ft-minSlDistance" checked> <span class="ft-badge ft-fix">FIX</span> Min SL Distance (1x ATR)
      </label>
      <label class="ft-toggle" title="Re-analyze signal while in trade. Exit on score collapse, reduce 50% on score drop">
        <input type="checkbox" id="ft-scoreRecheck" checked> <span class="ft-badge ft-risk">RISK</span> Score Re-check (Exit/Reduce)
      </label>
      <label class="ft-toggle" title="Cap stop loss distance to max 15% from entry">
        <input type="checkbox" id="ft-slCap" checked> <span class="ft-badge ft-risk">RISK</span> SL Distance Cap (15%)
      </label>
      <label class="ft-toggle" title="4-hour cooldown before same-direction re-entry on same coin">
        <input type="checkbox" id="ft-cooldown" checked> <span class="ft-badge ft-risk">RISK</span> 4h Cooldown
      </label>

      <!-- Quality Filters -->
      <label class="ft-toggle" title="Require at least one of: order block, FVG, or liquidity cluster">
        <input type="checkbox" id="ft-priceActionConfluence"> <span class="ft-badge ft-signal">QUALITY</span> Price-Action Confluence (OB/FVG/Liq)
      </label>
      <label class="ft-toggle" title="Skip entries when volatility is extreme">
        <input type="checkbox" id="ft-volatilityFilter"> <span class="ft-badge ft-risk">QUALITY</span> Volatility Filter (skip extreme)
      </label>
      <label class="ft-toggle" title="Require relative volume &gt; 1.0">
        <input type="checkbox" id="ft-volumeConfirmation"> <span class="ft-badge ft-signal">QUALITY</span> Volume Confirmation
      </label>

      <!-- Sizing & Costs -->
      <label class="ft-toggle" title="Higher score = slightly larger position (0.5 + score/100, cap 1.2x)">
        <input type="checkbox" id="ft-confidenceSizing" checked> <span class="ft-badge ft-cost">SIZE</span> Confidence Sizing
      </label>
      <label class="ft-toggle" title="0.1% taker fee on entry and exit">
        <input type="checkbox" id="ft-fees" checked> <span class="ft-badge ft-cost">COST</span> Trading Fees (0.1%)
      </label>
      <label class="ft-toggle" title="0.05% slippage simulation on entry and exit">
        <input type="checkbox" id="ft-slippage" checked> <span class="ft-badge ft-cost">COST</span> Slippage (0.05%)
      </label>

      <!-- DCA & Trailing TP -->
      <label class="ft-toggle" title="Trailing TP: no fixed TPs, trail stop from entry using ATR or fixed % distance">
        <input type="checkbox" id="ft-trailingTp" onchange="document.getElementById('bt-trailing-tp-opts').style.display=this.checked?'flex':'none'"> <span class="ft-badge ft-pos">TRAIL</span> Trailing Take-Profit
      </label>
      <label class="ft-toggle" title="DCA: add to losing positions when signal re-confirms (dip + score check)">
        <input type="checkbox" id="ft-dca" onchange="document.getElementById('bt-dca-opts').style.display=this.checked?'flex':'none'"> <span class="ft-badge ft-pos">DCA</span> Dollar Cost Average
      </label>
    </div>

    <!-- Trailing TP Options -->
    <div id="bt-trailing-tp-opts" style="display:none;flex-wrap:wrap;gap:8px;margin-top:8px;padding:10px;background:rgba(30,42,58,0.4);border:1px solid #334155;border-radius:6px;">
      <div>
        <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:3px;">Distance Mode</label>
        <select id="bt-trailingTpDistMode" onchange="document.getElementById('bt-trail-atr').style.display=this.value==='atr'?'block':'none';document.getElementById('bt-trail-fixed').style.display=this.value==='fixed'?'block':'none';" style="padding:5px 8px;background:#0d1320;border:1px solid #1e2a3a;border-radius:5px;color:#e5e7eb;font-size:12px;">
          <option value="atr">ATR-based</option>
          <option value="fixed">Fixed %</option>
        </select>
      </div>
      <div id="bt-trail-atr">
        <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:3px;">ATR Multiplier</label>
        <input type="number" id="bt-trailingTpAtrMult" value="1.5" min="0.5" max="5" step="0.1" style="width:70px;padding:5px 8px;background:#0d1320;border:1px solid #1e2a3a;border-radius:5px;color:#e5e7eb;font-size:12px;">
      </div>
      <div id="bt-trail-fixed" style="display:none;">
        <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:3px;">Fixed Trail %</label>
        <input type="number" id="bt-trailingTpFixedPct" value="2" min="0.5" max="10" step="0.1" style="width:70px;padding:5px 8px;background:#0d1320;border:1px solid #1e2a3a;border-radius:5px;color:#e5e7eb;font-size:12px;">
      </div>
    </div>

    <!-- DCA Options -->
    <div id="bt-dca-opts" style="display:none;flex-wrap:wrap;gap:8px;margin-top:8px;padding:10px;background:rgba(30,42,58,0.4);border:1px solid #334155;border-radius:6px;">
      <div>
        <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:3px;">Max Adds</label>
        <input type="number" id="bt-dcaMaxAdds" value="3" min="1" max="10" step="1" style="width:60px;padding:5px 8px;background:#0d1320;border:1px solid #1e2a3a;border-radius:5px;color:#e5e7eb;font-size:12px;">
      </div>
      <div>
        <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:3px;">Dip % per Level</label>
        <input type="number" id="bt-dcaDipPct" value="2" min="0.5" max="20" step="0.5" style="width:60px;padding:5px 8px;background:#0d1320;border:1px solid #1e2a3a;border-radius:5px;color:#e5e7eb;font-size:12px;">
      </div>
      <div>
        <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:3px;">Add Size %</label>
        <input type="number" id="bt-dcaAddSizePct" value="100" min="25" max="200" step="25" style="width:70px;padding:5px 8px;background:#0d1320;border:1px solid #1e2a3a;border-radius:5px;color:#e5e7eb;font-size:12px;">
      </div>
      <div>
        <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:3px;">Min Score</label>
        <input type="number" id="bt-dcaMinScore" value="52" min="30" max="95" step="1" style="width:60px;padding:5px 8px;background:#0d1320;border:1px solid #1e2a3a;border-radius:5px;color:#e5e7eb;font-size:12px;">
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
      <button type="button" class="btn btn-sm" onclick="setAllToggles(true)" style="padding:4px 12px;font-size:11px;background:#1e2a3a;border:1px solid #334155;color:#e5e7eb;border-radius:4px;cursor:pointer;">All ON</button>
      <button type="button" class="btn btn-sm" onclick="setAllToggles(false)" style="padding:4px 12px;font-size:11px;background:#1e2a3a;border:1px solid #334155;color:#e5e7eb;border-radius:4px;cursor:pointer;">All OFF</button>
      <button type="button" class="btn btn-sm" onclick="setPresetsMinimal()" style="padding:4px 12px;font-size:11px;background:#1e2a3a;border:1px solid #334155;color:#e5e7eb;border-radius:4px;cursor:pointer;">Minimal (raw signals only)</button>
      <button type="button" class="btn btn-sm" onclick="saveAsLivePreset()" style="padding:4px 12px;font-size:11px;background:#1e2a3a;border:1px solid #10b981;color:#10b981;border-radius:4px;cursor:pointer;" title="Save current toggle configuration for use on the Performance page">Save as Live Preset</button>
    </div>
  </div>
</div>

<!-- Loading -->
<div id="backtest-loading" class="section" style="display:none;text-align:center;padding:40px;">
  <div style="font-size:32px;margin-bottom:12px;animation:pulse 1.5s infinite;">&#x23F3;</div>
  <p style="color:#9ca3af;">Fetching historical candles and simulating trades...</p>
</div>

<!-- Results -->
<div id="backtest-results" style="display:none;">
  <!-- Diagnostic message when empty -->
  <div id="backtest-diagnostic" class="section" style="display:none;margin-bottom:24px;padding:16px;background:rgba(234,179,8,0.1);border:1px solid rgba(234,179,8,0.3);border-radius:8px;">
    <p id="backtest-diagnostic-msg" style="color:#eab308;margin:0;font-size:14px;"></p>
  </div>
  <!-- Summary -->
  <div class="section" style="margin-bottom:24px;">
    <h3 style="color:#e5e7eb;margin-bottom:12px;">Summary</h3>
    <div class="perf-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;">
      <div class="perf-card">
        <div class="perf-label">Total Trades</div>
        <div class="perf-value" id="bt-trades">0</div>
      </div>
      <div class="perf-card">
        <div class="perf-label">Win Rate</div>
        <div class="perf-value" id="bt-winrate">0%</div>
      </div>
      <div class="perf-card">
        <div class="perf-label">Total PnL</div>
        <div class="perf-value" id="bt-pnl">$0</div>
      </div>
      <div class="perf-card">
        <div class="perf-label">Return %</div>
        <div class="perf-value" id="bt-return">0%</div>
      </div>
      <div class="perf-card">
        <div class="perf-label">Profit Factor</div>
        <div class="perf-value" id="bt-pf">0</div>
      </div>
      <div class="perf-card">
        <div class="perf-label">Max Drawdown</div>
        <div class="perf-value down" id="bt-dd">0%</div>
      </div>
    </div>
  </div>

  <!-- Action Badges & Exit Reasons -->
  <div class="section" style="margin-bottom:24px;" id="bt-actions-section" style="display:none;">
    <h3 style="color:#e5e7eb;margin-bottom:12px;">Actions Taken & Exit Reasons</h3>
    <div style="display:flex;flex-wrap:wrap;gap:16px;">
      <div style="flex:1;min-width:200px;">
        <div style="color:#6b7280;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Action Badges</div>
        <div id="bt-action-badges" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
      </div>
      <div style="flex:1;min-width:200px;">
        <div style="color:#6b7280;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Exit Reasons</div>
        <div id="bt-exit-reasons" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
      </div>
    </div>
  </div>

  <!-- Per-coin results -->
  <div class="section" style="margin-bottom:24px;">
    <h3 style="color:#e5e7eb;margin-bottom:12px;">Per-Coin Results</h3>
    <div style="overflow-x:auto;">
      <table class="data-table" id="bt-coins-table">
        <thead>
          <tr>
            <th>Coin</th>
            <th>Trades</th>
            <th>Wins</th>
            <th>Losses</th>
            <th>Win Rate</th>
            <th>PnL</th>
            <th>Return %</th>
            <th>Max DD %</th>
          </tr>
        </thead>
        <tbody id="bt-coins-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Trade list -->
  <div class="section" style="margin-bottom:24px;">
    <h3 style="color:#e5e7eb;margin-bottom:12px;">Trade List</h3>
    <div style="overflow-x:auto;max-height:400px;overflow-y:auto;">
      <table class="data-table" id="bt-trades-table">
        <thead>
          <tr>
            <th>Coin</th>
            <th>Dir</th>
            <th>Entry</th>
            <th>Exit</th>
            <th>Reason</th>
            <th>Actions</th>
            <th>PnL</th>
          </tr>
        </thead>
        <tbody id="bt-trades-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Feature toggle helpers
function setAllToggles(val) {
  document.querySelectorAll('#feature-toggles input[type=checkbox]').forEach(function(cb) { cb.checked = val; });
  var trailOpts = document.getElementById('bt-trailing-tp-opts');
  var dcaOpts = document.getElementById('bt-dca-opts');
  if (trailOpts) trailOpts.style.display = val ? 'flex' : 'none';
  if (dcaOpts) dcaOpts.style.display = val ? 'flex' : 'none';
}
function setPresetsMinimal() {
  setAllToggles(false);
  // Keep realism fixes ON even in minimal mode
  document.getElementById('ft-slippage').checked = true;
  document.getElementById('ft-closeBasedStops').checked = true;
  document.getElementById('ft-minSlDistance').checked = true;
}
function getFeatureFlags() {
  var flags = {
    btcFilter: document.getElementById('ft-btcFilter').checked,
    btcCorrelation: document.getElementById('ft-btcCorrelation').checked,
    sessionFilter: document.getElementById('ft-sessionFilter').checked,
    partialTP: document.getElementById('ft-partialTP').checked,
    breakeven: document.getElementById('ft-breakeven').checked,
    trailingStop: document.getElementById('ft-trailingStop').checked,
    lockIn: document.getElementById('ft-lockIn').checked,
    scoreRecheck: document.getElementById('ft-scoreRecheck').checked,
    slCap: document.getElementById('ft-slCap').checked,
    cooldown: document.getElementById('ft-cooldown').checked,
    confidenceSizing: document.getElementById('ft-confidenceSizing').checked,
    priceActionConfluence: document.getElementById('ft-priceActionConfluence').checked,
    volatilityFilter: document.getElementById('ft-volatilityFilter').checked,
    volumeConfirmation: document.getElementById('ft-volumeConfirmation').checked,
    fees: document.getElementById('ft-fees').checked,
    slippage: document.getElementById('ft-slippage').checked,
    closeBasedStops: document.getElementById('ft-closeBasedStops').checked,
    minSlDistance: document.getElementById('ft-minSlDistance').checked,
    trailingTp: document.getElementById('ft-trailingTp').checked,
    dca: document.getElementById('ft-dca').checked
  };
  if (flags.trailingTp) {
    flags.trailingTpDistanceMode = document.getElementById('bt-trailingTpDistMode').value;
    flags.trailingTpAtrMultiplier = parseFloat(document.getElementById('bt-trailingTpAtrMult').value) || 1.5;
    flags.trailingTpFixedPercent = parseFloat(document.getElementById('bt-trailingTpFixedPct').value) || 2;
  }
  if (flags.dca) {
    flags.dcaMaxAdds = parseInt(document.getElementById('bt-dcaMaxAdds').value, 10) || 3;
    flags.dcaDipPercent = parseFloat(document.getElementById('bt-dcaDipPct').value) || 2;
    flags.dcaAddSizePercent = parseFloat(document.getElementById('bt-dcaAddSizePct').value) || 100;
    flags.dcaMinScore = parseInt(document.getElementById('bt-dcaMinScore').value, 10) || 52;
  }
  return flags;
}

// Save current toggle config to localStorage for transfer to Performance page
function saveAsLivePreset() {
  var flags = getFeatureFlags();
  localStorage.setItem('backtestFeaturePreset', JSON.stringify(flags));
  alert('Toggle preset saved! Go to Performance page and click "Load from Backtest" to apply.');
}

// Badge rendering
var ACTION_BADGE_MAP = {
  BE: { label: 'BE', color: '#3b82f6', desc: 'Breakeven' },
  TS: { label: 'TS', color: '#8b5cf6', desc: 'Trailing Stop' },
  PP: { label: 'PP', color: '#10b981', desc: 'Partial Profit' },
  RP: { label: 'RP', color: '#f59e0b', desc: 'Reduce Position' },
  DCA: { label: 'DCA', color: '#06b6d4', desc: 'Dollar Cost Average' },
  EXIT: { label: 'EXIT', color: '#ef4444', desc: 'Score Exit' },
  LOCK: { label: 'LOCK', color: '#06b6d4', desc: 'Profit Lock-In' }
};
var EXIT_REASON_MAP = {
  SL: { label: 'SL', color: '#ef4444' },
  TRAILING_TP_EXIT: { label: 'Trail Exit', color: '#8b5cf6' },
  TP1: { label: 'TP1', color: '#10b981' },
  TP2: { label: 'TP2', color: '#10b981' },
  TP3: { label: 'TP3', color: '#10b981' },
  SCORE_EXIT: { label: 'Score Exit', color: '#f59e0b' },
  END: { label: 'End', color: '#6b7280' }
};
function renderBadge(type, count, map) {
  var info = map[type] || { label: type, color: '#6b7280' };
  return '<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:600;background:' + info.color + '22;color:' + info.color + ';border:1px solid ' + info.color + '44;">' +
    info.label + ' <span style="font-weight:400;opacity:0.8;">' + count + '</span></span>';
}
function renderActionBadgesForTrade(actions) {
  if (!actions || actions.length === 0) return '<span style="color:#374151;font-size:11px;">-</span>';
  var types = {};
  actions.forEach(function(a) { types[a.type] = (types[a.type] || 0) + 1; });
  return Object.keys(types).map(function(t) {
    var info = ACTION_BADGE_MAP[t] || { label: t, color: '#6b7280' };
    return '<span style="padding:1px 5px;border-radius:3px;font-size:10px;font-weight:600;background:' + info.color + '22;color:' + info.color + ';">' + info.label + '</span>';
  }).join(' ');
}

(function() {
  var form = document.getElementById('backtest-form');
  var loading = document.getElementById('backtest-loading');
  var results = document.getElementById('backtest-results');
  var runBtn = document.getElementById('run-btn');

  // Default dates: last 30 days
  var end = new Date();
  var start = new Date();
  start.setDate(start.getDate() - 30);
  document.getElementById('endDate').value = end.toISOString().slice(0, 10);
  document.getElementById('startDate').value = start.toISOString().slice(0, 10);

  // Risk mode toggle: show % or $ input
  document.getElementById('riskMode').addEventListener('change', function() {
    var isDollar = this.value === 'dollar';
    document.getElementById('bt-risk-pct-wrap').style.display = isDollar ? 'none' : '';
    document.getElementById('bt-risk-dollar-wrap').style.display = isDollar ? '' : 'none';
  });

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    runBtn.disabled = true;
    loading.style.display = 'block';
    results.style.display = 'none';

    var coinId = document.getElementById('coinId').value;
    var riskMode = document.getElementById('riskMode').value;
    var body = {
      startDate: document.getElementById('startDate').value,
      endDate: document.getElementById('endDate').value,
      minScore: parseInt(document.getElementById('minScore').value, 10) || 52,
      leverage: parseInt(document.getElementById('leverage').value, 10) || 2,
      initialBalance: parseInt(document.getElementById('initialBalance').value, 10) || 10000,
      riskMode: riskMode,
      riskPerTrade: parseFloat(document.getElementById('riskPerTrade').value) || 2,
      riskDollarsPerTrade: parseInt(document.getElementById('riskDollarsPerTrade').value, 10) || 200,
      features: getFeatureFlags()
    };
    if (coinId) body.coinId = coinId;

    try {
      var controller = new AbortController();
      var timeoutId = setTimeout(function() { controller.abort(); }, 120000);
      var res = await fetch('/api/backtest', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
        signal: controller.signal
      });
      clearTimeout(timeoutId);
      var data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Backtest failed');

      loading.style.display = 'none';
      results.style.display = 'block';

      var diag = document.getElementById('backtest-diagnostic');
      var diagMsg = document.getElementById('backtest-diagnostic-msg');
      diag.style.display = 'none';
      var s = data.summary || {};
      var successResults = (data.results || []).filter(function(r) { return !r.error; });
      if ((s.coinsFailed || 0) > 0 && successResults.length === 0) {
        diag.style.display = 'block';
        var failDetails = (data.failed || []).map(function(f) { return f.coinId + ': ' + f.error; }).join(', ');
        diagMsg.textContent = 'Could not fetch candles for any coin (' + (s.coinsFailed || 0) + ' failed). Errors: ' + (failDetails || 'unknown') + '. Try a single coin and shorter date range.';
      } else if ((s.coinsFailed || 0) > 0) {
        diag.style.display = 'block';
        var partialFails = (data.failed || []).map(function(f) { return f.coinId + ': ' + f.error; }).join(', ');
        diagMsg.textContent = 'Some coins failed (' + s.coinsFailed + '): ' + partialFails;
        diagMsg.style.color = '#f59e0b';
      } else if (successResults.length > 0 && s.totalTrades === 0) {
        diag.style.display = 'block';
        diagMsg.textContent = 'No trades met the criteria across ' + (s.coinsProcessed || successResults.length) + ' coins (' + (s.totalBars || 0) + ' bars). Try lowering Min Score to 48 or a different date range.';
      }

      document.getElementById('bt-trades').textContent = s.totalTrades || 0;
      document.getElementById('bt-winrate').textContent = (s.winRate || 0).toFixed(1) + '%';
      var pnl = s.totalPnl || 0;
      var pnlEl = document.getElementById('bt-pnl');
      pnlEl.textContent = (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2);
      pnlEl.className = 'perf-value ' + (pnl >= 0 ? 'up' : 'down');
      var ret = s.returnPct || 0;
      var retEl = document.getElementById('bt-return');
      retEl.textContent = (ret >= 0 ? '+' : '') + ret.toFixed(2) + '%';
      retEl.className = 'perf-value ' + (ret >= 0 ? 'up' : 'down');
      document.getElementById('bt-pf').textContent = (s.profitFactor || 0).toFixed(2);
      var maxDd = 0;
      successResults.forEach(function(r) { if (r.maxDrawdownPct > maxDd) maxDd = r.maxDrawdownPct; });
      document.getElementById('bt-dd').textContent = maxDd.toFixed(1) + '%';

      // Action badges & exit reasons (aggregate across all coins)
      var totalActions = {};
      var totalExitReasons = {};
      successResults.forEach(function(r) {
        if (r.actionCounts) {
          Object.keys(r.actionCounts).forEach(function(k) { totalActions[k] = (totalActions[k] || 0) + r.actionCounts[k]; });
        }
        if (r.exitReasons) {
          Object.keys(r.exitReasons).forEach(function(k) { totalExitReasons[k] = (totalExitReasons[k] || 0) + r.exitReasons[k]; });
        }
      });
      var badgesEl = document.getElementById('bt-action-badges');
      var exitsEl = document.getElementById('bt-exit-reasons');
      var actionsSection = document.getElementById('bt-actions-section');
      var hasActions = Object.values(totalActions).some(function(v) { return v > 0; });
      var hasExits = Object.keys(totalExitReasons).length > 0;
      actionsSection.style.display = (hasActions || hasExits) ? 'block' : 'none';
      badgesEl.innerHTML = Object.keys(totalActions).filter(function(k) { return totalActions[k] > 0; })
        .map(function(k) { return renderBadge(k, totalActions[k], ACTION_BADGE_MAP); }).join('') || '<span style="color:#374151;font-size:12px;">None</span>';
      exitsEl.innerHTML = Object.keys(totalExitReasons)
        .map(function(k) { return renderBadge(k, totalExitReasons[k], EXIT_REASON_MAP); }).join('') || '<span style="color:#374151;font-size:12px;">None</span>';

      // Per-coin table (only successful runs)
      var tbody = document.getElementById('bt-coins-body');
      tbody.innerHTML = '';
      successResults.forEach(function(r) {
        var tr = document.createElement('tr');
        var wr = r.winRate || 0;
        var pnl = r.totalPnl || 0;
        var ret = r.returnPct || 0;
        tr.innerHTML = '<td><strong>' + (r.symbol || r.coinId) + '</strong></td>' +
          '<td>' + (r.totalTrades || 0) + '</td>' +
          '<td class="up">' + (r.wins || 0) + '</td>' +
          '<td class="down">' + (r.losses || 0) + '</td>' +
          '<td style="color:' + (wr >= 50 ? '#10b981' : '#ef4444') + '">' + wr.toFixed(1) + '%</td>' +
          '<td class="' + (pnl >= 0 ? 'up' : 'down') + '">' + (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2) + '</td>' +
          '<td class="' + (ret >= 0 ? 'up' : 'down') + '">' + (ret >= 0 ? '+' : '') + ret.toFixed(2) + '%</td>' +
          '<td class="down">' + (r.maxDrawdownPct || 0).toFixed(1) + '%</td>';
        tbody.appendChild(tr);
      });

      // Trade list (aggregate from successful results)
      var allTrades = [];
      successResults.forEach(function(r) {
        (r.trades || []).forEach(function(t) {
          allTrades.push({ coinId: r.coinId, symbol: r.symbol, direction: t.direction, entry: t.entry, exit: t.exit, reason: t.reason, pnl: t.pnl, actions: t.actions || [] });
        });
      });
      var tradesBody = document.getElementById('bt-trades-body');
      tradesBody.innerHTML = '';
      allTrades.slice(0, 100).forEach(function(t) {
        var tr = document.createElement('tr');
        tr.innerHTML = '<td>' + (t.symbol || t.coinId) + '</td>' +
          '<td><span class="badge-' + (t.direction === 'LONG' ? 'BUY' : 'SELL') + '" style="padding:2px 6px;border-radius:4px;font-size:11px;">' + t.direction + '</span></td>' +
          '<td>$' + Number(t.entry || 0).toFixed(4) + '</td>' +
          '<td>$' + Number(t.exit || 0).toFixed(4) + '</td>' +
          '<td>' + (t.reason || '-') + '</td>' +
          '<td>' + renderActionBadgesForTrade(t.actions) + '</td>' +
          '<td class="' + ((t.pnl || 0) >= 0 ? 'up' : 'down') + '">' + ((t.pnl || 0) >= 0 ? '+' : '') + '$' + (t.pnl || 0).toFixed(2) + '</td>';
        tradesBody.appendChild(tr);
      });
      if (allTrades.length > 100) {
        var more = document.createElement('tr');
        more.innerHTML = '<td colspan="7" style="color:#6b7280;font-size:12px;">Showing first 100 of ' + allTrades.length + ' trades</td>';
        tradesBody.appendChild(more);
      }
    } catch (err) {
      loading.style.display = 'none';
      alert(err.message || 'Backtest failed');
    }
    runBtn.disabled = false;
  });
})();
</script>
<style>
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
.perf-card { background: rgba(15,23,42,0.6); border: 1px solid #1e2a3a; border-radius: 8px; padding: 12px 16px; }
.perf-label { font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; }
.perf-value { font-size: 18px; font-weight: 700; color: #e5e7eb; margin-top: 4px; }
/* Feature toggle styles */
.ft-toggle {
  display: flex; align-items: center; gap: 8px; padding: 6px 10px;
  background: rgba(15,23,42,0.5); border: 1px solid #1e2a3a; border-radius: 6px;
  color: #e5e7eb; font-size: 12px; cursor: pointer; transition: border-color 0.2s;
}
.ft-toggle:hover { border-color: #334155; }
.ft-toggle input[type=checkbox] { accent-color: #3b82f6; width: 14px; height: 14px; cursor: pointer; }
.ft-badge { padding: 1px 5px; border-radius: 3px; font-size: 9px; font-weight: 700; letter-spacing: 0.5px; }
.ft-signal { background: #3b82f622; color: #3b82f6; }
.ft-pos { background: #10b98122; color: #10b981; }
.ft-risk { background: #f59e0b22; color: #f59e0b; }
.ft-cost { background: #8b5cf622; color: #8b5cf6; }
.ft-fix { background: #ef444422; color: #ef4444; }
</style>
