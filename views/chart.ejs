<%- include('partials/header') %>

<main class="chart-page">
  <div class="chart-header">
    <h1><%= coinName %> (<%= symbol %>) â€“ Chart</h1>
    <a href="/coin/<%= coinId %>" class="btn btn-outline btn-sm">Back to <%= coinName %></a>
  </div>

  <% if (entry != null || sl != null || tp1 != null || tp2 != null || tp3 != null) { %>
  <div class="trade-levels-bar">
    <span class="levels-title">Trade levels<%= tradeDirection ? ' (' + tradeDirection + ')' : '' %>:</span>
    <% if (entry != null) { %><span class="level-badge entry">Entry $<%= entry.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) %></span><% } %>
    <% if (sl != null) { %>
      <span class="level-badge sl">
        SL $<%= sl.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) %>
        <% if (originalSl != null && originalSl !== sl) { %>
          <span style="font-size:0.7rem;opacity:0.7;text-decoration:line-through;margin-left:4px;">$<%= originalSl.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) %></span>
        <% } %>
      </span>
    <% } %>
    <% if (tp1 != null) { %><span class="level-badge tp">TP1 $<%= tp1.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) %></span><% } %>
    <% if (tp2 != null) { %><span class="level-badge tp">TP2 $<%= tp2.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) %></span><% } %>
    <% if (tp3 != null) { %><span class="level-badge tp">TP3 $<%= tp3.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) %></span><% } %>
  </div>
  <% } %>

  <% if (typeof tradeActions !== 'undefined' && tradeActions && tradeActions.length > 0) { %>
  <div class="chart-actions-bar">
    <span class="actions-title">Actions:</span>
    <% tradeActions.forEach(function(action) { %>
      <span class="action-badge <%= action.type === 'BREAKEVEN' ? 'breakeven' : 'trailing' %>">
        <strong><%= action.type === 'BREAKEVEN' ? 'BE' : 'TS' %></strong>
        <%= action.description %>
      </span>
    <% }); %>
  </div>
  <% } %>

  <div class="chart-container">
    <iframe
      src="https://www.tradingview.com/chart/?symbol=<%= encodeURIComponent(tvSymbol) %>"
      class="chart-iframe"
      title="<%= coinName %> chart"
    ></iframe>
  </div>
</main>

<style>
.chart-page { padding: 1rem; max-width: 100%; box-sizing: border-box; }
.chart-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; }
.chart-header h1 { margin: 0; font-size: 1.25rem; color: #e5e7eb; }
.trade-levels-bar { display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem 0.75rem; background: rgba(30,41,59,0.6); border-radius: 8px; }
.levels-title { color: #94a3b8; font-size: 0.875rem; margin-right: 0.5rem; }
.level-badge { font-size: 0.8rem; padding: 0.25rem 0.5rem; border-radius: 4px; }
.level-badge.entry { background: rgba(59, 130, 246, 0.3); color: #93c5fd; }
.level-badge.sl { background: rgba(239, 68, 68, 0.3); color: #fca5a5; }
.level-badge.tp { background: rgba(34, 197, 94, 0.3); color: #86efac; }
.chart-actions-bar { display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; padding: 0.5rem 0.75rem; background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.2); border-radius: 8px; }
.actions-title { color: #93c5fd; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-right: 0.25rem; }
.action-badge { font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 4px; color: #d1d5db; }
.action-badge.breakeven { background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); }
.action-badge.trailing { background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); }
.action-badge strong { margin-right: 4px; }
.chart-container { position: relative; width: 100%; height: calc(100vh - 140px); min-height: 400px; border-radius: 8px; overflow: hidden; background: #0f172a; }
.chart-iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
</style>

<%- include('partials/footer') %>
