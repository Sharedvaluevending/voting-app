<%- include('partials/header') %>

<main class="chart-page">
  <div class="chart-header">
    <h1><%= coinName %> (<%= symbol %>) – Chart</h1>
    <a href="/trades" class="btn btn-outline btn-sm">Active Trades</a>
    <a href="/coin/<%= coinId %>" class="btn btn-outline btn-sm">Back to <%= coinName %></a>
  </div>

  <% if (entry != null || sl != null || tp1 != null || tp2 != null || tp3 != null) { %>
  <div class="trade-levels-overlay">
    <div class="trade-levels-title">Trade Levels – use these on the chart</div>
    <div class="trade-levels-grid">
      <% if (tp3 != null) { %><div class="level-row tp"><span class="level-name">TP3</span><span class="level-price">$<%= tp3.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) %></span></div><% } %>
      <% if (tp2 != null) { %><div class="level-row tp"><span class="level-name">TP2</span><span class="level-price">$<%= tp2.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) %></span></div><% } %>
      <% if (tp1 != null) { %><div class="level-row tp"><span class="level-name">TP1</span><span class="level-price">$<%= tp1.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) %></span></div><% } %>
      <% if (entry != null) { %><div class="level-row entry"><span class="level-name">Entry</span><span class="level-price">$<%= entry.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) %></span></div><% } %>
      <% if (sl != null) { %><div class="level-row sl"><span class="level-name">SL</span><span class="level-price">$<%= sl.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) %></span></div><% } %>
    </div>
  </div>
  <% } %>

  <div class="chart-container" id="tv-chart-container">
    <div class="tradingview-widget-container" style="width:100%;height:100%;">
      <div id="tradingview_widget" style="width:100%;height:100%;"></div>
    </div>
  </div>
</main>

<style>
.chart-page { padding: 1rem; max-width: 100%; box-sizing: border-box; }
.chart-header { display: flex; align-items: center; justify-content: flex-start; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; }
.chart-header h1 { margin: 0; font-size: 1.25rem; color: #e5e7eb; }
.trade-levels-overlay { margin-bottom: 1rem; padding: 0.75rem 1rem; background: rgba(15,23,42,0.95); border: 1px solid #334155; border-radius: 8px; }
.trade-levels-title { font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; }
.trade-levels-grid { display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; }
.level-row { font-size: 0.9rem; padding: 0.2rem 0.5rem; border-radius: 4px; }
.level-row.entry { background: rgba(59, 130, 246, 0.25); color: #93c5fd; }
.level-row.sl { background: rgba(239, 68, 68, 0.25); color: #fca5a5; }
.level-row.tp { background: rgba(34, 197, 94, 0.25); color: #86efac; }
.chart-container { position: relative; width: 100%; height: calc(100vh - 200px); min-height: 400px; border-radius: 8px; overflow: hidden; background: #0f172a; }
</style>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script type="text/javascript">
new TradingView.widget({
  "container_id": "tradingview_widget",
  "autosize": true,
  "symbol": "<%= tvSymbol %>",
  "interval": "60",
  "timezone": "Etc/UTC",
  "theme": "dark",
  "style": "1",
  "locale": "en",
  "toolbar_bg": "#0f172a",
  "enable_publishing": false,
  "hide_side_toolbar": false,
  "allow_symbol_change": true,
  "save_image": false,
  "show_popup_button": true,
  "popup_width": "1000",
  "popup_height": "650"
});
</script>

<%- include('partials/footer') %>
