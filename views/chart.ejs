<%- include('partials/header') %>

<main class="chart-page">
  <div class="chart-header">
    <h1><%= coinName %> (<%= symbol %>) – Chart</h1>
    <a href="/trades" class="btn btn-outline btn-sm">Active Trades</a>
    <a href="/coin/<%= coinId %>" class="btn btn-outline btn-sm">Back to <%= coinName %></a>
  </div>

  <% if (entry != null || sl != null || tp1 != null || tp2 != null || tp3 != null) { %>
  <div class="trade-levels-overlay">
    <div class="trade-levels-title">Trade Levels – drawn on chart</div>
    <div class="trade-levels-grid">
      <% if (tp3 != null) { %><div class="level-row tp"><span class="level-name">TP3</span><span class="level-price">$<%= tp3.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) %></span></div><% } %>
      <% if (tp2 != null) { %><div class="level-row tp"><span class="level-name">TP2</span><span class="level-price">$<%= tp2.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) %></span></div><% } %>
      <% if (tp1 != null) { %><div class="level-row tp"><span class="level-name">TP1</span><span class="level-price">$<%= tp1.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) %></span></div><% } %>
      <% if (entry != null) { %><div class="level-row entry"><span class="level-name">Entry</span><span class="level-price">$<%= entry.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) %></span></div><% } %>
      <% if (sl != null) { %><div class="level-row sl"><span class="level-name">SL</span><span class="level-price">$<%= sl.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) %></span></div><% } %>
    </div>
  </div>
  <% } %>

  <div class="chart-container" id="chart-container">
    <div id="chart"></div>
  </div>
</main>

<style>
.chart-page { padding: 1rem; max-width: 100%; box-sizing: border-box; }
.chart-header { display: flex; align-items: center; justify-content: flex-start; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; }
.chart-header h1 { margin: 0; font-size: 1.25rem; color: #e5e7eb; }
.trade-levels-overlay { margin-bottom: 1rem; padding: 0.75rem 1rem; background: rgba(15,23,42,0.95); border: 1px solid #334155; border-radius: 8px; }
.trade-levels-title { font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; }
.trade-levels-grid { display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; }
.level-row { font-size: 0.9rem; padding: 0.2rem 0.5rem; border-radius: 4px; }
.level-row.entry { background: rgba(59, 130, 246, 0.25); color: #93c5fd; }
.level-row.sl { background: rgba(239, 68, 68, 0.25); color: #fca5a5; }
.level-row.tp { background: rgba(34, 197, 94, 0.25); color: #86efac; }
.chart-container { position: relative; width: 100%; height: calc(100vh - 200px); min-height: 400px; border-radius: 8px; overflow: hidden; background: #0f172a; }
#chart { width: 100%; height: 100%; }
</style>

<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
<script>
(function() {
  var coinId = '<%= coinId %>';
  var coinName = '<%= coinName %>';
  var levels = {
    entry: <%- JSON.stringify(entry) %>,
    sl: <%- JSON.stringify(sl) %>,
    tp1: <%- JSON.stringify(tp1) %>,
    tp2: <%- JSON.stringify(tp2) %>,
    tp3: <%- JSON.stringify(tp3) %>
  };

  var container = document.getElementById('chart');
  if (!container) return;

  var chart = LightweightCharts.createChart(container, {
    layout: {
      background: { type: 'solid', color: '#0f172a' },
      textColor: '#9ca3af'
    },
    grid: { vertLines: { color: '#1e293b' }, horzLines: { color: '#1e293b' } },
    width: container.clientWidth,
    height: container.clientHeight,
    timeScale: {
      timeVisible: true,
      secondsVisible: false,
      borderColor: '#334155'
    },
    rightPriceScale: {
      borderColor: '#334155',
      scaleMargins: { top: 0.1, bottom: 0.2 }
    }
  });

  chart.applyOptions({ autoSize: true });

  fetch('/api/candles/' + coinId + '?interval=1h')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (!data.success || !data.candles || data.candles.length === 0) return;

      var series = chart.addCandlestickSeries({
        upColor: '#22c55e',
        downColor: '#ef4444',
        borderDownColor: '#ef4444',
        borderUpColor: '#22c55e',
        wickDownColor: '#ef4444',
        wickUpColor: '#22c55e'
      });

      series.setData(data.candles);

      // Add price lines for trade levels
      var lineOptions = {
        lineWidth: 2,
        lineStyle: LightweightCharts.LineStyle.Dashed,
        axisLabelVisible: true,
        title: ''
      };

      if (levels.sl != null) {
        series.createPriceLine(Object.assign({}, lineOptions, {
          price: levels.sl,
          color: '#ef4444',
          title: 'SL'
        }));
      }
      if (levels.entry != null) {
        series.createPriceLine(Object.assign({}, lineOptions, {
          price: levels.entry,
          color: '#3b82f6',
          title: 'Entry'
        }));
      }
      if (levels.tp1 != null) {
        series.createPriceLine(Object.assign({}, lineOptions, {
          price: levels.tp1,
          color: '#22c55e',
          title: 'TP1'
        }));
      }
      if (levels.tp2 != null) {
        series.createPriceLine(Object.assign({}, lineOptions, {
          price: levels.tp2,
          color: '#22c55e',
          title: 'TP2'
        }));
      }
      if (levels.tp3 != null) {
        series.createPriceLine(Object.assign({}, lineOptions, {
          price: levels.tp3,
          color: '#22c55e',
          title: 'TP3'
        }));
      }

      chart.timeScale().fitContent();
    })
    .catch(function(err) { console.error('Chart load error:', err); });
})();
</script>

<%- include('partials/footer') %>
