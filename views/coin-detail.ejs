<%- include('partials/header') %>
<%
  var displaySignal = sig.signal;
  if (sig.signal === 'HOLD' && (sig.score || 0) >= 52 && sig.topStrategies && sig.topStrategies.length > 0) {
    var bestStrat = sig.topStrategies.find(function(s) {
      return (s.signal === 'BUY' || s.signal === 'STRONG_BUY' || s.signal === 'SELL' || s.signal === 'STRONG_SELL') && (s.score || 0) >= 55;
    });
    if (bestStrat) displaySignal = bestStrat.signal;
  }
%>
<div style="margin-bottom:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
  <a href="/" style="color:#3b82f6;text-decoration:none;font-size:13px;">&larr; Back to Dashboard</a>
  <a href="/chart/<%= sig.coin.id %>" class="btn btn-outline btn-sm" style="font-size:12px;" target="_blank" rel="noopener">View chart</a>
  <a href="/strategy-comparison" class="btn btn-outline btn-sm" style="font-size:12px;">Compare strategies</a>
</div>

<div style="display:flex;justify-content:space-between;align-items:flex-start;margin:16px 0;flex-wrap:wrap;gap:12px;">
  <div>
    <h1 style="font-size:28px;color:#fff;"><%= sig.coin.name %></h1>
    <span style="color:#6b7280;font-size:14px;"><%= sig.coin.symbol %> | Market Cap: $<%= formatBigNumber(sig.coin.marketCap) %></span>
  </div>
  <div style="text-align:right;" data-coin-id="<%= sig.coin.id %>" class="coin-detail-price-block">
    <div class="coin-detail-price" style="font-size:32px;font-weight:700;color:#fff;">$<%= formatPrice(sig.coin.price) %></div>
    <div class="coin-detail-change <%= sig.coin.change24h >= 0 ? 'up' : 'down' %>" style="font-size:16px;font-weight:600;">
      <%= sig.coin.change24h >= 0 ? '+' : '' %><%= sig.coin.change24h.toFixed(2) %>% (24h)
    </div>
  </div>
</div>

<div style="display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin-bottom:16px;">
  <span class="signal-badge badge-<%= displaySignal %>" style="font-size:18px;padding:12px 24px;"><%= displaySignal.replace('_', ' ') %></span>
  <span class="score-tier-badge tier-<%= (sig.score||0) >= 75 ? 'high' : (sig.score||0) >= 55 ? 'moderate' : 'caution' %>" style="font-size:13px;padding:6px 14px;"><%= (sig.score||0) >= 75 ? 'High conviction' : (sig.score||0) >= 55 ? 'Moderate' : 'Caution' %></span>
  <span class="confluence-badge" style="font-size:13px;padding:6px 14px;" title="Timeframes agreeing on direction"><%= sig.confluenceLevel || 0 %>/3 TF</span>
  <span class="rr-badge" style="font-size:13px;padding:6px 14px;"><%= sig.riskReward || 0 %>x R:R</span>
  <% if (sig.strategyName) { %><span class="strategy-badge" style="font-size:13px;padding:6px 14px;"><%= sig.strategyName %></span><% } %>
  <% if (sig.regime && sig.regime !== 'unknown') { %>
    <span class="regime-badge regime-<%= sig.regime %>" style="font-size:13px;padding:6px 14px;"><%= sig.regime %></span>
  <% } %>
  <% if (sig.suggestedLeverage > 1) { %>
    <span class="lev-badge" style="font-size:13px;padding:6px 14px;">Suggested: <%= sig.suggestedLeverage %>x Leverage</span>
  <% } %>
</div>

<div class="score-bar" style="margin:16px 0;">
  <div class="score-bar-outer" style="height:10px;">
    <div class="score-bar-inner" style="width:<%= Math.min(100, sig.score || 0) %>%;background:<%= (sig.score||0) >= 75 ? '#10b981' : (sig.score||0) >= 55 ? '#3b82f6' : (sig.score||0) >= 40 ? '#eab308' : '#ef4444' %>;height:100%;"></div>
  </div>
  <div class="score-label" style="font-size:14px;">
    <span>Score: <strong><%= sig.score || 0 %>/100</strong></span>
    <span>Strategy: <strong><%= sig.strategyName || 'N/A' %></strong></span>
  </div>
</div>

<% if (sig.topStrategies && sig.topStrategies.length > 0) { %>
<div class="section">
  <h3>All strategy scores</h3>
  <p style="font-size:13px;color:#9ca3af;margin-bottom:12px;">Scores for all strategies (scalping = tighter ATR stops, position = wider). Stop/TP style: <strong><%= sig.stopLabel || 'ATR + S/R' %></strong>, TP: <strong><%= sig.tpLabel || 'R multiples' %></strong>. You can open a trade using any strategy that scores ≥55.</p>
  <div style="display:flex;flex-wrap:wrap;gap:10px;">
    <% sig.topStrategies.forEach(function(ts) { %>
      <div style="padding:12px 14px;background:#0d1320;border-radius:8px;font-size:14px;min-width:200px;<%= ts.id === sig.strategyType ? 'border:1px solid #3b82f6;' : '' %>">
        <div style="margin-bottom:6px;">
          <span style="color:#9ca3af;"><%= ts.name %></span>
          <% if (ts.id === sig.strategyType) { %><span style="margin-left:6px;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700;background:#3b82f6;color:#fff;">Best</span><% } %>
          <span class="badge-<%= ts.signal %>" style="margin-left:8px;padding:4px 8px;border-radius:4px;font-size:12px;"><%= ts.signal %></span>
          <span style="color:#6b7280;margin-left:6px;">(<%= ts.score %>)</span>
        </div>
        <% if (ts.stopLoss != null && ts.entry != null) { %>
        <div style="font-size:11px;color:#6b7280;margin-bottom:8px;">SL $<%= formatPrice(ts.stopLoss) %> · TP1 $<%= formatPrice(ts.takeProfit1) %></div>
        <% } %>
        <% var stratCanLong = (ts.signal === 'BUY' || ts.signal === 'STRONG_BUY') && (ts.score || 0) >= 55; %>
        <% var stratCanShort = (ts.signal === 'SELL' || ts.signal === 'STRONG_SELL') && (ts.score || 0) >= 55; %>
        <% if (typeof user !== 'undefined' && user && (stratCanLong || stratCanShort)) { %>
        <form action="/trades/open" method="POST" style="margin:0;">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="coinId" value="<%= sig.coin.id %>">
          <input type="hidden" name="direction" value="<%= stratCanLong ? 'LONG' : 'SHORT' %>">
          <input type="hidden" name="score" value="<%= ts.score %>">
          <input type="hidden" name="strategyType" value="<%= ts.id %>">
          <button type="submit" class="btn <%= stratCanLong ? 'btn-buy' : 'btn-sell' %>" style="font-size:12px;padding:6px 12px;">Open <%= stratCanLong ? 'Long' : 'Short' %> (<%= ts.name %>)</button>
        </form>
        <% } %>
      </div>
    <% }); %>
  </div>
</div>
<% } %>

<% if (sig.timeframes) { %>
<div class="section">
  <h3>Timeframe Analysis</h3>
  <div class="tf-row" style="gap:8px;">
    <% ['15m','1H','4H','1D','1W'].forEach(function(tf) { var t = sig.timeframes[tf]; if(t) { %>
      <div class="tf-chip <%= t.direction === 'BULL' ? 'tf-bull' : t.direction === 'BEAR' ? 'tf-bear' : 'tf-neutral' %>" style="padding:6px 12px;font-size:12px;">
        <span class="tf-label"><%= tf %></span> <%= t.signal %> (<%= t.score %>)
        <% if (t.rsi && t.rsi !== '-' && t.rsi !== 0) { %>
          <span class="tf-rsi" style="margin-left:4px;">RSI <%= t.rsi %></span>
        <% } %>
        <% if (t.adx && t.adx !== '-' && t.adx !== 0) { %>
          <span style="color:#6b7280;font-size:10px;margin-left:4px;">ADX <%= t.adx %></span>
        <% } %>
      </div>
    <% }}); %>
  </div>
</div>
<% } %>

<% if (sig.scoreBreakdown) { %>
<div class="section">
  <h3>Score Breakdown</h3>
  <div class="perf-grid">
    <div class="perf-card" title="EMA/SMA alignment, ADX strength, price vs moving averages"><div class="perf-label">Trend</div><div class="perf-value"><%= sig.scoreBreakdown.trend %>/20</div></div>
    <div class="perf-card"><div class="perf-label">Momentum</div><div class="perf-value"><%= sig.scoreBreakdown.momentum %>/20</div></div>
    <div class="perf-card"><div class="perf-label">Volume</div><div class="perf-value"><%= sig.scoreBreakdown.volume %>/20</div></div>
    <div class="perf-card"><div class="perf-label">Structure</div><div class="perf-value"><%= sig.scoreBreakdown.structure %>/20</div></div>
    <div class="perf-card"><div class="perf-label">Volatility</div><div class="perf-value"><%= sig.scoreBreakdown.volatility %>/10</div></div>
    <div class="perf-card"><div class="perf-label">Risk Quality</div><div class="perf-value"><%= sig.scoreBreakdown.riskQuality %>/10</div></div>
  </div>
</div>
<% } %>

<div class="section">
  <h3>Trade Levels</h3>
  <div class="perf-grid">
    <div class="perf-card"><div class="perf-label">Entry</div><div class="perf-value" style="color:#3b82f6;">$<%= formatPrice(sig.entry) %></div></div>
    <div class="perf-card"><div class="perf-label">Stop Loss</div><div class="perf-value" style="color:#ef4444;"><%= sig.stopLoss ? '$' + formatPrice(sig.stopLoss) : 'N/A' %></div></div>
    <div class="perf-card"><div class="perf-label">TP 1</div><div class="perf-value" style="color:#10b981;"><%= sig.takeProfit1 ? '$' + formatPrice(sig.takeProfit1) : 'N/A' %></div></div>
    <div class="perf-card"><div class="perf-label">TP 2</div><div class="perf-value" style="color:#10b981;"><%= sig.takeProfit2 ? '$' + formatPrice(sig.takeProfit2) : 'N/A' %></div></div>
    <div class="perf-card"><div class="perf-label">TP 3</div><div class="perf-value" style="color:#10b981;"><%= sig.takeProfit3 ? '$' + formatPrice(sig.takeProfit3) : 'N/A' %></div></div>
    <div class="perf-card"><div class="perf-label">Risk / Reward</div><div class="perf-value" style="color:#a78bfa;"><%= sig.riskReward %>x</div></div>
  </div>
</div>

<div class="section">
  <h3>Why This Trade</h3>
  <% (sig.reasoning || []).forEach(function(reason) { %>
    <div style="padding:10px 14px;background:#0d1320;border-radius:8px;margin-bottom:6px;font-size:14px;color:#d1d5db;line-height:1.5;"><%= reason %></div>
  <% }); %>
</div>

<% if (sig.indicators && sig.indicators.rsi) { %>
<div class="section">
  <h3>Technical Indicators</h3>
  <div class="perf-grid">
    <% if (sig.indicators.rsi) { %><div class="perf-card"><div class="perf-label">RSI (14)</div><div class="perf-value"><%= sig.indicators.rsi %></div></div><% } %>
    <% if (sig.indicators.adx) { %><div class="perf-card"><div class="perf-label">ADX</div><div class="perf-value"><%= sig.indicators.adx %></div></div><% } %>
    <% if (sig.indicators.trend) { %><div class="perf-card"><div class="perf-label">Trend</div><div class="perf-value" style="font-size:16px;"><%= sig.indicators.trend.replace('_',' ') %></div></div><% } %>
    <% if (sig.indicators.structure) { %><div class="perf-card"><div class="perf-label">Structure</div><div class="perf-value" style="font-size:16px;"><%= sig.indicators.structure %></div></div><% } %>
    <% if (sig.indicators.vwap) { %><div class="perf-card"><div class="perf-label">VWAP</div><div class="perf-value">$<%= formatPrice(sig.indicators.vwap) %></div></div><% } %>
    <% if (sig.indicators.macdHistogram !== undefined) { %><div class="perf-card"><div class="perf-label">MACD Hist</div><div class="perf-value <%= sig.indicators.macdHistogram >= 0 ? 'up' : 'down' %>"><%= sig.indicators.macdHistogram %></div></div><% } %>
    <% if (sig.indicators.stochK !== undefined) { %><div class="perf-card"><div class="perf-label">Stoch K/D</div><div class="perf-value"><%= sig.indicators.stochK %>/<%= sig.indicators.stochD %></div></div><% } %>
    <% if (sig.indicators.atr) { %><div class="perf-card"><div class="perf-label">ATR</div><div class="perf-value">$<%= formatPrice(sig.indicators.atr) %></div></div><% } %>
    <% if (sig.indicators.bollingerUpper) { %><div class="perf-card"><div class="perf-label">BB Range</div><div class="perf-value" style="font-size:14px;">$<%= formatPrice(sig.indicators.bollingerLower) %> - $<%= formatPrice(sig.indicators.bollingerUpper) %></div></div><% } %>
    <% if (sig.indicators.support) { %><div class="perf-card"><div class="perf-label">Support</div><div class="perf-value">$<%= formatPrice(sig.indicators.support) %></div></div><% } %>
    <% if (sig.indicators.resistance) { %><div class="perf-card"><div class="perf-label">Resistance</div><div class="perf-value">$<%= formatPrice(sig.indicators.resistance) %></div></div><% } %>
    <% if (sig.indicators.volumeTrend) { %><div class="perf-card"><div class="perf-label">Volume</div><div class="perf-value" style="font-size:16px;"><%= sig.indicators.volumeTrend %></div></div><% } %>
    <% if (sig.indicators.relativeVolume) { %><div class="perf-card"><div class="perf-label">Rel Volume</div><div class="perf-value"><%= sig.indicators.relativeVolume %>x</div></div><% } %>
    <% if (sig.indicators.fundingRate != null) { %><div class="perf-card"><div class="perf-label">Funding Rate</div><div class="perf-value <%= sig.indicators.fundingRate > 0.0005 ? 'down' : sig.indicators.fundingRate < -0.0005 ? 'up' : '' %>"><%= (sig.indicators.fundingRate * 100).toFixed(4) %>%</div></div><% } %>
    <% if (sig.indicators.btcCorrelation != null) { %><div class="perf-card"><div class="perf-label">BTC Corr</div><div class="perf-value"><%= (sig.indicators.btcCorrelation * 100).toFixed(0) %>%</div></div><% } %>
    <% if (sig.indicators.poc) { %><div class="perf-card"><div class="perf-label">Vol POC</div><div class="perf-value">$<%= formatPrice(sig.indicators.poc) %></div></div><% } %>
    <% if (sig.indicators.fibLevels && sig.indicators.fibLevels.fib618 > 0) { %><div class="perf-card"><div class="perf-label">Fib 0.618</div><div class="perf-value">$<%= formatPrice(sig.indicators.fibLevels.fib618) %></div></div><% } %>
  </div>
</div>
<% } %>

<% if (sig.indicators && sig.indicators.candlestickPatterns) {
  var allPatterns = [];
  ['1H','4H','1D'].forEach(function(tf) {
    var cp = sig.indicators.candlestickPatterns[tf];
    if (cp && cp.patterns && cp.patterns.length > 0) {
      cp.patterns.forEach(function(p) { allPatterns.push({ tf: tf, name: p.name, direction: p.direction, type: p.type, strength: p.strength, weight: p.weight, ctx: p.contextFactors || [], desc: p.description || '' }); });
    }
  });
  if (allPatterns.length > 0) { %>
<div class="section">
  <h3>Candlestick Patterns Detected</h3>
  <div style="display:flex;flex-direction:column;gap:6px;">
    <% allPatterns.forEach(function(p) { %>
    <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:#0d1320;border-radius:8px;border-left:3px solid <%= p.direction === 'BULL' ? '#10b981' : p.direction === 'BEAR' ? '#ef4444' : '#6b7280' %>;">
      <div style="min-width:36px;text-align:center;">
        <span style="font-size:10px;color:#6b7280;font-weight:600;"><%= p.tf %></span>
      </div>
      <div style="flex:1;">
        <div style="font-weight:600;font-size:14px;color:<%= p.direction === 'BULL' ? '#10b981' : p.direction === 'BEAR' ? '#ef4444' : '#d1d5db' %>;"><%= p.name %> <span style="font-size:11px;color:#6b7280;">(<%= p.type %>)</span></div>
        <div style="font-size:12px;color:#9ca3af;margin-top:2px;"><%= p.desc %></div>
        <% if (p.ctx.length > 0) { %>
        <div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;">
          <% p.ctx.forEach(function(c) { %>
          <span style="font-size:10px;padding:1px 6px;border-radius:4px;background:rgba(59,130,246,0.15);color:#3b82f6;"><%= c %></span>
          <% }); %>
        </div>
        <% } %>
      </div>
      <div style="text-align:right;min-width:60px;">
        <div style="font-size:11px;color:#6b7280;">Strength</div>
        <div style="font-size:16px;font-weight:700;color:<%= p.direction === 'BULL' ? '#10b981' : p.direction === 'BEAR' ? '#ef4444' : '#d1d5db' %>;"><%= '★'.repeat(Math.min(p.strength, 4)) %></div>
        <% if (p.weight && p.weight !== 1) { %>
        <div style="font-size:10px;color:#6b7280;">wt: <%= p.weight %>x</div>
        <% } %>
      </div>
    </div>
    <% }); %>
  </div>
  <div style="margin-top:8px;font-size:11px;color:#6b7280;">
    Bullish patterns support LONG signals &middot; Bearish patterns support SHORT signals &middot; Context multipliers adjust pattern weight based on S/R, divergence, volume, and trend alignment.
  </div>
</div>
<% } } %>

<% var scr = sig.score || 0; var conf = sig.confluenceLevel || 0; var minConf = scr >= 58 ? 1 : 2; var canTrade = typeof user !== 'undefined' && user && displaySignal !== 'HOLD' && scr >= 55 && conf >= minConf; %>
<% if (typeof user !== 'undefined' && user) { %>
<div class="section">
  <h3>Take This Trade</h3>
  <p style="font-size:12px;color:#6b7280;margin-bottom:10px;">Best strategy: <strong style="color:#3b82f6;"><%= sig.strategyName || 'N/A' %></strong> (score <%= sig.score || 0 %>). Or pick a specific strategy above.</p>
  <% if (canTrade) { %>
  <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
    <% if (displaySignal === 'BUY' || displaySignal === 'STRONG_BUY') { %>
      <form action="/trades/open" method="POST">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <input type="hidden" name="coinId" value="<%= sig.coin.id %>">
        <input type="hidden" name="direction" value="LONG">
        <input type="hidden" name="score" value="<%= sig.score %>">
        <input type="hidden" name="strategyType" value="<%= sig.strategyType || '' %>">
        <button type="submit" class="btn btn-buy">Open Long – <%= sig.strategyName || 'Main' %></button>
      </form>
    <% } %>
    <% if (displaySignal === 'SELL' || displaySignal === 'STRONG_SELL') { %>
      <form action="/trades/open" method="POST">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <input type="hidden" name="coinId" value="<%= sig.coin.id %>">
        <input type="hidden" name="direction" value="SHORT">
        <input type="hidden" name="score" value="<%= sig.score %>">
        <input type="hidden" name="strategyType" value="<%= sig.strategyType || '' %>">
        <button type="submit" class="btn btn-sell">Open Short – <%= sig.strategyName || 'Main' %></button>
      </form>
    <% } %>
  </div>
  <% } else if (displaySignal !== 'HOLD') { %>
  <p style="color:#6b7280;font-size:13px;">Main signal needs score ≥55 and confluence ≥<%= minConf %>. Current: score <%= sig.score || 0 %>, confluence <%= sig.confluenceLevel || 0 %>. You can still open via a strategy above if that strategy scores ≥55.</p>
  <% } %>
</div>
<% } %>

<%- include('partials/footer') %>
