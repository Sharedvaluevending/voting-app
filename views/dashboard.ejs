<%- include('partials/header') %>

<% if (typeof deleted !== 'undefined' && deleted) { %>
<div class="alert alert-success" style="margin-bottom:16px;">Your account has been deleted.</div>
<% } %>

<!-- PRICE TICKER (WebSocket real-time + fallback poll) -->
<div class="ticker-strip" id="ticker-strip">
  <% prices.forEach(function(coin) { %>
    <div class="ticker" data-coin-id="<%= coin.id %>" onclick="location.href='/coin/<%= coin.id %>'">
      <div class="ticker-sym"><%= coin.symbol %></div>
      <div class="ticker-price" data-price><%= typeof formatPrice !== 'undefined' ? '$' + formatPrice(coin.price) : '$' + Number(coin.price).toFixed(2) %></div>
      <div class="ticker-change <%= coin.change24h >= 0 ? 'up' : 'down' %>" data-change>
        <%= coin.change24h >= 0 ? '+' : '' %><%= Number(coin.change24h).toFixed(2) %>%
      </div>
    </div>
  <% }); %>
</div>

<!-- SUMMARY -->
<div class="summary-bar">
  <div class="summary-stat">
    <div class="label">Strong Buys</div>
    <div class="value up"><%= signals.filter(s => s.signal === 'STRONG_BUY').length %></div>
  </div>
  <div class="summary-stat">
    <div class="label">Buys</div>
    <div class="value" style="color:#3b82f6;"><%= signals.filter(s => s.signal === 'BUY').length %></div>
  </div>
  <div class="summary-stat">
    <div class="label">Sells</div>
    <div class="value down"><%= signals.filter(s => s.signal === 'SELL' || s.signal === 'STRONG_SELL').length %></div>
  </div>
  <div class="summary-stat">
    <div class="label">Hold</div>
    <div class="value" style="color:#eab308;"><%= signals.filter(s => s.signal === 'HOLD').length %></div>
  </div>
  <div class="summary-stat">
    <div class="label">Coins</div>
    <div class="value"><%= signals.length %></div>
  </div>
</div>

<!-- SIGNAL CARDS -->
<% if (signals.length === 0) { %>
  <div class="loading-note" style="text-align:center;padding:40px 20px;background:rgba(15,23,42,0.6);border:1px solid #1e2a3a;border-radius:12px;margin:20px 0;">
    <div style="font-size:32px;margin-bottom:16px;animation:pulse 2s infinite;">&#x23F3;</div>
    <h3 style="color:#e5e7eb;margin:0 0 8px 0;">Loading Market Data</h3>
    <p style="color:#9ca3af;font-size:14px;margin:0 0 8px 0;">Fetching OHLCV candles from Bybit & Kraken, prices from CoinGecko...</p>
    <p style="color:#6b7280;font-size:13px;margin:0;">First load takes ~30 seconds. Page auto-refreshes in 25s.</p>
    <div style="margin-top:16px;height:4px;background:#1e2a3a;border-radius:2px;overflow:hidden;">
      <div style="height:100%;width:0%;background:#3b82f6;border-radius:2px;animation:loadbar 25s linear forwards;"></div>
    </div>
  </div>
  <style>
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
    @keyframes loadbar { 0%{width:0%} 100%{width:100%} }
  </style>
  <script>setTimeout(function(){ location.reload(); }, 25000);</script>
<% } %>

<div class="signals-grid">
  <% signals.forEach(function(sig) { %>
    <% var isExcluded = typeof excludedCoins !== 'undefined' && excludedCoins.indexOf(sig.coin.id) !== -1; %>
    <div class="signal-card <%= sig.signal.toLowerCase().replace('_', '-') %> <%= isExcluded ? 'coin-excluded' : '' %>" data-coin-id="<%= sig.coin.id %>">
      <div class="card-header">
        <div class="coin-info">
          <h3>
            <a href="/coin/<%= sig.coin.id %>" style="color:#fff;text-decoration:none;"><%= sig.coin.name %></a> <span class="symbol"><%= sig.coin.symbol %></span>
            <% if (typeof user !== 'undefined' && user) { %>
              <button class="coin-toggle-btn <%= isExcluded ? 'excluded' : '' %>" data-coin="<%= sig.coin.id %>" onclick="toggleCoin(this, '<%= sig.coin.id %>')" title="<%= isExcluded ? 'Click to enable auto-trade for this coin' : 'Click to exclude from auto-trade' %>">
                <%= isExcluded ? 'OFF' : 'ON' %>
              </button>
              <span class="coin-excluded-label">EXCLUDED</span>
            <% } %>
          </h3>
          <span class="signal-badge badge-<%= sig.signal %>"><%= sig.signal.replace('_', ' ') %></span>
          <% if (typeof topPerformerCoins !== 'undefined' && topPerformerCoins.indexOf(sig.coin.symbol) !== -1) { %>
            <span class="regime-badge" style="background:rgba(16,185,129,0.3);color:#10b981;border:1px solid rgba(16,185,129,0.5);" title="Top 5 backtest performer">Top performer</span>
          <% } %>
          <% if (sig.regime && sig.regime !== 'unknown') { %>
            <span class="regime-badge regime-<%= sig.regime %>"><%= sig.regime %></span>
          <% } %>
        </div>
        <div class="coin-price">
          <div class="price card-price">$<%= formatPrice(sig.coin.price) %></div>
          <div class="change card-change <%= sig.coin.change24h >= 0 ? 'up' : 'down' %>">
            <%= sig.coin.change24h >= 0 ? '+' : '' %><%= sig.coin.change24h.toFixed(2) %>%
          </div>
        </div>
      </div>

      <!-- Score Bar -->
      <div class="score-bar">
        <div class="score-bar-outer">
          <div class="score-bar-inner" style="width:<%= Math.min(100, sig.score || 0) %>%;background:<%= (sig.score||0) >= 70 ? '#10b981' : (sig.score||0) >= 50 ? '#3b82f6' : (sig.score||0) >= 30 ? '#eab308' : '#ef4444' %>;"></div>
        </div>
        <div class="score-label">
          <span>Score: <strong><%= sig.score || 0 %>/100</strong></span>
          <span><%= sig.strategyName || '' %></span>
        </div>
      </div>

      <% if (sig.topStrategies && sig.topStrategies.length > 0) { %>
      <div class="top-strategies" style="font-size:11px;color:#9ca3af;margin-top:6px;display:flex;flex-wrap:wrap;gap:6px;">
        <% sig.topStrategies.forEach(function(ts) { %>
          <span class="<%= ts.signal === 'STRONG_BUY' || ts.signal === 'BUY' ? 'up' : ts.signal === 'STRONG_SELL' || ts.signal === 'SELL' ? 'down' : '' %>"><%= ts.name %>: <strong><%= ts.signal %></strong> (<%= ts.score %>)</span>
        <% }); %>
      </div>
      <% } %>

      <% if (sig.scoreBreakdown) { %>
      <div class="score-breakdown">
        <div class="score-cat" title="Trend: EMA/SMA alignment, ADX strength, price vs moving averages (0-20)">T <span><%= sig.scoreBreakdown.trend %></span></div>
        <div class="score-cat" title="Momentum: RSI, MACD, Stochastic, momentum acceleration (0-20)">M <span><%= sig.scoreBreakdown.momentum %></span></div>
        <div class="score-cat" title="Volume: Relative volume, VWAP position, accumulation/distribution (0-20)">V <span><%= sig.scoreBreakdown.volume %></span></div>
        <div class="score-cat" title="Structure: Market structure (HH/HL/LH/LL), S/R levels, order blocks, patterns (0-20)">S <span><%= sig.scoreBreakdown.structure %></span></div>
        <div class="score-cat" title="Volatility: BB squeeze, ATR state, trend+vol quality (0-10)">Vol <span><%= sig.scoreBreakdown.volatility %></span></div>
        <div class="score-cat" title="Risk Quality: Clear S/R levels, ATR for stop sizing, data reliability (0-10)">R <span><%= sig.scoreBreakdown.riskQuality %></span></div>
      </div>
      <% } %>

      <% if (sig.indicators && sig.indicators.candlestickPatterns) {
        var allCp = [];
        ['1H','4H','1D'].forEach(function(tf) {
          var cp = sig.indicators.candlestickPatterns[tf];
          if (cp && cp.patterns && cp.patterns.length > 0) {
            cp.patterns.forEach(function(p) { allCp.push({ tf: tf, name: p.name, direction: p.direction, ctx: p.contextFactors || [] }); });
          }
        });
        if (allCp.length > 0) { %>
      <div class="pattern-row" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;">
        <% allCp.slice(0,5).forEach(function(p) { %>
          <span style="display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600;background:<%= p.direction === 'BULL' ? 'rgba(16,185,129,0.15)' : p.direction === 'BEAR' ? 'rgba(239,68,68,0.15)' : 'rgba(156,163,175,0.15)' %>;color:<%= p.direction === 'BULL' ? '#10b981' : p.direction === 'BEAR' ? '#ef4444' : '#9ca3af' %>;border:1px solid <%= p.direction === 'BULL' ? 'rgba(16,185,129,0.3)' : p.direction === 'BEAR' ? 'rgba(239,68,68,0.3)' : 'rgba(156,163,175,0.3)' %>;">
            <span style="font-size:10px;opacity:0.7;"><%= p.tf %></span> <%= p.name %><% if (p.ctx.length > 0) { %> <span style="font-size:9px;opacity:0.7;">(<%= p.ctx.slice(0,2).join(', ') %>)</span><% } %>
          </span>
        <% }); %>
        <% if (allCp.length > 5) { %><span style="font-size:10px;color:#6b7280;">+<%= allCp.length - 5 %> more</span><% } %>
      </div>
      <% } } %>

      <div class="signal-meta">
        <span>Conf: <strong><%= sig.confidence %>%</strong></span>
        <span>R:R <strong><%= sig.riskReward %>x</strong></span>
        <span>Confl: <strong><%= sig.confluenceLevel %>/3</strong></span>
        <span>TF: <strong><%= sig.bestTimeframe %></strong></span>
        <% if (sig.suggestedLeverage > 1) { %>
          <span class="lev-badge"><%= sig.suggestedLeverage %>x LEV</span>
        <% } %>
        <% if (sig.stopLabel || sig.tpLabel) { %>
          <span style="color:#6b7280;">Stop: <strong><%= sig.stopLabel || 'ATR + S/R' %></strong> · TP: <strong><%= sig.tpLabel || 'R multiples' %></strong></span>
        <% } %>
      </div>

      <% if (sig.timeframes) { %>
      <div class="tf-row">
        <% ['15m','1H','4H','1D','1W'].forEach(function(tf) { var t = sig.timeframes[tf]; if(t) { %>
          <div class="tf-chip <%= t.direction === 'BULL' ? 'tf-bull' : t.direction === 'BEAR' ? 'tf-bear' : 'tf-neutral' %>">
            <span class="tf-label"><%= tf %></span> <%= t.signal %> (<%= t.score %>) <span class="tf-rsi"><%= t.rsi && t.rsi !== '-' && t.rsi !== 0 ? 'RSI ' + t.rsi : '' %></span>
          </div>
        <% }}); %>
      </div>
      <% } %>

      <% if (sig.entry) { %>
      <div class="levels">
        <div class="level"><div class="level-label">Entry</div><div class="level-value entry">$<%= formatPrice(sig.entry) %></div></div>
        <div class="level"><div class="level-label">Stop Loss</div><div class="level-value sl"><%= sig.stopLoss ? '$' + formatPrice(sig.stopLoss) : '-' %></div></div>
        <div class="level"><div class="level-label">R:R</div><div class="level-value rr"><%= sig.riskReward %>x</div></div>
        <div class="level"><div class="level-label">TP 1</div><div class="level-value tp"><%= sig.takeProfit1 ? '$' + formatPrice(sig.takeProfit1) : '-' %></div></div>
        <div class="level"><div class="level-label">TP 2</div><div class="level-value tp"><%= sig.takeProfit2 ? '$' + formatPrice(sig.takeProfit2) : '-' %></div></div>
        <div class="level"><div class="level-label">TP 3</div><div class="level-value tp"><%= sig.takeProfit3 ? '$' + formatPrice(sig.takeProfit3) : '-' %></div></div>
      </div>
      <% } %>

      <div class="reasoning">
        <h4>Why This Trade</h4>
        <% (sig.reasoning || []).forEach(function(reason) { %>
          <div class="reason"><%= reason %></div>
        <% }); %>
      </div>

      <% var canTrade = typeof user !== 'undefined' && user && sig.signal !== 'HOLD' && (sig.score || 0) >= 55 && (sig.confluenceLevel || 0) >= 2; %>
      <% if (typeof user !== 'undefined' && user) { %>
      <div class="trade-actions">
        <% if (canTrade && (sig.signal === 'BUY' || sig.signal === 'STRONG_BUY')) { %>
          <form action="/trades/open" method="POST" style="display:inline;">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <input type="hidden" name="coinId" value="<%= sig.coin.id %>">
            <input type="hidden" name="direction" value="LONG">
            <input type="hidden" name="score" value="<%= sig.score %>">
            <button type="submit" class="btn btn-buy btn-sm">Open Long</button>
          </form>
        <% } %>
        <% if (canTrade && (sig.signal === 'SELL' || sig.signal === 'STRONG_SELL')) { %>
          <form action="/trades/open" method="POST" style="display:inline;">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <input type="hidden" name="coinId" value="<%= sig.coin.id %>">
            <input type="hidden" name="direction" value="SHORT">
            <input type="hidden" name="score" value="<%= sig.score %>">
            <button type="submit" class="btn btn-sell btn-sm">Open Short</button>
          </form>
        <% } %>
        <% if (!canTrade && sig.signal !== 'HOLD') { %>
          <span style="font-size:11px;color:#6b7280;">Score ≥55 &amp; confluence ≥2 to open</span>
        <% } %>
        <a href="/coin/<%= sig.coin.id %>" class="btn btn-outline btn-sm">Details</a>
        <a href="/chart/<%= sig.coin.id %>" class="btn btn-outline btn-sm" target="_blank" rel="noopener">View chart</a>
      </div>
      <% } else { %>
      <div class="trade-actions">
        <a href="/coin/<%= sig.coin.id %>" class="btn btn-outline btn-sm">Details</a>
        <a href="/chart/<%= sig.coin.id %>" class="btn btn-outline btn-sm" target="_blank" rel="noopener">View chart</a>
      </div>
      <% } %>
    </div>
  <% }); %>
</div>

<% if (prices.length > 0) { %>
<script>
(function() {
  function fmt(p) {
    if (p == null || isNaN(p)) return '0.00';
    var n = Number(p);
    if (n >= 1000) return n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    if (n >= 1) return n.toFixed(2);
    if (n >= 0.01) return n.toFixed(4);
    return n.toFixed(8);
  }
  function poll() {
    fetch('/api/prices', { credentials: 'same-origin' })
      .then(function(r) { return r.ok ? r.json() : null; })
      .then(function(json) {
        if (!json || !json.data || !json.data.length) return;
        var byId = {};
        json.data.forEach(function(p) { byId[p.id] = p; });
        document.querySelectorAll('.ticker[data-coin-id]').forEach(function(el) {
          var id = el.getAttribute('data-coin-id');
          var p = byId[id];
          if (!p) return;
          var priceEl = el.querySelector('[data-price]');
          var changeEl = el.querySelector('[data-change]');
          if (priceEl) priceEl.textContent = '$' + fmt(p.price);
          if (changeEl) {
            var ch = Number(p.change24h);
            changeEl.textContent = (ch >= 0 ? '+' : '') + ch.toFixed(2) + '%';
            changeEl.className = 'ticker-change ' + (ch >= 0 ? 'up' : 'down');
          }
        });
        document.querySelectorAll('.signal-card[data-coin-id]').forEach(function(el) {
          var id = el.getAttribute('data-coin-id');
          var p = byId[id];
          if (!p) return;
          var priceEl = el.querySelector('.card-price');
          var changeEl = el.querySelector('.card-change');
          if (priceEl) priceEl.textContent = '$' + fmt(p.price);
          if (changeEl) {
            var ch = Number(p.change24h);
            changeEl.textContent = (ch >= 0 ? '+' : '') + ch.toFixed(2) + '%';
            changeEl.className = 'change card-change ' + (ch >= 0 ? 'up' : 'down');
          }
        });
      })
      .catch(function() {});
  }
  setInterval(poll, 15000);
  setTimeout(poll, 5000);
})();
</script>
<% } %>
<!-- Coin toggle styles -->
<style>
.coin-toggle-btn {
  display: inline-block;
  margin-left: 8px;
  padding: 2px 10px;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.5px;
  border-radius: 4px;
  border: 1px solid #10b981;
  background: rgba(16,185,129,0.15);
  color: #10b981;
  cursor: pointer;
  vertical-align: middle;
  transition: all 0.2s ease;
}
.coin-toggle-btn:hover {
  background: rgba(16,185,129,0.3);
}
.coin-toggle-btn.excluded {
  border-color: #ef4444;
  background: rgba(239,68,68,0.15);
  color: #ef4444;
}
.coin-toggle-btn.excluded:hover {
  background: rgba(239,68,68,0.3);
}
.signal-card.coin-excluded {
  opacity: 0.5;
  border-color: #ef4444 !important;
}
.coin-excluded-label {
  display: none;
  background: rgba(239,68,68,0.85);
  color: #fff;
  font-size: 10px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 3px;
  letter-spacing: 0.5px;
  margin-left: 6px;
  vertical-align: middle;
}
.signal-card.coin-excluded .coin-excluded-label {
  display: inline-block;
}
</style>

<!-- Coin toggle script -->
<script>
function toggleCoin(btn, coinId) {
  var isCurrentlyExcluded = btn.classList.contains('excluded');
  var newExcluded = !isCurrentlyExcluded;
  btn.disabled = true;
  btn.textContent = '...';

  fetch('/api/toggle-coin', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'same-origin',
    body: JSON.stringify({ coinId: coinId, excluded: newExcluded })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.success) {
      var card = btn.closest('.signal-card');
      var label = btn.parentElement.querySelector('.coin-excluded-label');
      if (newExcluded) {
        btn.classList.add('excluded');
        btn.textContent = 'OFF';
        btn.title = 'Click to enable auto-trade for this coin';
        if (card) card.classList.add('coin-excluded');
      } else {
        btn.classList.remove('excluded');
        btn.textContent = 'ON';
        btn.title = 'Click to exclude from auto-trade';
        if (card) card.classList.remove('coin-excluded');
      }
    } else {
      alert('Failed to update: ' + (data.error || 'Unknown error'));
    }
    btn.disabled = false;
  })
  .catch(function(err) {
    alert('Error: ' + err.message);
    btn.disabled = false;
    btn.textContent = isCurrentlyExcluded ? 'OFF' : 'ON';
  });
}
</script>

<!-- WebSocket prices via ws-prices.js (footer) - real-time ticker, cards, trades, nav PnL -->

<%- include('partials/footer') %>
