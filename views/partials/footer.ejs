  </div>
  <footer class="footer">
    <div class="disclaimer">
      This tool is for informational and educational purposes only. Not financial advice.
      Always DYOR. Crypto is volatile - never trade more than you can afford to lose.
      Signals are generated from technical analysis of public market data via CoinGecko &amp; Bitget APIs.
    </div>
  </footer>

  <!-- Real-time WebSocket prices (all pages: ticker, cards, trades, nav PnL) -->
  <script src="/js/ws-prices.js"></script>

  <% if (typeof user !== 'undefined' && user) { %>
  <script>
  // Live PNL â€” real-time via WebSocket + fallback poll every 5s
  (function() {
    var pnlEl = document.getElementById('nav-live-pnl');
    if (!pnlEl) return;

    var lastTrades = null;
    var lastPriceMap = {};

    function computeAndShowPnl(priceMap) {
      if (!lastTrades || !priceMap) return;
      var totalPnl = 0, tradeCount = 0;
      for (var tid in lastTrades) {
        var t = lastTrades[tid];
        var currentPrice = priceMap[t.coinId];
        if (currentPrice == null || isNaN(currentPrice) || currentPrice <= 0) continue;
        if (!t.entryPrice || !t.positionSize) continue;
        var unrealized = t.direction === 'LONG'
          ? ((currentPrice - t.entryPrice) / t.entryPrice) * t.positionSize
          : ((t.entryPrice - currentPrice) / t.entryPrice) * t.positionSize;
        totalPnl += (t.partialPnl || 0) + unrealized;
        tradeCount++;
      }
      if (tradeCount === 0) {
        pnlEl.style.display = 'none';
        pnlEl.className = 'nav-pnl';
        return;
      }
      var sign = totalPnl >= 0 ? '+' : '';
      pnlEl.textContent = sign + '$' + totalPnl.toFixed(2) + ' PNL';
      pnlEl.style.display = 'inline';
      pnlEl.className = totalPnl > 0.01 ? 'nav-pnl pnl-positive' : totalPnl < -0.01 ? 'nav-pnl pnl-negative' : 'nav-pnl pnl-zero';
    }

    function updateNavPnl() {
      Promise.all([
        fetch('/api/trades/active', { credentials: 'same-origin' }).then(function(r) { return r.ok ? r.json() : null; }),
        fetch('/api/prices', { credentials: 'same-origin' }).then(function(r) { return r.ok ? r.json() : null; })
      ]).then(function(results) {
        var tradesData = results[0];
        var pricesData = results[1];
        if (!tradesData || !tradesData.success || !tradesData.trades) return;
        if (!pricesData || !pricesData.success || !pricesData.data) return;

        lastTrades = tradesData.trades;
        var priceMap = {};
        for (var i = 0; i < pricesData.data.length; i++) {
          var p = pricesData.data[i];
          if (p && p.id != null) priceMap[p.id] = Number(p.price);
        }
        if (window.__wsPrices) {
          for (var cid in window.__wsPrices) {
            if (window.__wsPrices[cid] && window.__wsPrices[cid].price != null) {
              priceMap[cid] = window.__wsPrices[cid].price;
            }
          }
        }
        lastPriceMap = priceMap;
        computeAndShowPnl(priceMap);
      }).catch(function() {});
    }

    window.addEventListener('ws-price-update', function(ev) {
      if (!lastTrades) return;
      if (ev.detail && ev.detail.coinId != null && ev.detail.price != null) {
        lastPriceMap[ev.detail.coinId] = ev.detail.price;
      }
      computeAndShowPnl(lastPriceMap);
    });

    setTimeout(updateNavPnl, 1500);
    setInterval(updateNavPnl, 5000);
  })();
  </script>
  <% } %>
  <script>
  (function() {
    var toggle = document.getElementById('nav-toggle');
    var links = document.getElementById('nav-links');
    if (toggle && links) {
      toggle.addEventListener('click', function() {
        links.classList.toggle('nav-open');
        toggle.setAttribute('aria-expanded', links.classList.contains('nav-open'));
      });
    }
  })();
  </script>
</body>
</html>
