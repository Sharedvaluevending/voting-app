<%- include('partials/header') %>

<div class="section-header">
  <h2 style="color:#fff;font-size:22px;">Performance Dashboard</h2>
  <form action="/account/reset" method="POST" style="display:inline;">
    <button type="submit" class="btn btn-outline btn-sm" onclick="return confirm('Reset paper account to $10,000? All trade history will be deleted.')">Reset Account</button>
  </form>
</div>

<% if (typeof success !== 'undefined' && success) { %>
  <div class="alert alert-success" style="margin-bottom:12px;"><%= success %></div>
<% } %>
<% if (typeof error !== 'undefined' && error) { %>
  <div class="alert alert-error" style="margin-bottom:12px;"><%= error %></div>
<% } %>

<% if (typeof user !== 'undefined' && user) { %>
<div class="section" style="margin-bottom:24px;">
  <h3 style="color:#e5e7eb;margin-bottom:12px;">Trading settings</h3>
  <p style="font-size:13px;color:#9ca3af;margin-bottom:12px;">Limit how much of your balance each trade can use. Lower values = safer position sizing.</p>
  <form action="/account/settings" method="POST" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;align-items:end;max-width:700px;">
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Max balance per trade (%)</label>
      <input type="number" name="maxBalancePercentPerTrade" min="5" max="100" value="<%= (user.settings && user.settings.maxBalancePercentPerTrade) != null ? user.settings.maxBalancePercentPerTrade : 25 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Risk per trade (%)</label>
      <input type="number" name="riskPerTrade" min="0.5" max="10" step="0.5" value="<%= (user.settings && user.settings.riskPerTrade) != null ? user.settings.riskPerTrade : 2 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Max open trades</label>
      <input type="number" name="maxOpenTrades" min="1" max="10" value="<%= (user.settings && user.settings.maxOpenTrades) || 3 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Default leverage</label>
      <input type="number" name="defaultLeverage" min="1" max="20" value="<%= (user.settings && user.settings.defaultLeverage) || 1 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Cooldown (hours)</label>
      <input type="number" name="cooldownHours" min="0" max="168" title="Hours to wait before re-opening same direction on same coin" value="<%= (user.settings && user.settings.cooldownHours) != null ? user.settings.cooldownHours : 4 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div style="display:flex;align-items:center;gap:8px;" title="When score check suggests Tighten stop, Reduce position, Take partial, or Consider exit — execute it automatically">
      <input type="hidden" name="autoExecuteActions" value="false">
      <input type="checkbox" name="autoExecuteActions" id="autoExecuteActions" value="true" <%= (user.settings && user.settings.autoExecuteActions) ? 'checked' : '' %>>
      <label for="autoExecuteActions" style="font-size:12px;color:#9ca3af;">Auto-execute score check actions</label>
    </div>
    <div style="display:flex;align-items:center;gap:8px;" title="Move stop to breakeven when price reaches 1R in profit">
      <input type="hidden" name="autoMoveBreakeven" value="false">
      <input type="checkbox" name="autoMoveBreakeven" id="autoMoveBreakeven" value="true" <%= (user.settings && user.settings.autoMoveBreakeven) !== false ? 'checked' : '' %>>
      <label for="autoMoveBreakeven" style="font-size:12px;color:#9ca3af;">Auto move to breakeven</label>
    </div>
    <div style="display:flex;align-items:center;gap:8px;" title="Trail stop at 1.5R when price reaches 1R in profit">
      <input type="hidden" name="autoTrailingStop" value="false">
      <input type="checkbox" name="autoTrailingStop" id="autoTrailingStop" value="true" <%= (user.settings && user.settings.autoTrailingStop) !== false ? 'checked' : '' %>>
      <label for="autoTrailingStop" style="font-size:12px;color:#9ca3af;">Auto trailing stop</label>
    </div>
    <div>
      <button type="submit" class="btn btn-outline btn-sm">Save</button>
    </div>
  </form>
</div>
<% } %>

<!-- Position Sizing Calculator -->
<div class="section" style="margin-bottom:24px;">
  <h3 style="color:#e5e7eb;margin-bottom:12px;">Position Sizing Calculator</h3>
  <p style="font-size:13px;color:#9ca3af;margin-bottom:12px;">Enter your trade parameters to see risk amount and recommended position size.</p>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;align-items:end;max-width:900px;">
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Account balance ($)</label>
      <input type="number" id="calc-balance" min="100" step="100" value="<%= stats.balance %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Risk per trade (%)</label>
      <input type="number" id="calc-risk" min="0.5" max="10" step="0.5" value="2" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Entry price ($)</label>
      <input type="number" id="calc-entry" min="0.0001" step="0.01" value="1" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Stop loss ($)</label>
      <input type="number" id="calc-sl" min="0" step="0.01" value="0.98" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Leverage</label>
      <input type="number" id="calc-lev" min="1" max="20" value="1" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
  </div>
  <div id="calc-result" style="margin-top:14px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
    <span style="font-size:13px;color:#9ca3af;">Risk amount: <strong id="calc-risk-amt" style="color:#eab308;">$0</strong></span>
    <span style="font-size:13px;color:#9ca3af;">Position size: <strong id="calc-pos" style="color:#10b981;">$0</strong></span>
    <span style="font-size:13px;color:#9ca3af;">Margin needed: <strong id="calc-margin" style="color:#3b82f6;">$0</strong></span>
    <span style="font-size:11px;color:#6b7280;">(Stop distance: <span id="calc-stop-pct">0</span>%)</span>
  </div>
</div>

<div class="perf-grid">
  <div class="perf-card">
    <div class="perf-label">Balance</div>
    <div class="perf-value">$<%= stats.balance.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Total P&L</div>
    <div class="perf-value <%= stats.totalPnl >= 0 ? 'up' : 'down' %>"><%= stats.totalPnl >= 0 ? '+' : '' %>$<%= stats.totalPnl.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Return</div>
    <div class="perf-value <%= parseFloat(stats.totalPnlPercent) >= 0 ? 'up' : 'down' %>"><%= stats.totalPnlPercent %>%</div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Win Rate</div>
    <div class="perf-value"><%= stats.winRate %>%</div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Total Trades</div>
    <div class="perf-value"><%= stats.totalTrades %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Wins / Losses</div>
    <div class="perf-value"><span class="up"><%= stats.wins %></span> / <span class="down"><%= stats.losses %></span></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Profit Factor</div>
    <div class="perf-value"><%= stats.profitFactor %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Avg Win</div>
    <div class="perf-value up">+$<%= stats.avgWin.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Avg Loss</div>
    <div class="perf-value down">-$<%= stats.avgLoss.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Best Trade</div>
    <div class="perf-value up">+$<%= stats.bestTrade.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Worst Trade</div>
    <div class="perf-value down">$<%= stats.worstTrade.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Streak</div>
    <div class="perf-value"><%= stats.currentStreak > 0 ? '+' : '' %><%= stats.currentStreak %> (best: <%= stats.bestStreak %>)</div>
  </div>
  <div class="perf-card">
    <div class="perf-label">7-Day P&L</div>
    <div class="perf-value <%= stats.pnl7d >= 0 ? 'up' : 'down' %>"><%= stats.pnl7d >= 0 ? '+' : '' %>$<%= stats.pnl7d.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Open Trades</div>
    <div class="perf-value"><%= stats.openTrades %></div>
  </div>
  <% if (stats.sharpe != null) { %>
  <div class="perf-card">
    <div class="perf-label">Sharpe Ratio</div>
    <div class="perf-value <%= stats.sharpe >= 0 ? 'up' : 'down' %>"><%= stats.sharpe %></div>
  </div>
  <% } %>
  <% if (stats.sortino != null) { %>
  <div class="perf-card">
    <div class="perf-label">Sortino Ratio</div>
    <div class="perf-value <%= stats.sortino >= 0 ? 'up' : 'down' %>"><%= stats.sortino %></div>
  </div>
  <% } %>
  <div class="perf-card">
    <div class="perf-label">Max Drawdown</div>
    <div class="perf-value down">$<%= (stats.maxDrawdown || 0).toFixed(2) %> (<%= (stats.maxDrawdownPct || 0) %>% of peak)</div>
  </div>
</div>

<% if (stats.equityCurve && stats.equityCurve.length > 1) { %>
<div class="section">
  <h3>Equity Curve</h3>
  <p style="font-size:12px;color:#6b7280;margin-bottom:10px;">Account balance over time. Drawdown shaded in red. Markers show trade outcomes and actions.</p>
  <div class="equity-chart-wrap" style="position:relative;background:#0d1320;border-radius:8px;padding:12px;border:1px solid #1e2a3a;overflow:hidden;">
    <canvas id="equity-curve" style="width:100%;height:260px;display:block;"></canvas>
    <div id="equity-tooltip" style="display:none;position:absolute;background:#1e293b;border:1px solid #334155;border-radius:6px;padding:8px 10px;font-size:11px;color:#d1d5db;pointer-events:none;z-index:10;white-space:nowrap;"></div>
    <div id="equity-legend" style="font-size:11px;color:#6b7280;margin-top:8px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;"></div>
  </div>
</div>
<% } %>

<% if (Object.keys(stats.byStrategy).length > 0) { %>
<div class="section">
  <h3>By Strategy</h3>
  <table class="data-table">
    <thead><tr><th>Strategy</th><th>Wins</th><th>Losses</th><th>Win Rate</th><th>P&L</th></tr></thead>
    <tbody>
      <% Object.entries(stats.byStrategy).forEach(function([name, data]) {
        var total = data.wins + data.losses;
        var wr = total > 0 ? ((data.wins/total)*100).toFixed(1) : '0';
      %>
        <tr>
          <td><%= name %></td>
          <td class="up"><%= data.wins %></td>
          <td class="down"><%= data.losses %></td>
          <td><%= wr %>%</td>
          <td class="<%= data.pnl >= 0 ? 'up' : 'down' %>"><%= data.pnl >= 0 ? '+' : '' %>$<%= data.pnl.toFixed(2) %></td>
        </tr>
      <% }); %>
    </tbody>
  </table>
</div>
<% } %>

<% if (Object.keys(stats.byCoin).length > 0) { %>
<div class="section">
  <h3>By Coin</h3>
  <table class="data-table">
    <thead><tr><th>Coin</th><th>Wins</th><th>Losses</th><th>Win Rate</th><th>P&L</th></tr></thead>
    <tbody>
      <% Object.entries(stats.byCoin).forEach(function([name, data]) {
        var total = data.wins + data.losses;
        var wr = total > 0 ? ((data.wins/total)*100).toFixed(1) : '0';
      %>
        <tr>
          <td style="font-weight:700;"><%= name %></td>
          <td class="up"><%= data.wins %></td>
          <td class="down"><%= data.losses %></td>
          <td><%= wr %>%</td>
          <td class="<%= data.pnl >= 0 ? 'up' : 'down' %>"><%= data.pnl >= 0 ? '+' : '' %>$<%= data.pnl.toFixed(2) %></td>
        </tr>
      <% }); %>
    </tbody>
  </table>
</div>
<% } %>

<script>
(function() {
  var calcInputs = ['calc-balance','calc-risk','calc-entry','calc-sl','calc-lev'];
  function updateCalc() {
    var bal = parseFloat(document.getElementById('calc-balance').value) || 10000;
    var risk = parseFloat(document.getElementById('calc-risk').value) || 2;
    var entry = parseFloat(document.getElementById('calc-entry').value) || 1;
    var sl = parseFloat(document.getElementById('calc-sl').value) || 0.98;
    var lev = parseFloat(document.getElementById('calc-lev').value) || 1;
    var riskAmt = bal * (risk / 100);
    var stopDist = entry > 0 ? Math.abs(entry - sl) / entry : 0.02;
    if (stopDist <= 0) stopDist = 0.02;
    var posSize = (riskAmt / stopDist) * lev;
    var capped = Math.min(posSize, bal * lev * 0.95);
    var margin = capped / lev;
    document.getElementById('calc-risk-amt').textContent = '$' + riskAmt.toFixed(2);
    document.getElementById('calc-pos').textContent = '$' + capped.toFixed(2);
    document.getElementById('calc-margin').textContent = '$' + margin.toFixed(2);
    document.getElementById('calc-stop-pct').textContent = (stopDist * 100).toFixed(2);
  }
  calcInputs.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.addEventListener('input', updateCalc);
  });
  updateCalc();

  <% if (stats.equityCurve && stats.equityCurve.length > 1) { %>
  (function() {
    var data = <%- JSON.stringify(stats.equityCurve) %>;
    var canvas = document.getElementById('equity-curve');
    if (!canvas || !data || data.length < 2) return;
    var ctx = canvas.getContext('2d');
    var tooltip = document.getElementById('equity-tooltip');

    // Responsive: set canvas pixel size from CSS layout size
    var dpr = window.devicePixelRatio || 1;
    function resizeCanvas() {
      var rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      drawChart();
    }

    // Action/status color & label map
    var statusColors = {
      'TP1_HIT': '#10b981', 'TP2_HIT': '#34d399', 'TP3_HIT': '#6ee7b7',
      'STOPPED_OUT': '#ef4444', 'CLOSED_MANUAL': '#eab308', 'SCORE_EXIT': '#f97316'
    };
    var statusLabels = {
      'TP1_HIT': 'TP1', 'TP2_HIT': 'TP2', 'TP3_HIT': 'TP3',
      'STOPPED_OUT': 'SL', 'CLOSED_MANUAL': 'Manual', 'SCORE_EXIT': 'Score'
    };
    var actionColors = {
      'BE': '#10b981', 'TS': '#3b82f6', 'PP': '#a78bfa',
      'RP': '#fbbf24', 'EXIT': '#f87171', 'LOCK': '#38bdf8'
    };

    // Store point positions for hover
    var pointPositions = [];

    function drawChart() {
      var rect = canvas.getBoundingClientRect();
      var w = rect.width, h = rect.height;
      var pad = { top: 14, right: 14, bottom: 28, left: 54 };
      var plotW = w - pad.left - pad.right, plotH = h - pad.top - pad.bottom;
      var eq = data.map(function(d) { return d.equity; });
      var minE = Math.min.apply(null, eq);
      var maxE = Math.max.apply(null, eq);
      var range = maxE - minE || 1;
      minE = Math.max(0, minE - range * 0.08);
      maxE = maxE + range * 0.08;
      range = maxE - minE || 1;

      ctx.clearRect(0, 0, w, h);

      // Grid lines
      ctx.strokeStyle = '#1e2a3a';
      ctx.lineWidth = 0.5;
      for (var g = 0; g <= 4; g++) {
        var gy = pad.top + (plotH * g / 4);
        ctx.beginPath();
        ctx.moveTo(pad.left, gy);
        ctx.lineTo(pad.left + plotW, gy);
        ctx.stroke();
        ctx.fillStyle = '#4b5563';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText('$' + Math.round(maxE - (range * g / 4)).toLocaleString(), pad.left - 4, gy + 3);
      }

      // Compute XY for each data point
      pointPositions = [];
      var pts = [];
      for (var i = 0; i < data.length; i++) {
        var x = pad.left + (i / (data.length - 1)) * plotW;
        var y = pad.top + plotH - ((data[i].equity - minE) / range) * plotH;
        pts.push({ x: x, y: y });
        pointPositions.push({ x: x, y: y, idx: i });
      }

      // Drawdown shading (red fill between peak line and equity when in drawdown)
      var peak = data[0].equity;
      ctx.beginPath();
      var inDrawdown = false;
      for (var i = 0; i < data.length; i++) {
        if (data[i].equity > peak) peak = data[i].equity;
        var peakY = pad.top + plotH - ((peak - minE) / range) * plotH;
        if (data[i].drawdown > 0) {
          if (!inDrawdown) {
            ctx.moveTo(pts[i].x, peakY);
            inDrawdown = true;
          }
          ctx.lineTo(pts[i].x, pts[i].y);
        } else {
          if (inDrawdown) {
            // Close the drawdown area back up to peak
            ctx.lineTo(pts[i].x, peakY);
            ctx.closePath();
            inDrawdown = false;
          }
          ctx.moveTo(pts[i].x, pts[i].y);
        }
      }
      if (inDrawdown) {
        var lastPeakY = pad.top + plotH - ((peak - minE) / range) * plotH;
        ctx.lineTo(pts[data.length - 1].x, lastPeakY);
        ctx.closePath();
      }
      ctx.fillStyle = 'rgba(239,68,68,0.12)';
      ctx.fill();

      // Equity line
      ctx.beginPath();
      for (var i = 0; i < pts.length; i++) {
        if (i === 0) ctx.moveTo(pts[i].x, pts[i].y);
        else ctx.lineTo(pts[i].x, pts[i].y);
      }
      ctx.strokeStyle = '#10b981';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Fill under equity line
      ctx.lineTo(pts[pts.length - 1].x, pad.top + plotH);
      ctx.lineTo(pts[0].x, pad.top + plotH);
      ctx.closePath();
      ctx.fillStyle = 'rgba(16,185,129,0.1)';
      ctx.fill();

      // Draw action markers on each trade point (skip index 0 = initial balance)
      for (var i = 1; i < data.length; i++) {
        var d = data[i];
        var px = pts[i].x, py = pts[i].y;

        // Main status marker (circle)
        var color = statusColors[d.status] || '#6b7280';
        var radius = 4;
        ctx.beginPath();
        ctx.arc(px, py, radius, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.fill();
        ctx.strokeStyle = '#0d1320';
        ctx.lineWidth = 1.5;
        ctx.stroke();

        // Action dots (small dots above the main marker for each action taken)
        if (d.actions && d.actions.length > 0) {
          var unique = [];
          var seen = {};
          for (var a = 0; a < d.actions.length; a++) {
            if (!seen[d.actions[a]]) {
              seen[d.actions[a]] = true;
              unique.push(d.actions[a]);
            }
          }
          var dotY = py - 8;
          var totalWidth = (unique.length - 1) * 7;
          var startX = px - totalWidth / 2;
          for (var a = 0; a < unique.length; a++) {
            var ac = actionColors[unique[a]] || '#6b7280';
            ctx.beginPath();
            ctx.arc(startX + a * 7, dotY, 2.5, 0, Math.PI * 2);
            ctx.fillStyle = ac;
            ctx.fill();
          }
        }
      }

      // X-axis date labels
      ctx.fillStyle = '#4b5563';
      ctx.font = '10px sans-serif';
      ctx.textAlign = 'left';
      if (data[0].date) ctx.fillText(new Date(data[0].date).toLocaleDateString(), pad.left, h - 4);
      ctx.textAlign = 'center';
      var midIdx = Math.floor(data.length / 2);
      if (data[midIdx] && data[midIdx].date && data.length > 4) ctx.fillText(new Date(data[midIdx].date).toLocaleDateString(), pts[midIdx].x, h - 4);
      ctx.textAlign = 'right';
      if (data[data.length - 1].date) ctx.fillText(new Date(data[data.length - 1].date).toLocaleDateString(), pad.left + plotW, h - 4);
    }

    // Tooltip on hover
    canvas.addEventListener('mousemove', function(e) {
      var rect = canvas.getBoundingClientRect();
      var mx = e.clientX - rect.left;
      var my = e.clientY - rect.top;
      var closest = null, minDist = 20;
      for (var i = 1; i < pointPositions.length; i++) {
        var p = pointPositions[i];
        var dist = Math.sqrt((p.x - mx) * (p.x - mx) + (p.y - my) * (p.y - my));
        if (dist < minDist) { minDist = dist; closest = p; }
      }
      if (closest) {
        var d = data[closest.idx];
        var pnlStr = (d.pnl >= 0 ? '+' : '') + '$' + (d.pnl || 0).toFixed(2);
        var pnlColor = d.pnl >= 0 ? '#10b981' : '#ef4444';
        var label = statusLabels[d.status] || d.status || '';
        var actStr = d.actions && d.actions.length > 0 ? d.actions.join(', ') : '';
        var html = '<strong>' + (d.symbol || '') + '</strong> ' + (d.direction || '') + '<br>';
        html += '<span style="color:' + pnlColor + '">' + pnlStr + '</span>';
        html += ' → $' + (d.equity || 0).toLocaleString();
        if (label) html += '<br>Exit: <span style="color:' + (statusColors[d.status] || '#6b7280') + '">' + label + '</span>';
        if (actStr) html += '<br>Actions: ' + actStr;
        if (d.drawdownPct > 0) html += '<br>DD: ' + d.drawdownPct + '%';
        tooltip.innerHTML = html;
        var tx = closest.x + 12, ty = closest.y - 10;
        if (tx + 160 > rect.width) tx = closest.x - 160;
        if (ty < 0) ty = closest.y + 12;
        tooltip.style.left = tx + 'px';
        tooltip.style.top = ty + 'px';
        tooltip.style.display = 'block';
      } else {
        tooltip.style.display = 'none';
      }
    });
    canvas.addEventListener('mouseleave', function() { tooltip.style.display = 'none'; });

    // Build legend
    var legend = document.getElementById('equity-legend');
    var last = data[data.length - 1];
    var legendHtml = '<span>Current: <strong style="color:#fff">$' + (last.equity || 0).toLocaleString() + '</strong></span>';
    legendHtml += '<span>Max DD: <strong style="color:#ef4444">' + (last.drawdownPct || 0) + '%</strong></span>';
    legendHtml += '<span style="display:inline-flex;align-items:center;gap:3px;"><span style="width:8px;height:8px;border-radius:50%;background:#10b981;display:inline-block;"></span>TP</span>';
    legendHtml += '<span style="display:inline-flex;align-items:center;gap:3px;"><span style="width:8px;height:8px;border-radius:50%;background:#ef4444;display:inline-block;"></span>SL</span>';
    legendHtml += '<span style="display:inline-flex;align-items:center;gap:3px;"><span style="width:8px;height:8px;border-radius:50%;background:#eab308;display:inline-block;"></span>Manual</span>';
    legendHtml += '<span style="display:inline-flex;align-items:center;gap:3px;"><span style="width:6px;height:6px;border-radius:50%;background:#3b82f6;display:inline-block;"></span>TS</span>';
    legendHtml += '<span style="display:inline-flex;align-items:center;gap:3px;"><span style="width:6px;height:6px;border-radius:50%;background:#a78bfa;display:inline-block;"></span>PP</span>';
    legendHtml += '<span style="display:inline-flex;align-items:center;gap:3px;"><span style="width:6px;height:6px;border-radius:50%;background:#38bdf8;display:inline-block;"></span>LOCK</span>';
    legend.innerHTML = legendHtml;

    // Initial draw + resize handler
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
  })();
  <% } %>
})();
</script>

<%- include('partials/footer') %>
