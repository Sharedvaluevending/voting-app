<%- include('partials/header') %>

<div class="section-header">
  <h2 style="color:#fff;font-size:22px;">Performance Dashboard</h2>
  <form action="/account/reset" method="POST" style="display:inline;">
    <button type="submit" class="btn btn-outline btn-sm" onclick="return confirm('Reset paper account to $10,000? All trade history will be deleted.')">Reset Account</button>
  </form>
</div>

<% if (typeof success !== 'undefined' && success) { %>
  <div class="alert alert-success" style="margin-bottom:12px;"><%= success %></div>
<% } %>
<% if (typeof error !== 'undefined' && error) { %>
  <div class="alert alert-error" style="margin-bottom:12px;"><%= error %></div>
<% } %>

<% if (typeof user !== 'undefined' && user) { %>
<div class="section" style="margin-bottom:24px;">
  <h3 style="color:#e5e7eb;margin-bottom:12px;">Trading settings</h3>
  <p style="font-size:13px;color:#9ca3af;margin-bottom:12px;">Limit how much of your balance each trade can use. Lower values = safer position sizing.</p>
  <form action="/account/settings" method="POST" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;align-items:end;max-width:700px;">
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Max balance per trade (%)</label>
      <input type="number" name="maxBalancePercentPerTrade" min="5" max="100" value="<%= (user.settings && user.settings.maxBalancePercentPerTrade) != null ? user.settings.maxBalancePercentPerTrade : 25 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Risk per trade (%)</label>
      <input type="number" name="riskPerTrade" min="0.5" max="10" step="0.5" value="<%= (user.settings && user.settings.riskPerTrade) != null ? user.settings.riskPerTrade : 2 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Max open trades</label>
      <input type="number" name="maxOpenTrades" min="1" max="10" value="<%= (user.settings && user.settings.maxOpenTrades) || 3 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Default leverage</label>
      <input type="number" name="defaultLeverage" min="1" max="20" value="<%= (user.settings && user.settings.defaultLeverage) || 1 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Cooldown (hours)</label>
      <input type="number" name="cooldownHours" min="0" max="168" title="Hours to wait before re-opening same direction on same coin" value="<%= (user.settings && user.settings.cooldownHours) != null ? user.settings.cooldownHours : 4 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <button type="submit" class="btn btn-outline btn-sm">Save</button>
    </div>
  </form>
</div>
<% } %>

<div class="perf-grid">
  <div class="perf-card">
    <div class="perf-label">Balance</div>
    <div class="perf-value">$<%= stats.balance.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Total P&L</div>
    <div class="perf-value <%= stats.totalPnl >= 0 ? 'up' : 'down' %>"><%= stats.totalPnl >= 0 ? '+' : '' %>$<%= stats.totalPnl.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Return</div>
    <div class="perf-value <%= parseFloat(stats.totalPnlPercent) >= 0 ? 'up' : 'down' %>"><%= stats.totalPnlPercent %>%</div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Win Rate</div>
    <div class="perf-value"><%= stats.winRate %>%</div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Total Trades</div>
    <div class="perf-value"><%= stats.totalTrades %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Wins / Losses</div>
    <div class="perf-value"><span class="up"><%= stats.wins %></span> / <span class="down"><%= stats.losses %></span></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Profit Factor</div>
    <div class="perf-value"><%= stats.profitFactor %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Avg Win</div>
    <div class="perf-value up">+$<%= stats.avgWin.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Avg Loss</div>
    <div class="perf-value down">-$<%= stats.avgLoss.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Best Trade</div>
    <div class="perf-value up">+$<%= stats.bestTrade.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Worst Trade</div>
    <div class="perf-value down">$<%= stats.worstTrade.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Streak</div>
    <div class="perf-value"><%= stats.currentStreak > 0 ? '+' : '' %><%= stats.currentStreak %> (best: <%= stats.bestStreak %>)</div>
  </div>
  <div class="perf-card">
    <div class="perf-label">7-Day P&L</div>
    <div class="perf-value <%= stats.pnl7d >= 0 ? 'up' : 'down' %>"><%= stats.pnl7d >= 0 ? '+' : '' %>$<%= stats.pnl7d.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Open Trades</div>
    <div class="perf-value"><%= stats.openTrades %></div>
  </div>
</div>

<% if (Object.keys(stats.byStrategy).length > 0) { %>
<div class="section">
  <h3>By Strategy</h3>
  <table class="data-table">
    <thead><tr><th>Strategy</th><th>Wins</th><th>Losses</th><th>Win Rate</th><th>P&L</th></tr></thead>
    <tbody>
      <% Object.entries(stats.byStrategy).forEach(function([name, data]) {
        var total = data.wins + data.losses;
        var wr = total > 0 ? ((data.wins/total)*100).toFixed(1) : '0';
      %>
        <tr>
          <td><%= name %></td>
          <td class="up"><%= data.wins %></td>
          <td class="down"><%= data.losses %></td>
          <td><%= wr %>%</td>
          <td class="<%= data.pnl >= 0 ? 'up' : 'down' %>"><%= data.pnl >= 0 ? '+' : '' %>$<%= data.pnl.toFixed(2) %></td>
        </tr>
      <% }); %>
    </tbody>
  </table>
</div>
<% } %>

<% if (Object.keys(stats.byCoin).length > 0) { %>
<div class="section">
  <h3>By Coin</h3>
  <table class="data-table">
    <thead><tr><th>Coin</th><th>Wins</th><th>Losses</th><th>Win Rate</th><th>P&L</th></tr></thead>
    <tbody>
      <% Object.entries(stats.byCoin).forEach(function([name, data]) {
        var total = data.wins + data.losses;
        var wr = total > 0 ? ((data.wins/total)*100).toFixed(1) : '0';
      %>
        <tr>
          <td style="font-weight:700;"><%= name %></td>
          <td class="up"><%= data.wins %></td>
          <td class="down"><%= data.losses %></td>
          <td><%= wr %>%</td>
          <td class="<%= data.pnl >= 0 ? 'up' : 'down' %>"><%= data.pnl >= 0 ? '+' : '' %>$<%= data.pnl.toFixed(2) %></td>
        </tr>
      <% }); %>
    </tbody>
  </table>
</div>
<% } %>

<%- include('partials/footer') %>
