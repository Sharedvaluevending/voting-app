<%- include('partials/header') %>

<div class="section-header">
  <h2 style="color:#fff;font-size:22px;">Performance Dashboard</h2>
  <form action="/account/reset" method="POST" style="display:inline;">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <input type="hidden" name="confirm" value="RESET">
    <button type="submit" class="btn btn-outline btn-sm" onclick="return confirm('Reset paper account to $10,000? All trade history will be deleted.')">Reset Account</button>
  </form>
</div>

<% if (typeof success !== 'undefined' && success) { %>
  <div class="alert alert-success" style="margin-bottom:12px;"><%= success %></div>
<% } %>
<% if (typeof error !== 'undefined' && error) { %>
  <div class="alert alert-error" style="margin-bottom:12px;"><%= error %></div>
<% } %>

<% if (typeof user !== 'undefined' && user) { %>

<!-- Live Trading Status -->
<div style="background:#111827;border:1px solid #1e2a3a;border-radius:12px;padding:16px 20px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;">
  <div style="display:flex;align-items:center;gap:12px;">
    <div style="width:10px;height:10px;border-radius:50%;background:<%= user.liveTrading && user.liveTrading.enabled ? '#10b981' : '#6b7280' %>;"></div>
    <div>
      <span style="color:#e5e7eb;font-weight:600;font-size:14px;">Live Trading:</span>
      <span style="color:<%= user.liveTrading && user.liveTrading.enabled ? '#10b981' : '#9ca3af' %>;font-weight:600;font-size:14px;margin-left:6px;">
        <%= user.liveTrading && user.liveTrading.enabled ? 'ACTIVE' : 'OFF' %>
      </span>
      <% if (user.liveTrading && user.liveTrading.enabled) { %>
        <span style="color:#6b7280;font-size:12px;margin-left:8px;">
          (<%= user.liveTrading.mode === 'auto' ? 'Auto' : 'Manual' %> · <%= (user.liveTrading.tradingType || 'futures').charAt(0).toUpperCase() + (user.liveTrading.tradingType || 'futures').slice(1) %> · <%= user.liveTrading.liveLeverage || 1 %>x)
        </span>
      <% } %>
    </div>
  </div>
  <a href="/exchange" class="btn btn-outline btn-sm" style="<%= user.liveTrading && user.liveTrading.enabled ? 'border-color:#10b981;color:#10b981;' : '' %>">
    <%= user.bitget && user.bitget.connected ? 'Exchange Settings' : 'Connect Exchange' %>
  </a>
</div>

<div class="section" style="margin-bottom:24px;">
  <h3 style="color:#e5e7eb;margin-bottom:12px;">Paper Trading Balance</h3>
  <p style="font-size:13px;color:#9ca3af;margin-bottom:12px;">Set your starting paper trading balance. This resets your balance and initial balance (does not clear trade history).</p>
  <form action="/account/set-balance" method="POST" style="display:flex;gap:12px;align-items:end;max-width:400px;margin-bottom:24px;">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <div style="flex:1;">
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Paper balance ($)</label>
      <input type="number" name="paperBalance" min="100" max="1000000" step="100" value="<%= user.paperBalance != null ? Math.round(user.paperBalance) : 10000 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <button type="submit" class="btn btn-outline btn-sm" onclick="return confirm('This will reset your paper balance to the entered amount. Continue?')">Set Balance</button>
  </form>

  <h3 style="color:#e5e7eb;margin-bottom:12px;">Trading settings</h3>
  <p style="font-size:13px;color:#9ca3af;margin-bottom:12px;">Limit how much of your balance each trade can use. Lower values = safer position sizing.</p>
  <form action="/account/settings" method="POST" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;align-items:end;max-width:700px;">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Max balance per trade (%)</label>
      <input type="number" name="maxBalancePercentPerTrade" min="5" max="100" value="<%= (user.settings && user.settings.maxBalancePercentPerTrade) != null ? user.settings.maxBalancePercentPerTrade : 25 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Risk per trade (%)</label>
      <input type="number" name="riskPerTrade" min="0.5" max="10" step="0.5" value="<%= (user.settings && user.settings.riskPerTrade) != null ? user.settings.riskPerTrade : 2 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Max open trades</label>
      <input type="number" name="maxOpenTrades" min="1" max="10" value="<%= (user.settings && user.settings.maxOpenTrades) || 3 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Default leverage</label>
      <input type="number" name="defaultLeverage" min="1" max="20" value="<%= (user.settings && user.settings.defaultLeverage) || 1 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Cooldown (hours)</label>
      <input type="number" name="cooldownHours" min="0" max="168" title="Hours to wait before re-opening same direction on same coin" value="<%= (user.settings && user.settings.cooldownHours) != null ? user.settings.cooldownHours : 4 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div style="display:flex;align-items:center;gap:8px;" title="Let the app automatically open trades based on signals. Uses best strategy score for each coin.">
      <input type="hidden" name="autoTrade" value="false">
      <input type="checkbox" name="autoTrade" id="autoTrade" value="true" <%= (user.settings && user.settings.autoTrade) ? 'checked' : '' %>>
      <label for="autoTrade" style="font-size:12px;color:#9ca3af;">Auto trade (app opens trades from signals)</label>
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Auto trade min score</label>
      <input type="number" name="autoTradeMinScore" min="30" max="95" value="<%= (user.settings && user.settings.autoTradeMinScore) != null ? user.settings.autoTradeMinScore : 70 %>" title="Only auto-open trades when best strategy score >= this value" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div style="display:flex;align-items:center;gap:8px;" title="Force all trades to 1x leverage (no leverage). Overrides default leverage setting.">
      <input type="hidden" name="disableLeverage" value="false">
      <input type="checkbox" name="disableLeverage" id="disableLeverage" value="true" <%= (user.settings && user.settings.disableLeverage) ? 'checked' : '' %>>
      <label for="disableLeverage" style="font-size:12px;color:#9ca3af;">Disable leverage (force 1x on all trades)</label>
    </div>
    <div style="display:flex;align-items:center;gap:8px;" title="When score check suggests Tighten stop, Reduce position, Take partial, or Consider exit — execute it automatically">
      <input type="hidden" name="autoExecuteActions" value="false">
      <input type="checkbox" name="autoExecuteActions" id="autoExecuteActions" value="true" <%= (user.settings && user.settings.autoExecuteActions) ? 'checked' : '' %>>
      <label for="autoExecuteActions" style="font-size:12px;color:#9ca3af;">Auto-execute score check actions</label>
    </div>
    <div style="display:flex;align-items:center;gap:8px;" title="Move stop to breakeven when price reaches 1R in profit">
      <input type="hidden" name="autoMoveBreakeven" value="false">
      <input type="checkbox" name="autoMoveBreakeven" id="autoMoveBreakeven" value="true" <%= (user.settings && user.settings.autoMoveBreakeven) !== false ? 'checked' : '' %>>
      <label for="autoMoveBreakeven" style="font-size:12px;color:#9ca3af;">Auto move to breakeven</label>
    </div>
    <div style="display:flex;align-items:center;gap:8px;" title="Trail stop at 1.5R when price reaches 1R in profit">
      <input type="hidden" name="autoTrailingStop" value="false">
      <input type="checkbox" name="autoTrailingStop" id="autoTrailingStop" value="true" <%= (user.settings && user.settings.autoTrailingStop) !== false ? 'checked' : '' %>>
      <label for="autoTrailingStop" style="font-size:12px;color:#9ca3af;">Auto trailing stop</label>
    </div>
    <div>
      <button type="submit" class="btn btn-outline btn-sm">Save</button>
    </div>
  </form>
</div>
<% } %>

<!-- Position Sizing Calculator -->
<div class="section" style="margin-bottom:24px;">
  <h3 style="color:#e5e7eb;margin-bottom:12px;">Position Sizing Calculator</h3>
  <p style="font-size:13px;color:#9ca3af;margin-bottom:12px;">Enter your trade parameters to see risk amount and recommended position size.</p>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;align-items:end;max-width:900px;">
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Account balance ($)</label>
      <input type="number" id="calc-balance" min="100" step="100" value="<%= stats.balance %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Risk per trade (%)</label>
      <input type="number" id="calc-risk" min="0.5" max="10" step="0.5" value="2" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Entry price ($)</label>
      <input type="number" id="calc-entry" min="0.0001" step="0.01" value="1" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Stop loss ($)</label>
      <input type="number" id="calc-sl" min="0" step="0.01" value="0.98" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Leverage</label>
      <input type="number" id="calc-lev" min="1" max="20" value="1" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
  </div>
  <div id="calc-result" style="margin-top:14px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
    <span style="font-size:13px;color:#9ca3af;">Risk amount: <strong id="calc-risk-amt" style="color:#eab308;">$0</strong></span>
    <span style="font-size:13px;color:#9ca3af;">Position size: <strong id="calc-pos" style="color:#10b981;">$0</strong></span>
    <span style="font-size:13px;color:#9ca3af;">Margin needed: <strong id="calc-margin" style="color:#3b82f6;">$0</strong></span>
    <span style="font-size:11px;color:#6b7280;">(Stop distance: <span id="calc-stop-pct">0</span>%)</span>
  </div>
</div>

<div class="perf-grid">
  <div class="perf-card">
    <div class="perf-label">Balance</div>
    <div class="perf-value">$<%= stats.balance.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Total P&L</div>
    <div class="perf-value <%= stats.totalPnl >= 0 ? 'up' : 'down' %>"><%= stats.totalPnl >= 0 ? '+' : '' %>$<%= stats.totalPnl.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Return</div>
    <div class="perf-value <%= parseFloat(stats.totalPnlPercent) >= 0 ? 'up' : 'down' %>"><%= stats.totalPnlPercent %>%</div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Win Rate</div>
    <div class="perf-value"><%= stats.winRate %>%</div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Total Trades</div>
    <div class="perf-value"><%= stats.totalTrades %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Wins / Losses</div>
    <div class="perf-value"><span class="up"><%= stats.wins %></span> / <span class="down"><%= stats.losses %></span></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Profit Factor</div>
    <div class="perf-value"><%= stats.profitFactor %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Avg Win</div>
    <div class="perf-value up">+$<%= stats.avgWin.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Avg Loss</div>
    <div class="perf-value down">-$<%= stats.avgLoss.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Best Trade</div>
    <div class="perf-value up">+$<%= stats.bestTrade.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Worst Trade</div>
    <div class="perf-value down">$<%= stats.worstTrade.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Streak</div>
    <div class="perf-value"><%= stats.currentStreak > 0 ? '+' : '' %><%= stats.currentStreak %> (best: <%= stats.bestStreak %>)</div>
  </div>
  <div class="perf-card">
    <div class="perf-label">7-Day P&L</div>
    <div class="perf-value <%= stats.pnl7d >= 0 ? 'up' : 'down' %>"><%= stats.pnl7d >= 0 ? '+' : '' %>$<%= stats.pnl7d.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Open Trades</div>
    <div class="perf-value"><%= stats.openTrades %></div>
  </div>
  <% if (stats.sharpe != null) { %>
  <div class="perf-card">
    <div class="perf-label">Sharpe Ratio</div>
    <div class="perf-value <%= stats.sharpe >= 0 ? 'up' : 'down' %>"><%= stats.sharpe %></div>
  </div>
  <% } %>
  <% if (stats.sortino != null) { %>
  <div class="perf-card">
    <div class="perf-label">Sortino Ratio</div>
    <div class="perf-value <%= stats.sortino >= 0 ? 'up' : 'down' %>"><%= stats.sortino %></div>
  </div>
  <% } %>
  <div class="perf-card">
    <div class="perf-label">Max Drawdown</div>
    <div class="perf-value down">$<%= (stats.maxDrawdown || 0).toFixed(2) %> (<%= (stats.maxDrawdownPct || 0) %>% of peak)</div>
  </div>
</div>

<% if (stats.equityCurve && stats.equityCurve.length > 1) { %>
<div class="section">
  <h3>Equity Curve</h3>
  <p style="font-size:12px;color:#6b7280;margin-bottom:10px;">Account balance over time. Drawdown shaded in red.</p>
  <div class="equity-chart-wrap" style="position:relative;background:#0d1320;border-radius:8px;padding:12px;border:1px solid #1e2a3a;overflow:hidden;">
    <canvas id="equity-curve" style="width:100%;height:260px;display:block;"></canvas>
    <div id="equity-legend" style="font-size:11px;color:#6b7280;margin-top:8px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;"></div>
  </div>
</div>
<% } %>

<% if (Object.keys(stats.byStrategy).length > 0) { %>
<div class="section">
  <h3>By Strategy</h3>
  <table class="data-table">
    <thead><tr><th>Strategy</th><th>Wins</th><th>Losses</th><th>Win Rate</th><th>P&L</th></tr></thead>
    <tbody>
      <% Object.entries(stats.byStrategy).forEach(function([name, data]) {
        var total = data.wins + data.losses;
        var wr = total > 0 ? ((data.wins/total)*100).toFixed(1) : '0';
      %>
        <tr>
          <td><%= name %></td>
          <td class="up"><%= data.wins %></td>
          <td class="down"><%= data.losses %></td>
          <td><%= wr %>%</td>
          <td class="<%= data.pnl >= 0 ? 'up' : 'down' %>"><%= data.pnl >= 0 ? '+' : '' %>$<%= data.pnl.toFixed(2) %></td>
        </tr>
      <% }); %>
    </tbody>
  </table>
</div>
<% } %>

<% if (Object.keys(stats.byCoin).length > 0) { %>
<div class="section">
  <h3>By Coin</h3>
  <table class="data-table">
    <thead><tr><th>Coin</th><th>Wins</th><th>Losses</th><th>Win Rate</th><th>P&L</th></tr></thead>
    <tbody>
      <% Object.entries(stats.byCoin).forEach(function([name, data]) {
        var total = data.wins + data.losses;
        var wr = total > 0 ? ((data.wins/total)*100).toFixed(1) : '0';
      %>
        <tr>
          <td style="font-weight:700;"><%= name %></td>
          <td class="up"><%= data.wins %></td>
          <td class="down"><%= data.losses %></td>
          <td><%= wr %>%</td>
          <td class="<%= data.pnl >= 0 ? 'up' : 'down' %>"><%= data.pnl >= 0 ? '+' : '' %>$<%= data.pnl.toFixed(2) %></td>
        </tr>
      <% }); %>
    </tbody>
  </table>
</div>
<% } %>

<script>
(function() {
  var calcInputs = ['calc-balance','calc-risk','calc-entry','calc-sl','calc-lev'];
  function updateCalc() {
    var bal = parseFloat(document.getElementById('calc-balance').value) || 10000;
    var risk = parseFloat(document.getElementById('calc-risk').value) || 2;
    var entry = parseFloat(document.getElementById('calc-entry').value) || 1;
    var sl = parseFloat(document.getElementById('calc-sl').value) || 0.98;
    var lev = parseFloat(document.getElementById('calc-lev').value) || 1;
    var riskAmt = bal * (risk / 100);
    var stopDist = entry > 0 ? Math.abs(entry - sl) / entry : 0.02;
    if (stopDist <= 0) stopDist = 0.02;
    var posSize = (riskAmt / stopDist) * lev;
    var capped = Math.min(posSize, bal * lev * 0.95);
    var margin = capped / lev;
    document.getElementById('calc-risk-amt').textContent = '$' + riskAmt.toFixed(2);
    document.getElementById('calc-pos').textContent = '$' + capped.toFixed(2);
    document.getElementById('calc-margin').textContent = '$' + margin.toFixed(2);
    document.getElementById('calc-stop-pct').textContent = (stopDist * 100).toFixed(2);
  }
  calcInputs.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.addEventListener('input', updateCalc);
  });
  updateCalc();

  <% if (stats.equityCurve && stats.equityCurve.length > 1) { %>
  (function() {
    var data = <%- JSON.stringify(stats.equityCurve) %>;
    var canvas = document.getElementById('equity-curve');
    if (!canvas || !data || data.length < 2) return;
    var ctx = canvas.getContext('2d');

    // Responsive: set canvas pixel size from CSS layout size
    var dpr = window.devicePixelRatio || 1;
    function resizeCanvas() {
      var rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      drawChart();
    }

    function drawChart() {
      var rect = canvas.getBoundingClientRect();
      var w = rect.width, h = rect.height;
      var pad = { top: 14, right: 14, bottom: 28, left: 54 };
      var plotW = w - pad.left - pad.right, plotH = h - pad.top - pad.bottom;
      var eq = data.map(function(d) { return d.equity; });
      var minE = Math.min.apply(null, eq);
      var maxE = Math.max.apply(null, eq);
      var range = maxE - minE || 1;
      minE = Math.max(0, minE - range * 0.08);
      maxE = maxE + range * 0.08;
      range = maxE - minE || 1;

      ctx.clearRect(0, 0, w, h);

      // Grid lines
      ctx.strokeStyle = '#1e2a3a';
      ctx.lineWidth = 0.5;
      for (var g = 0; g <= 4; g++) {
        var gy = pad.top + (plotH * g / 4);
        ctx.beginPath();
        ctx.moveTo(pad.left, gy);
        ctx.lineTo(pad.left + plotW, gy);
        ctx.stroke();
        ctx.fillStyle = '#4b5563';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText('$' + Math.round(maxE - (range * g / 4)).toLocaleString(), pad.left - 4, gy + 3);
      }

      // Compute XY for each data point
      var pts = [];
      for (var i = 0; i < data.length; i++) {
        var x = pad.left + (i / (data.length - 1)) * plotW;
        var y = pad.top + plotH - ((data[i].equity - minE) / range) * plotH;
        pts.push({ x: x, y: y });
      }

      // Drawdown shading (red fill between peak line and equity when in drawdown)
      var peak = data[0].equity;
      ctx.beginPath();
      var inDrawdown = false;
      for (var i = 0; i < data.length; i++) {
        if (data[i].equity > peak) peak = data[i].equity;
        var peakY = pad.top + plotH - ((peak - minE) / range) * plotH;
        if (data[i].drawdown > 0) {
          if (!inDrawdown) {
            ctx.moveTo(pts[i].x, peakY);
            inDrawdown = true;
          }
          ctx.lineTo(pts[i].x, pts[i].y);
        } else {
          if (inDrawdown) {
            ctx.lineTo(pts[i].x, peakY);
            ctx.closePath();
            inDrawdown = false;
          }
          ctx.moveTo(pts[i].x, pts[i].y);
        }
      }
      if (inDrawdown) {
        var lastPeakY = pad.top + plotH - ((peak - minE) / range) * plotH;
        ctx.lineTo(pts[data.length - 1].x, lastPeakY);
        ctx.closePath();
      }
      ctx.fillStyle = 'rgba(239,68,68,0.12)';
      ctx.fill();

      // Equity line
      ctx.beginPath();
      for (var i = 0; i < pts.length; i++) {
        if (i === 0) ctx.moveTo(pts[i].x, pts[i].y);
        else ctx.lineTo(pts[i].x, pts[i].y);
      }
      ctx.strokeStyle = '#10b981';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Fill under equity line
      ctx.lineTo(pts[pts.length - 1].x, pad.top + plotH);
      ctx.lineTo(pts[0].x, pad.top + plotH);
      ctx.closePath();
      ctx.fillStyle = 'rgba(16,185,129,0.1)';
      ctx.fill();

      // X-axis date labels
      ctx.fillStyle = '#4b5563';
      ctx.font = '10px sans-serif';
      ctx.textAlign = 'left';
      if (data[0].date) ctx.fillText(new Date(data[0].date).toLocaleDateString(), pad.left, h - 4);
      ctx.textAlign = 'center';
      var midIdx = Math.floor(data.length / 2);
      if (data[midIdx] && data[midIdx].date && data.length > 4) ctx.fillText(new Date(data[midIdx].date).toLocaleDateString(), pts[midIdx].x, h - 4);
      ctx.textAlign = 'right';
      if (data[data.length - 1].date) ctx.fillText(new Date(data[data.length - 1].date).toLocaleDateString(), pad.left + plotW, h - 4);
    }

    // Build legend (clean — just current equity and max drawdown)
    var legend = document.getElementById('equity-legend');
    var last = data[data.length - 1];
    var legendHtml = '<span>Current: <strong style="color:#fff">$' + (last.equity || 0).toLocaleString() + '</strong></span>';
    legendHtml += '<span>Max DD: <strong style="color:#ef4444">' + (last.drawdownPct || 0) + '%</strong></span>';
    legend.innerHTML = legendHtml;

    // Initial draw + resize handler
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
  })();
  <% } %>
})();
</script>

<%- include('partials/footer') %>
