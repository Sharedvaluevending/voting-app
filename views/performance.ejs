<%- include('partials/header') %>

<div class="section-header">
  <h2 style="color:#fff;font-size:22px;">Performance Dashboard</h2>
  <div style="display:flex;gap:8px;align-items:center;">
    <form action="/account/reset" method="POST" style="display:inline;">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <input type="hidden" name="confirm" value="RESET">
      <button type="submit" class="btn btn-outline btn-sm" onclick="return confirm('Reset paper account to $10,000? All trade history will be deleted.')">Reset Account</button>
    </form>
    <form action="/account/delete" method="POST" style="display:inline;">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <input type="hidden" name="confirm" value="DELETE">
      <button type="submit" class="btn btn-outline btn-sm" style="border-color:#ef4444;color:#ef4444;" onclick="return prompt('Type DELETE to permanently delete your account and all data:')==='DELETE';">Delete Account</button>
    </form>
  </div>
</div>

<div class="section" style="margin-bottom:20px;border:1px solid rgba(245,158,11,0.4);border-radius:8px;padding:12px 16px;background:rgba(245,158,11,0.08);">
  <h3 style="color:#f59e0b;font-size:14px;margin:0 0 8px 0;">Full Platform Reset</h3>
  <p style="font-size:12px;color:#9ca3af;margin:0 0 10px 0;">Wipes all trades, journals, user stats, and learning engine. Keeps your account (login, Bitget). Type <strong>RESET PLATFORM</strong> to confirm.</p>
  <form action="/account/full-platform-reset" method="POST" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <input type="text" name="confirm" placeholder="RESET PLATFORM" autocomplete="off" style="width:180px;padding:6px 10px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;font-size:13px;">
    <button type="submit" class="btn btn-outline btn-sm" style="border-color:#f59e0b;color:#f59e0b;">Full Reset</button>
  </form>
</div>

<% if (typeof success !== 'undefined' && success) { %>
  <div class="alert alert-success" style="margin-bottom:12px;"><%= success %></div>
<% } %>
<% if (typeof error !== 'undefined' && error) { %>
  <div class="alert alert-error" style="margin-bottom:12px;"><%= error %></div>
<% } %>

<% if (typeof user !== 'undefined' && user) { %>

<!-- Live Trading Status -->
<div style="background:#111827;border:1px solid #1e2a3a;border-radius:12px;padding:16px 20px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;">
  <div style="display:flex;align-items:center;gap:12px;">
    <div style="width:10px;height:10px;border-radius:50%;background:<%= user.liveTrading && user.liveTrading.enabled ? '#10b981' : '#6b7280' %>;"></div>
    <div>
      <span style="color:#e5e7eb;font-weight:600;font-size:14px;">Live Trading:</span>
      <span style="color:<%= user.liveTrading && user.liveTrading.enabled ? '#10b981' : '#9ca3af' %>;font-weight:600;font-size:14px;margin-left:6px;">
        <%= user.liveTrading && user.liveTrading.enabled ? 'ACTIVE' : 'OFF' %>
      </span>
      <% if (user.liveTrading && user.liveTrading.enabled) { %>
        <span style="color:#6b7280;font-size:12px;margin-left:8px;">
          (<%= user.liveTrading.mode === 'auto' ? 'Auto' : 'Manual' %> · <%= (user.liveTrading.tradingType || 'futures').charAt(0).toUpperCase() + (user.liveTrading.tradingType || 'futures').slice(1) %> · <%= (user.liveTrading && user.liveTrading.liveLeverage) != null ? user.liveTrading.liveLeverage : 2 %>x)
        </span>
      <% } %>
    </div>
  </div>
  <a href="/exchange" class="btn btn-outline btn-sm" style="<%= user.liveTrading && user.liveTrading.enabled ? 'border-color:#10b981;color:#10b981;' : '' %>">
    <%= user.bitget && user.bitget.connected ? 'Exchange Settings' : 'Connect Exchange' %>
  </a>
</div>

<div class="section" style="margin-bottom:24px;">
  <h3 style="color:#e5e7eb;margin-bottom:12px;">Paper Trading Balance</h3>
  <p style="font-size:13px;color:#9ca3af;margin-bottom:12px;">Set your starting paper trading balance. This resets your balance and initial balance (does not clear trade history).</p>
  <div style="display:flex;gap:12px;align-items:end;flex-wrap:wrap;margin-bottom:12px;">
    <form action="/account/set-balance" method="POST" style="display:flex;gap:12px;align-items:end;">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <div>
        <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Paper balance ($)</label>
        <input type="number" name="paperBalance" min="100" max="1000000" step="100" value="<%= user.paperBalance != null ? Math.round(user.paperBalance) : 10000 %>" style="width:140px;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
      </div>
      <button type="submit" class="btn btn-outline btn-sm" onclick="return confirm('This will reset your paper balance to the entered amount. Continue?')">Set Balance</button>
    </form>
    <% if (user.bitget && user.bitget.connected) { %>
    <form action="/account/sync-balance-from-bitget" method="POST" style="display:inline;">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <button type="submit" class="btn btn-outline btn-sm" style="border-color:#10b981;color:#10b981;" onclick="return confirm('Sync paper balance from your Bitget account? This will set paper balance = Bitget Futures Available (or Spot if you trade spot).')">Sync from Bitget</button>
    </form>
    <% } %>
  </div>
  <% if (user.bitget && user.bitget.connected) { %>
  <div id="bitget-balance-perf" style="margin-top:8px;font-size:13px;color:#9ca3af;">
    <span style="color:#6b7280;">Bitget balance:</span> <span id="bitget-balance-val">Loading...</span>
    <a href="/exchange" style="margin-left:8px;color:#3b82f6;font-size:12px;">View on Exchange</a>
  </div>
  <% } %>

  <h3 style="color:#e5e7eb;margin-bottom:12px;">Trading Settings</h3>
  <form action="/account/settings" method="POST">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">

    <!-- 1. Position Sizing -->
    <div style="margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid #1e2a3a;">
      <h4 style="color:#9ca3af;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin:0 0 10px 0;">Position Sizing</h4>
      <p style="font-size:12px;color:#6b7280;margin:0 0 12px 0;">How much of your balance each trade can use. Lower = safer.</p>
      <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px;">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
          <input type="radio" name="riskMode" value="percent" <%= (user.settings && user.settings.riskMode) !== 'dollar' ? 'checked' : '' %>>
          <span style="font-size:12px;color:#9ca3af;">Risk % of balance</span>
        </label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
          <input type="radio" name="riskMode" value="dollar" <%= (user.settings && user.settings.riskMode) === 'dollar' ? 'checked' : '' %>>
          <span style="font-size:12px;color:#9ca3af;">Fixed $ per trade</span>
        </label>
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;align-items:end;">
        <div id="risk-percent-wrap" style="<%= (user.settings && user.settings.riskMode) === 'dollar' ? 'display:none;' : '' %>">
          <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Risk per trade (%)</label>
          <input type="number" name="riskPerTrade" min="0.5" max="10" step="0.5" value="<%= (user.settings && user.settings.riskPerTrade) != null ? user.settings.riskPerTrade : 2 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
        </div>
        <div id="risk-dollar-wrap" style="<%= (user.settings && user.settings.riskMode) !== 'dollar' ? 'display:none;' : '' %>">
          <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Risk per trade ($)</label>
          <input type="number" name="riskDollarsPerTrade" min="10" max="10000" step="10" value="<%= (user.settings && user.settings.riskDollarsPerTrade) != null ? user.settings.riskDollarsPerTrade : 200 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
        </div>
        <div>
          <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Max balance per trade (%)</label>
          <input type="number" name="maxBalancePercentPerTrade" min="5" max="100" value="<%= (user.settings && user.settings.maxBalancePercentPerTrade) != null ? user.settings.maxBalancePercentPerTrade : 25 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
        </div>
        <div>
          <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Max open trades</label>
          <input type="number" name="maxOpenTrades" min="1" max="10" value="<%= (user.settings && user.settings.maxOpenTrades) || 3 %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
        </div>
      </div>
      <script>
        (function() {
          var radios = document.querySelectorAll('input[name="riskMode"]');
          var pctWrap = document.getElementById('risk-percent-wrap');
          var dolWrap = document.getElementById('risk-dollar-wrap');
          radios.forEach(function(r) {
            r.addEventListener('change', function() {
              if (this.value === 'percent') { pctWrap.style.display = ''; dolWrap.style.display = 'none'; dolWrap.querySelector('input').disabled = true; pctWrap.querySelector('input').disabled = false; }
              else { pctWrap.style.display = 'none'; dolWrap.style.display = ''; pctWrap.querySelector('input').disabled = true; dolWrap.querySelector('input').disabled = false; }
            });
          });
          if (document.querySelector('input[name="riskMode"]:checked')?.value === 'dollar') {
            pctWrap.querySelector('input').disabled = true;
            dolWrap.querySelector('input').disabled = false;
          } else {
            dolWrap.querySelector('input').disabled = true;
          }
        })();
      </script>
    </div>

    <!-- 2. Leverage -->
    <div style="margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid #1e2a3a;">
      <h4 style="color:#9ca3af;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin:0 0 10px 0;">Leverage</h4>
      <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:center;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;" title="Force 1x on all trades (no leverage)">
          <input type="hidden" name="disableLeverage" value="false">
          <input type="checkbox" name="disableLeverage" id="disableLeverage" value="true" <%= (user.settings && user.settings.disableLeverage) ? 'checked' : '' %>>
          <span style="font-size:12px;color:#9ca3af;">Disable leverage (1x only)</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;" title="Use fixed leverage instead of signal-suggested">
          <input type="hidden" name="useFixedLeverage" value="false">
          <input type="checkbox" name="useFixedLeverage" id="useFixedLeverage" value="true" <%= (user.settings && user.settings.useFixedLeverage) ? 'checked' : '' %>>
          <span style="font-size:12px;color:#9ca3af;">Use fixed leverage</span>
        </label>
        <div style="display:flex;align-items:center;gap:8px;">
          <label style="font-size:12px;color:#9ca3af;">Fixed leverage:</label>
          <input type="number" name="defaultLeverage" min="1" max="20" value="<%= (user.settings && user.settings.defaultLeverage) != null ? user.settings.defaultLeverage : 2 %>" title="Paper trades. Set Live Leverage on Exchange page for Bitget." style="width:70px;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
        </div>
      </div>
    </div>

    <!-- 3. Auto-Trade -->
    <div style="margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid #1e2a3a;">
      <h4 style="color:#9ca3af;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin:0 0 10px 0;">Auto-Trade</h4>
      <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:end;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="hidden" name="autoTrade" value="false">
          <input type="checkbox" name="autoTrade" id="autoTrade" value="true" <%= (user.settings && user.settings.autoTrade) ? 'checked' : '' %>>
          <span style="font-size:12px;color:#9ca3af;">Auto-open trades from signals</span>
        </label>
        <div>
          <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Min score</label>
          <input type="number" name="autoTradeMinScore" min="30" max="95" value="<%= (user.settings && user.settings.autoTradeMinScore) != null ? user.settings.autoTradeMinScore : 52 %>" title="Only auto-open when score >= this" style="width:70px;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
        </div>
        <div>
          <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Cooldown (hours)</label>
          <input type="number" name="cooldownHours" min="0" max="168" title="Wait before re-opening same coin/direction" value="<%= (user.settings && user.settings.cooldownHours) != null ? user.settings.cooldownHours : 4 %>" style="width:70px;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
        </div>
      </div>
    </div>

    <!-- 4. Position Management (in-trade) -->
    <div style="margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid #1e2a3a;">
      <h4 style="color:#9ca3af;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin:0 0 10px 0;">Position Management</h4>
      <p style="font-size:12px;color:#6b7280;margin:0 0 10px 0;">Automatic stop adjustments while a trade is open. Breakeven and trailing stop are in Feature Toggles below.</p>
      <div style="display:flex;flex-wrap:wrap;gap:12px;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;" title="Auto-execute score check suggestions (reduce, exit, etc.)">
          <input type="hidden" name="autoExecuteActions" value="false">
          <input type="checkbox" name="autoExecuteActions" id="autoExecuteActions" value="true" <%= (user.settings && user.settings.autoExecuteActions) ? 'checked' : '' %>>
          <span style="font-size:12px;color:#9ca3af;">Auto-execute score actions</span>
        </label>
        <div style="display:flex;align-items:center;gap:12px;">
          <div>
            <label style="display:block;font-size:11px;color:#6b7280;margin-bottom:2px;">Score grace (min)</label>
            <input type="number" name="scoreCheckGraceMinutes" min="0" max="60" value="<%= (user.settings && user.settings.scoreCheckGraceMinutes) != null ? user.settings.scoreCheckGraceMinutes : 10 %>" style="width:60px;padding:6px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
          </div>
          <div>
            <label style="display:block;font-size:11px;color:#6b7280;margin-bottom:2px;">Stop grace (min)</label>
            <input type="number" name="stopCheckGraceMinutes" min="0" max="30" value="<%= (user.settings && user.settings.stopCheckGraceMinutes) != null ? user.settings.stopCheckGraceMinutes : 2 %>" style="width:60px;padding:6px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
          </div>
        </div>
      </div>
    </div>

    <!-- 5. Sync & Fees -->
    <div style="margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid #1e2a3a;">
      <h4 style="color:#9ca3af;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin:0 0 10px 0;">Sync & Fees</h4>
      <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:end;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;" title="Mirror paper trades to Bitget when connected">
          <input type="hidden" name="paperLiveSync" value="false">
          <input type="checkbox" name="paperLiveSync" id="paperLiveSync" value="true" <%= (user.settings && user.settings.paperLiveSync) !== false ? 'checked' : '' %>>
          <span style="font-size:12px;color:#9ca3af;">Paper/Live sync</span>
        </label>
        <div>
          <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Maker fee (%)</label>
          <input type="number" name="makerFeePercent" min="0" max="1" step="0.01" value="<%= (user.settings && user.settings.makerFeePercent) != null ? user.settings.makerFeePercent : 0.1 %>" style="width:80px;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
        </div>
        <div>
          <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Taker fee (%)</label>
          <input type="number" name="takerFeePercent" min="0" max="1" step="0.01" value="<%= (user.settings && user.settings.takerFeePercent) != null ? user.settings.takerFeePercent : 0.1 %>" style="width:80px;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
        </div>
      </div>
    </div>

    <!-- 6. Notifications -->
    <div style="margin-bottom:16px;">
      <h4 style="color:#9ca3af;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin:0 0 10px 0;">Notifications</h4>
      <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="hidden" name="notifyTradeOpen" value="false">
          <input type="checkbox" name="notifyTradeOpen" id="notifyTradeOpen" value="true" <%= (user.settings && user.settings.notifyTradeOpen) !== false ? 'checked' : '' %>>
          <span style="font-size:12px;color:#9ca3af;">On trade open</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="hidden" name="notifyTradeClose" value="false">
          <input type="checkbox" name="notifyTradeClose" id="notifyTradeClose" value="true" <%= (user.settings && user.settings.notifyTradeClose) !== false ? 'checked' : '' %>>
          <span style="font-size:12px;color:#9ca3af;">On trade close</span>
        </label>
        <button type="button" id="enable-push-btn" class="btn btn-outline btn-sm">Enable Push</button>
        <span id="push-status" style="font-size:11px;color:#6b7280;"></span>
      </div>
    </div>

    <button type="submit" class="btn btn-outline btn-sm">Save Settings</button>
  </form>
</div>

<!-- Feature Toggles for Live/Paper Trading -->
<div class="section" id="feature-toggles" style="margin-bottom:24px;">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;cursor:pointer;" onclick="document.getElementById('live-feature-toggles').style.display = document.getElementById('live-feature-toggles').style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-arrow').textContent = document.getElementById('live-feature-toggles').style.display === 'none' ? '\u25B6' : '\u25BC';">
    <h3 style="color:#e5e7eb;margin:0;">Feature Toggles</h3>
    <span class="toggle-arrow" style="color:#6b7280;font-size:14px;">&#x25BC;</span>
  </div>
  <div id="live-feature-toggles">
    <p style="color:#6b7280;font-size:12px;margin-bottom:12px;">Toggle trading features on/off for live &amp; paper trading. These match the backtest feature toggles for consistent behavior.</p>
    <form id="feature-toggles-form" action="/account/feature-toggles" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:8px;">
        <!-- Signal Filters -->
        <label class="ft-toggle" title="Block altcoin LONGs when BTC is STRONG_SELL, block SHORTs when BTC is STRONG_BUY">
          <input type="checkbox" name="featureBtcFilter" value="true" <%= (user.settings && user.settings.featureBtcFilter) !== false ? 'checked' : '' %>> <span class="ft-badge ft-signal">SIGNAL</span> BTC Signal Filter
        </label>
        <label class="ft-toggle" title="Penalize score up to -8 when coin is highly correlated with BTC but trading against BTC direction">
          <input type="checkbox" name="featureBtcCorrelation" value="true" <%= (user.settings && user.settings.featureBtcCorrelation) !== false ? 'checked' : '' %>> <span class="ft-badge ft-signal">SIGNAL</span> BTC Correlation Penalty
        </label>
        <label class="ft-toggle" title="Apply session penalty (-5 score) outside 12-22 UTC peak hours">
          <input type="checkbox" name="featureSessionFilter" value="true" <%= (user.settings && user.settings.featureSessionFilter) !== false ? 'checked' : '' %>> <span class="ft-badge ft-signal">SIGNAL</span> Session Filter (12-22 UTC)
        </label>
        <label class="ft-toggle" title="Hide signals with R:R below threshold. Dashboard and auto-trade only show signals meeting min R:R.">
          <input type="checkbox" name="minRiskRewardEnabled" value="true" id="minRrEnabled" <%= (user.settings && user.settings.minRiskRewardEnabled) === true ? 'checked' : '' %>> <span class="ft-badge ft-signal">SIGNAL</span> Min R:R Filter
        </label>
        <div id="minRrValueWrap" style="display:<%= (user.settings && user.settings.minRiskRewardEnabled) === true ? 'flex' : 'none' %>;align-items:center;gap:8px;">
          <label style="font-size:12px;color:#9ca3af;">Min R:R</label>
          <input type="number" name="minRiskReward" id="minRiskRewardInput" min="1" max="5" step="0.1" value="<%= (user.settings && user.settings.minRiskReward) != null ? user.settings.minRiskReward : 1.2 %>" style="width:70px;padding:6px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
        </div>

        <!-- Position Management -->
        <label class="ft-toggle" title="TP1 closes 40%, TP2 closes 30%, TP3 closes remaining 30%. OFF = close 100% at TP1">
          <input type="checkbox" name="featurePartialTP" value="true" <%= (user.settings && user.settings.featurePartialTP) !== false ? 'checked' : '' %>> <span class="ft-badge ft-pos">TP</span> Partial Take Profits (40/30/30)
        </label>
        <label class="ft-toggle" title="Move stop to entry (+0.3% buffer) when trade reaches 0.75R profit">
          <input type="checkbox" name="autoMoveBreakeven" value="true" <%= (user.settings && user.settings.autoMoveBreakeven) !== false ? 'checked' : '' %>> <span class="ft-badge ft-pos">BE</span> Breakeven at 0.75R
        </label>
        <label class="ft-toggle" title="Trail stop 1.5R behind best price after 1.5R profit">
          <input type="checkbox" name="autoTrailingStop" value="true" <%= (user.settings && user.settings.autoTrailingStop) !== false ? 'checked' : '' %>> <span class="ft-badge ft-pos">TS</span> Trailing Stop (1.5R trail)
        </label>
        <label class="ft-toggle" title="Lock stop at 0.5R/0.75R/1R as trade progresses 50%/75%/90% toward TP2">
          <input type="checkbox" name="featureLockIn" value="true" <%= (user.settings && user.settings.featureLockIn) !== false ? 'checked' : '' %>> <span class="ft-badge ft-pos">LOCK</span> Stepped Lock-In
        </label>
      </div>

      <!-- TP Mode & DCA Settings -->
      <div style="margin-top:16px;padding:16px;background:rgba(30,42,58,0.5);border:1px solid #334155;border-radius:8px;">
        <h4 style="color:#e5e7eb;margin:0 0 12px 0;font-size:14px;">Take-Profit Mode</h4>
        <div style="display:flex;gap:16px;align-items:center;margin-bottom:12px;">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;color:#e5e7eb;font-size:13px;">
            <input type="radio" name="tpMode" value="fixed" <%= (!user.settings?.tpMode || user.settings?.tpMode === 'fixed') ? 'checked' : '' %> onchange="document.getElementById('trailing-tp-opts').style.display='none'"> Fixed TPs (TP1/TP2/TP3)
          </label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;color:#e5e7eb;font-size:13px;">
            <input type="radio" name="tpMode" value="trailing" <%= user.settings?.tpMode === 'trailing' ? 'checked' : '' %> onchange="document.getElementById('trailing-tp-opts').style.display='grid'"> Trailing (ride the trend)
          </label>
        </div>
        <div id="trailing-tp-opts" style="display:<%= user.settings?.tpMode === 'trailing' ? 'grid' : 'none' %>;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;">
          <div>
            <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:4px;">Trail Distance Mode</label>
            <select name="trailingTpDistanceMode" id="trailingTpDistMode" onchange="document.getElementById('trail-atr-wrap').style.display=this.value==='atr'?'block':'none';document.getElementById('trail-fixed-wrap').style.display=this.value==='fixed'?'block':'none';" style="width:100%;padding:6px 8px;background:#0d1320;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;font-size:12px;">
              <option value="atr" <%= (!user.settings?.trailingTpDistanceMode || user.settings?.trailingTpDistanceMode === 'atr') ? 'selected' : '' %>>ATR-based (dynamic)</option>
              <option value="fixed" <%= user.settings?.trailingTpDistanceMode === 'fixed' ? 'selected' : '' %>>Fixed % (static)</option>
            </select>
          </div>
          <div id="trail-atr-wrap" style="display:<%= (!user.settings?.trailingTpDistanceMode || user.settings?.trailingTpDistanceMode === 'atr') ? 'block' : 'none' %>;">
            <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:4px;">ATR Multiplier</label>
            <input type="number" name="trailingTpAtrMultiplier" value="<%= user.settings?.trailingTpAtrMultiplier ?? 1.5 %>" min="0.5" max="5" step="0.1" style="width:100%;padding:6px 8px;background:#0d1320;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;font-size:12px;">
          </div>
          <div id="trail-fixed-wrap" style="display:<%= user.settings?.trailingTpDistanceMode === 'fixed' ? 'block' : 'none' %>;">
            <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:4px;">Fixed Trail %</label>
            <input type="number" name="trailingTpFixedPercent" value="<%= user.settings?.trailingTpFixedPercent ?? 2 %>" min="0.5" max="10" step="0.1" style="width:100%;padding:6px 8px;background:#0d1320;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;font-size:12px;">
          </div>
        </div>
      </div>

      <div style="margin-top:12px;padding:16px;background:rgba(30,42,58,0.5);border:1px solid #334155;border-radius:8px;">
        <h4 style="color:#e5e7eb;margin:0 0 12px 0;font-size:14px;">DCA (Dollar Cost Average)</h4>
        <label class="ft-toggle" title="Add to losing positions when signal re-confirms direction and score is above threshold" style="margin-bottom:10px;">
          <input type="checkbox" name="dcaEnabled" value="true" id="dcaEnabledCb" <%= user.settings?.dcaEnabled === true ? 'checked' : '' %> onchange="document.getElementById('dca-opts').style.display=this.checked?'grid':'none'"> <span class="ft-badge ft-pos">DCA</span> Enable DCA
        </label>
        <div id="dca-opts" style="display:<%= user.settings?.dcaEnabled === true ? 'grid' : 'none' %>;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;">
          <div>
            <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:4px;">Max Adds</label>
            <input type="number" name="dcaMaxAdds" value="<%= user.settings?.dcaMaxAdds ?? 3 %>" min="1" max="10" step="1" style="width:100%;padding:6px 8px;background:#0d1320;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;font-size:12px;">
          </div>
          <div>
            <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:4px;">Dip % per Level</label>
            <input type="number" name="dcaDipPercent" value="<%= user.settings?.dcaDipPercent ?? 2 %>" min="0.5" max="20" step="0.5" style="width:100%;padding:6px 8px;background:#0d1320;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;font-size:12px;">
          </div>
          <div>
            <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:4px;">Add Size (% of original)</label>
            <input type="number" name="dcaAddSizePercent" value="<%= user.settings?.dcaAddSizePercent ?? 100 %>" min="25" max="200" step="25" style="width:100%;padding:6px 8px;background:#0d1320;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;font-size:12px;">
          </div>
          <div>
            <label style="font-size:11px;color:#6b7280;display:block;margin-bottom:4px;">Min Score to Re-confirm</label>
            <input type="number" name="dcaMinScore" value="<%= user.settings?.dcaMinScore ?? 52 %>" min="30" max="95" step="1" style="width:100%;padding:6px 8px;background:#0d1320;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;font-size:12px;">
          </div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:8px;margin-top:12px;">
        <!-- Risk Management -->
        <label class="ft-toggle" title="Widen stops tighter than 1x ATR to prevent noise-level stop-outs">
          <input type="checkbox" name="featureMinSlDistance" value="true" <%= (user.settings && user.settings.featureMinSlDistance) !== false ? 'checked' : '' %>> <span class="ft-badge ft-fix">FIX</span> Min SL Distance (1x ATR)
        </label>
        <label class="ft-toggle" title="Re-analyze signal while in trade. Exit on score collapse, reduce 50% on score drop">
          <input type="checkbox" name="featureScoreRecheck" value="true" <%= (user.settings && user.settings.featureScoreRecheck) !== false ? 'checked' : '' %>> <span class="ft-badge ft-risk">RISK</span> Score Re-check (Exit/Reduce)
        </label>
        <label class="ft-toggle" title="Cap stop loss distance to max 15% from entry">
          <input type="checkbox" name="featureSlCap" value="true" <%= (user.settings && user.settings.featureSlCap) !== false ? 'checked' : '' %>> <span class="ft-badge ft-risk">RISK</span> SL Distance Cap (15%)
        </label>

        <!-- Sizing -->
        <label class="ft-toggle" title="Higher score = slightly larger position (0.5 + score/100, cap 1.2x)">
          <input type="checkbox" name="featureConfidenceSizing" value="true" <%= (user.settings && user.settings.featureConfidenceSizing) !== false ? 'checked' : '' %>> <span class="ft-badge ft-cost">SIZE</span> Confidence Sizing
        </label>

        <!-- Quality Filters -->
        <label class="ft-toggle" title="Require at least one of: order block, FVG, or liquidity cluster. Reduces trades without structure.">
          <input type="checkbox" name="featurePriceActionConfluence" value="true" <%= (user.settings && user.settings.featurePriceActionConfluence) === true ? 'checked' : '' %>> <span class="ft-badge ft-signal">QUALITY</span> Price-Action Confluence (OB/FVG/Liq)
        </label>
        <label class="ft-toggle" title="Skip entries when volatility is extreme. Reduces blow-ups in chaotic markets.">
          <input type="checkbox" name="featureVolatilityFilter" value="true" <%= (user.settings && user.settings.featureVolatilityFilter) === true ? 'checked' : '' %>> <span class="ft-badge ft-risk">QUALITY</span> Volatility Filter (skip extreme)
        </label>
        <label class="ft-toggle" title="Require relative volume &gt; 1.0. Avoids entries on thin, low-conviction moves.">
          <input type="checkbox" name="featureVolumeConfirmation" value="true" <%= (user.settings && user.settings.featureVolumeConfirmation) === true ? 'checked' : '' %>> <span class="ft-badge ft-signal">QUALITY</span> Volume Confirmation
        </label>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <button type="button" class="btn btn-sm" onclick="setLiveToggles(true)" style="padding:4px 12px;font-size:11px;background:#1e2a3a;border:1px solid #334155;color:#e5e7eb;border-radius:4px;cursor:pointer;">All ON</button>
        <button type="button" class="btn btn-sm" onclick="setLiveToggles(false)" style="padding:4px 12px;font-size:11px;background:#1e2a3a;border:1px solid #334155;color:#e5e7eb;border-radius:4px;cursor:pointer;">All OFF</button>
        <button type="button" class="btn btn-sm" onclick="loadBacktestPreset()" style="padding:4px 12px;font-size:11px;background:#1e2a3a;border:1px solid #3b82f6;color:#3b82f6;border-radius:4px;cursor:pointer;" title="Load toggle config saved from the Backtest page">Load from Backtest</button>
        <button type="button" class="btn btn-sm" onclick="loadCoinWeightsFromBacktest()" style="padding:4px 12px;font-size:11px;background:#1e2a3a;border:1px solid #10b981;color:#10b981;border-radius:4px;cursor:pointer;" title="Load coin weights from latest massive backtest (prioritizes top performers in auto-trade)">Load Coin Weights</button>
        <button type="submit" class="btn btn-outline btn-sm" style="margin-left:auto;">Save Toggles</button>
      </div>
    </form>
    <form id="coin-weight-form" action="/account/coin-weight-settings" method="POST" style="display:inline-flex;align-items:center;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid #334155;">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <label class="ft-toggle" style="margin:0;" title="When ON, auto-trade prefers coins with higher backtest weights">
        <input type="hidden" name="coinWeightEnabled" value="false">
        <input type="checkbox" name="coinWeightEnabled" value="true" <%= user.coinWeightEnabled ? 'checked' : '' %>> Use coin weights
      </label>
      <select name="coinWeightStrength" style="padding:4px 8px;background:#1e293b;border:1px solid #334155;border-radius:4px;color:#e5e7eb;font-size:12px;">
        <option value="conservative" <%= user.coinWeightStrength === 'conservative' ? 'selected' : '' %>>Conservative</option>
        <option value="moderate" <%= user.coinWeightStrength === 'moderate' || !user.coinWeightStrength ? 'selected' : '' %>>Moderate</option>
        <option value="aggressive" <%= user.coinWeightStrength === 'aggressive' ? 'selected' : '' %>>Aggressive</option>
      </select>
      <button type="submit" class="btn btn-outline btn-sm" style="padding:4px 10px;font-size:11px;">Save</button>
    </form>
  </div>
</div>
<% } %>

<!-- Position Sizing Calculator -->
<div class="section" style="margin-bottom:24px;">
  <h3 style="color:#e5e7eb;margin-bottom:12px;">Position Sizing Calculator</h3>
  <p style="font-size:13px;color:#9ca3af;margin-bottom:12px;">Enter your trade parameters to see risk amount and recommended position size.</p>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;align-items:end;max-width:900px;">
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Account balance ($)</label>
      <input type="number" id="calc-balance" min="100" step="100" value="<%= stats.balance %>" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Risk per trade (%)</label>
      <input type="number" id="calc-risk" min="0.5" max="10" step="0.5" value="2" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Entry price ($)</label>
      <input type="number" id="calc-entry" min="0.0001" step="0.01" value="1" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Stop loss ($)</label>
      <input type="number" id="calc-sl" min="0" step="0.01" value="0.98" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:#9ca3af;margin-bottom:4px;">Leverage</label>
      <input type="number" id="calc-lev" min="1" max="20" value="1" style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#fff;">
    </div>
  </div>
  <div id="calc-result" style="margin-top:14px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
    <span style="font-size:13px;color:#9ca3af;">Risk amount: <strong id="calc-risk-amt" style="color:#eab308;">$0</strong></span>
    <span style="font-size:13px;color:#9ca3af;">Position size: <strong id="calc-pos" style="color:#10b981;">$0</strong></span>
    <span style="font-size:13px;color:#9ca3af;">Margin needed: <strong id="calc-margin" style="color:#3b82f6;">$0</strong></span>
    <span style="font-size:11px;color:#6b7280;">(Stop distance: <span id="calc-stop-pct">0</span>%)</span>
  </div>
</div>

<div class="perf-grid">
  <div class="perf-card">
    <div class="perf-label">Balance</div>
    <div class="perf-value">$<%= stats.balance.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Total P&L</div>
    <div class="perf-value <%= stats.totalPnl >= 0 ? 'up' : 'down' %>"><%= stats.totalPnl >= 0 ? '+' : '' %>$<%= stats.totalPnl.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Return</div>
    <div class="perf-value <%= parseFloat(stats.totalPnlPercent) >= 0 ? 'up' : 'down' %>"><%= stats.totalPnlPercent %>%</div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Win Rate</div>
    <div class="perf-value"><%= stats.winRate %>%</div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Total Trades</div>
    <div class="perf-value"><%= stats.totalTrades %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Wins / Losses</div>
    <div class="perf-value"><span class="up"><%= stats.wins %></span> / <span class="down"><%= stats.losses %></span></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Profit Factor</div>
    <div class="perf-value"><%= stats.profitFactor %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Avg Win</div>
    <div class="perf-value up">+$<%= stats.avgWin.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Avg Loss</div>
    <div class="perf-value down">-$<%= stats.avgLoss.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Best Trade</div>
    <div class="perf-value up">+$<%= stats.bestTrade.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Worst Trade</div>
    <div class="perf-value down">$<%= stats.worstTrade.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Streak</div>
    <div class="perf-value"><%= stats.currentStreak > 0 ? '+' : '' %><%= stats.currentStreak %> (best: <%= stats.bestStreak %>)</div>
  </div>
  <div class="perf-card">
    <div class="perf-label">7-Day P&L</div>
    <div class="perf-value <%= stats.pnl7d >= 0 ? 'up' : 'down' %>"><%= stats.pnl7d >= 0 ? '+' : '' %>$<%= stats.pnl7d.toFixed(2) %></div>
  </div>
  <div class="perf-card">
    <div class="perf-label">Open Trades</div>
    <div class="perf-value"><%= stats.openTrades %></div>
  </div>
  <% if (stats.sharpe != null) { %>
  <div class="perf-card">
    <div class="perf-label">Sharpe Ratio</div>
    <div class="perf-value <%= stats.sharpe >= 0 ? 'up' : 'down' %>"><%= stats.sharpe %></div>
  </div>
  <% } %>
  <% if (stats.sortino != null) { %>
  <div class="perf-card">
    <div class="perf-label">Sortino Ratio</div>
    <div class="perf-value <%= stats.sortino >= 0 ? 'up' : 'down' %>"><%= stats.sortino %></div>
  </div>
  <% } %>
  <div class="perf-card">
    <div class="perf-label">Max Drawdown</div>
    <div class="perf-value down">$<%= (stats.maxDrawdown || 0).toFixed(2) %> (<%= (stats.maxDrawdownPct || 0) %>% of peak)</div>
  </div>
  <% if (stats.calmar != null) { %>
  <div class="perf-card">
    <div class="perf-label">Calmar Ratio</div>
    <div class="perf-value <%= stats.calmar >= 0 ? 'up' : 'down' %>"><%= stats.calmar %></div>
  </div>
  <% } %>
</div>

<% var dd = stats.drawdownAnalysis || {}; %>
<% if (dd.avgRecoveryHours != null || dd.longestUnderwaterHours != null) { %>
<div class="section" style="margin-bottom:16px;">
  <h3 style="color:#e5e7eb;margin-bottom:8px;">Drawdown Details</h3>
  <p style="font-size:12px;color:#9ca3af;margin-bottom:8px;">Avg recovery: <strong><%= dd.avgRecoveryHours != null ? dd.avgRecoveryHours + 'h' : '-' %></strong> &middot; Longest underwater: <strong><%= dd.longestUnderwaterHours != null ? dd.longestUnderwaterHours + 'h' : '-' %></strong> &middot; <a href="/analytics" style="color:#3b82f6;">Full analytics &rarr;</a></p>
</div>
<% } %>

<% if (stats.equityCurve && stats.equityCurve.length > 1) { %>
<div class="section">
  <h3>Equity Curve</h3>
  <p style="font-size:12px;color:#6b7280;margin-bottom:10px;">Account balance over time. Drawdown shaded in red.</p>
  <div class="equity-chart-wrap" style="position:relative;background:#0d1320;border-radius:8px;padding:12px;border:1px solid #1e2a3a;overflow:hidden;">
    <canvas id="equity-curve" style="width:100%;height:260px;display:block;"></canvas>
    <div id="equity-legend" style="font-size:11px;color:#6b7280;margin-top:8px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;"></div>
  </div>
</div>
<% } %>

<% if (Object.keys(stats.byStrategy).length > 0) { %>
<div class="section">
  <h3>By Strategy</h3>
  <table class="data-table">
    <thead><tr><th>Strategy</th><th>Wins</th><th>Losses</th><th>Win Rate</th><th>P&L</th></tr></thead>
    <tbody>
      <% Object.entries(stats.byStrategy).forEach(function([name, data]) {
        var total = data.wins + data.losses;
        var wr = total > 0 ? ((data.wins/total)*100).toFixed(1) : '0';
      %>
        <tr>
          <td><%= name %></td>
          <td class="up"><%= data.wins %></td>
          <td class="down"><%= data.losses %></td>
          <td><%= wr %>%</td>
          <td class="<%= data.pnl >= 0 ? 'up' : 'down' %>"><%= data.pnl >= 0 ? '+' : '' %>$<%= data.pnl.toFixed(2) %></td>
        </tr>
      <% }); %>
    </tbody>
  </table>
</div>
<% } %>

<% if (Object.keys(stats.byCoin).length > 0) { %>
<div class="section">
  <h3>By Coin</h3>
  <table class="data-table">
    <thead><tr><th>Coin</th><th>Wins</th><th>Losses</th><th>Win Rate</th><th>P&L</th></tr></thead>
    <tbody>
      <% Object.entries(stats.byCoin).forEach(function([name, data]) {
        var total = data.wins + data.losses;
        var wr = total > 0 ? ((data.wins/total)*100).toFixed(1) : '0';
      %>
        <tr>
          <td style="font-weight:700;"><%= name %></td>
          <td class="up"><%= data.wins %></td>
          <td class="down"><%= data.losses %></td>
          <td><%= wr %>%</td>
          <td class="<%= data.pnl >= 0 ? 'up' : 'down' %>"><%= data.pnl >= 0 ? '+' : '' %>$<%= data.pnl.toFixed(2) %></td>
        </tr>
      <% }); %>
    </tbody>
  </table>
</div>
<% } %>

<% if (typeof journalAnalytics !== 'undefined' && (Object.keys(journalAnalytics.byEmotion).length > 0 || journalAnalytics.byRules.followed.total > 0 || journalAnalytics.byRules.broke.total > 0)) { %>
<div class="section">
  <h3>Journal Insights <span style="font-size:11px;color:#6b7280;font-weight:normal;">(from trade-linked entries)</span></h3>
  <p style="font-size:12px;color:#6b7280;margin-bottom:12px;">Win rates from trade-linked journal entries. <a href="/journal" style="color:#3b82f6;">Add journal entries</a> to see how emotion and discipline affect your results.</p>
  <div class="perf-grid">
    <% if (journalAnalytics.byRules.followed.total > 0 || journalAnalytics.byRules.broke.total > 0) { %>
    <div class="perf-card">
      <div class="perf-label">When you followed rules</div>
      <div class="perf-value <%= journalAnalytics.byRules.followed.total > 0 && (journalAnalytics.byRules.followed.wins / journalAnalytics.byRules.followed.total) >= 0.5 ? 'up' : 'down' %>">
        <%= journalAnalytics.byRules.followed.total > 0 ? ((journalAnalytics.byRules.followed.wins / journalAnalytics.byRules.followed.total) * 100).toFixed(0) : 0 %>% (<%= journalAnalytics.byRules.followed.wins %>/<%= journalAnalytics.byRules.followed.total %>)
      </div>
    </div>
    <div class="perf-card">
      <div class="perf-label">When you broke rules</div>
      <div class="perf-value <%= journalAnalytics.byRules.broke.total > 0 && (journalAnalytics.byRules.broke.wins / journalAnalytics.byRules.broke.total) >= 0.5 ? 'up' : 'down' %>">
        <%= journalAnalytics.byRules.broke.total > 0 ? ((journalAnalytics.byRules.broke.wins / journalAnalytics.byRules.broke.total) * 100).toFixed(0) : 0 %>% (<%= journalAnalytics.byRules.broke.wins %>/<%= journalAnalytics.byRules.broke.total %>)
      </div>
    </div>
    <% } %>
    <% Object.keys(journalAnalytics.byEmotion).forEach(function(em) {
      var d = journalAnalytics.byEmotion[em];
      var pct = d.total > 0 ? (d.wins / d.total) * 100 : 0;
    %>
    <div class="perf-card">
      <div class="perf-label">When feeling <%= em %></div>
      <div class="perf-value <%= pct >= 50 ? 'up' : 'down' %>"><%= pct.toFixed(0) %>% (<%= d.wins %>/<%= d.total %>)</div>
    </div>
    <% }); %>
  </div>
</div>
<% } %>

<script>
(function() {
  var calcInputs = ['calc-balance','calc-risk','calc-entry','calc-sl','calc-lev'];
  function updateCalc() {
    var bal = parseFloat(document.getElementById('calc-balance').value) || 10000;
    var risk = parseFloat(document.getElementById('calc-risk').value) || 2;
    var entry = parseFloat(document.getElementById('calc-entry').value) || 1;
    var sl = parseFloat(document.getElementById('calc-sl').value) || 0.98;
    var lev = parseFloat(document.getElementById('calc-lev').value) || 1;
    var riskAmt = bal * (risk / 100);
    var stopDist = entry > 0 ? Math.abs(entry - sl) / entry : 0.02;
    if (stopDist <= 0) stopDist = 0.02;
    var posSize = (riskAmt / stopDist) * lev;
    var capped = Math.min(posSize, bal * lev * 0.95);
    var margin = capped / lev;
    document.getElementById('calc-risk-amt').textContent = '$' + riskAmt.toFixed(2);
    document.getElementById('calc-pos').textContent = '$' + capped.toFixed(2);
    document.getElementById('calc-margin').textContent = '$' + margin.toFixed(2);
    document.getElementById('calc-stop-pct').textContent = (stopDist * 100).toFixed(2);
  }
  calcInputs.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.addEventListener('input', updateCalc);
  });
  updateCalc();

  // Load Bitget balance when connected
  var bitgetEl = document.getElementById('bitget-balance-val');
  if (bitgetEl) {
    fetch('/api/exchange/balance', { credentials: 'same-origin' })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (!data.success || !data.balances) { bitgetEl.textContent = 'Error'; return; }
        var b = data.balances;
        var amt = 0;
        if (b.spot) amt = b.spot.available || 0;
        else if (b.futures) amt = b.futures.available ?? b.futures.equity ?? 0;
        bitgetEl.textContent = '$' + amt.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
      })
      .catch(function() { bitgetEl.textContent = 'Error'; });
  }

  <% if (stats.equityCurve && stats.equityCurve.length > 1) { %>
  (function() {
    var data = <%- JSON.stringify(stats.equityCurve) %>;
    var canvas = document.getElementById('equity-curve');
    if (!canvas || !data || data.length < 2) return;
    var ctx = canvas.getContext('2d');

    // Responsive: set canvas pixel size from CSS layout size
    var dpr = window.devicePixelRatio || 1;
    function resizeCanvas() {
      var rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      drawChart();
    }

    function drawChart() {
      var rect = canvas.getBoundingClientRect();
      var w = rect.width, h = rect.height;
      var pad = { top: 14, right: 14, bottom: 28, left: 54 };
      var plotW = w - pad.left - pad.right, plotH = h - pad.top - pad.bottom;
      var eq = data.map(function(d) { return d.equity; });
      var minE = Math.min.apply(null, eq);
      var maxE = Math.max.apply(null, eq);
      var range = maxE - minE || 1;
      minE = Math.max(0, minE - range * 0.08);
      maxE = maxE + range * 0.08;
      range = maxE - minE || 1;

      ctx.clearRect(0, 0, w, h);

      // Grid lines
      ctx.strokeStyle = '#1e2a3a';
      ctx.lineWidth = 0.5;
      for (var g = 0; g <= 4; g++) {
        var gy = pad.top + (plotH * g / 4);
        ctx.beginPath();
        ctx.moveTo(pad.left, gy);
        ctx.lineTo(pad.left + plotW, gy);
        ctx.stroke();
        ctx.fillStyle = '#4b5563';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText('$' + Math.round(maxE - (range * g / 4)).toLocaleString(), pad.left - 4, gy + 3);
      }

      // Compute XY for each data point
      var pts = [];
      for (var i = 0; i < data.length; i++) {
        var x = pad.left + (i / (data.length - 1)) * plotW;
        var y = pad.top + plotH - ((data[i].equity - minE) / range) * plotH;
        pts.push({ x: x, y: y });
      }

      // Drawdown shading (red fill between peak line and equity when in drawdown)
      var peak = data[0].equity;
      ctx.beginPath();
      var inDrawdown = false;
      for (var i = 0; i < data.length; i++) {
        if (data[i].equity > peak) peak = data[i].equity;
        var peakY = pad.top + plotH - ((peak - minE) / range) * plotH;
        if (data[i].drawdown > 0) {
          if (!inDrawdown) {
            ctx.moveTo(pts[i].x, peakY);
            inDrawdown = true;
          }
          ctx.lineTo(pts[i].x, pts[i].y);
        } else {
          if (inDrawdown) {
            ctx.lineTo(pts[i].x, peakY);
            ctx.closePath();
            inDrawdown = false;
          }
          ctx.moveTo(pts[i].x, pts[i].y);
        }
      }
      if (inDrawdown) {
        var lastPeakY = pad.top + plotH - ((peak - minE) / range) * plotH;
        ctx.lineTo(pts[data.length - 1].x, lastPeakY);
        ctx.closePath();
      }
      ctx.fillStyle = 'rgba(239,68,68,0.12)';
      ctx.fill();

      // Equity line
      ctx.beginPath();
      for (var i = 0; i < pts.length; i++) {
        if (i === 0) ctx.moveTo(pts[i].x, pts[i].y);
        else ctx.lineTo(pts[i].x, pts[i].y);
      }
      ctx.strokeStyle = '#10b981';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Fill under equity line
      ctx.lineTo(pts[pts.length - 1].x, pad.top + plotH);
      ctx.lineTo(pts[0].x, pad.top + plotH);
      ctx.closePath();
      ctx.fillStyle = 'rgba(16,185,129,0.1)';
      ctx.fill();

      // X-axis date labels
      ctx.fillStyle = '#4b5563';
      ctx.font = '10px sans-serif';
      ctx.textAlign = 'left';
      if (data[0].date) ctx.fillText(new Date(data[0].date).toLocaleDateString(), pad.left, h - 4);
      ctx.textAlign = 'center';
      var midIdx = Math.floor(data.length / 2);
      if (data[midIdx] && data[midIdx].date && data.length > 4) ctx.fillText(new Date(data[midIdx].date).toLocaleDateString(), pts[midIdx].x, h - 4);
      ctx.textAlign = 'right';
      if (data[data.length - 1].date) ctx.fillText(new Date(data[data.length - 1].date).toLocaleDateString(), pad.left + plotW, h - 4);
    }

    // Build legend (clean — just current equity and max drawdown)
    var legend = document.getElementById('equity-legend');
    var last = data[data.length - 1];
    var legendHtml = '<span>Current: <strong style="color:#fff">$' + (last.equity || 0).toLocaleString() + '</strong></span>';
    legendHtml += '<span>Max DD: <strong style="color:#ef4444">' + (last.drawdownPct || 0) + '%</strong></span>';
    legend.innerHTML = legendHtml;

    // Initial draw + resize handler
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
  })();
  <% } %>

  // Push notifications
  (function() {
    var btn = document.getElementById('enable-push-btn');
    var status = document.getElementById('push-status');
    if (!btn) return;
    function setStatus(txt) { if (status) status.textContent = txt; }
    btn.addEventListener('click', function() {
      if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        setStatus('Push not supported in this browser');
        return;
      }
      setStatus('Requesting...');
      navigator.serviceWorker.register('/sw.js').then(function(reg) {
        return reg.pushManager.getSubscription().then(function(existingSub) {
          if (existingSub) { setStatus('Already enabled'); return { sub: existingSub, isNew: false }; }
          return fetch('/api/push/vapid-public').then(function(r) { return r.json(); }).then(function(d) {
            if (!d.publicKey) { setStatus('Server not configured (set VAPID keys)'); return null; }
            return reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(d.publicKey) }).then(function(sub) { return { sub: sub, isNew: true }; });
          });
        });
      }).then(function(result) {
        if (!result || !result.sub) return;
        if (result.isNew) {
          return fetch('/api/push/subscribe', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(result.sub), credentials: 'same-origin' }).then(function(r) {
            if (r && r.ok) setStatus('Enabled');
            else setStatus('Failed');
          });
        }
      }).catch(function(e) {
        setStatus('Error: ' + (e.message || 'denied'));
      });
    });
    function urlBase64ToUint8Array(base64String) {
      var padding = '='.repeat((4 - base64String.length % 4) % 4);
      var base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      var rawData = window.atob(base64);
      var outputArray = new Uint8Array(rawData.length);
      for (var i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }
  })();
})();

// Feature toggle helpers (global scope for onclick handlers)
function setLiveToggles(val) {
    document.querySelectorAll('#live-feature-toggles input[type=checkbox]').forEach(function(cb) { cb.checked = val; });
    var wrap = document.getElementById('minRrValueWrap');
    if (wrap) wrap.style.display = val ? 'flex' : 'none';
  }
  document.addEventListener('DOMContentLoaded', function() {
    var cb = document.getElementById('minRrEnabled');
    var wrap = document.getElementById('minRrValueWrap');
    if (cb && wrap) {
      cb.addEventListener('change', function() { wrap.style.display = cb.checked ? 'flex' : 'none'; });
    }
  });

  // Save current toggle state to localStorage for backtest → live transfer
  function saveLiveTogglesToLocal() {
    var toggles = {};
    document.querySelectorAll('#feature-toggles-form input[type=checkbox]').forEach(function(cb) {
      toggles[cb.name] = cb.checked;
    });
    localStorage.setItem('tradingFeatureToggles', JSON.stringify(toggles));
  }

  // Load toggle preset saved from backtest page
  function loadBacktestPreset() {
    var saved = localStorage.getItem('backtestFeaturePreset');
    if (!saved) {
      alert('No backtest preset found. Go to the Backtest page and click "Save as Live Preset" first.');
      return;
    }
    try {
      var preset = JSON.parse(saved);
      // Map backtest toggle IDs to live form field names
      var mapping = {
        btcFilter: 'featureBtcFilter',
        btcCorrelation: 'featureBtcCorrelation',
        sessionFilter: 'featureSessionFilter',
        partialTP: 'featurePartialTP',
        breakeven: 'autoMoveBreakeven',
        trailingStop: 'autoTrailingStop',
        lockIn: 'featureLockIn',
        minSlDistance: 'featureMinSlDistance',
        scoreRecheck: 'featureScoreRecheck',
        slCap: 'featureSlCap',
        confidenceSizing: 'featureConfidenceSizing',
        priceActionConfluence: 'featurePriceActionConfluence',
        volatilityFilter: 'featureVolatilityFilter',
        volumeConfirmation: 'featureVolumeConfirmation'
      };
      for (var key in mapping) {
        var input = document.querySelector('#feature-toggles-form input[name="' + mapping[key] + '"]');
        if (input && preset[key] !== undefined) {
          input.checked = preset[key];
        }
      }
      alert('Backtest preset loaded! Click "Save Toggles" to apply.');
    } catch (e) {
      alert('Error loading preset: ' + e.message);
    }
  }

  // Load coin weights from latest massive backtest (prioritizes top performers in auto-trade)
  async function loadCoinWeightsFromBacktest() {
    try {
      var csrf = document.querySelector('input[name="_csrf"]')?.value || '';
      var res = await fetch('/api/load-coin-weights-from-backtest', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf }, body: JSON.stringify({}), credentials: 'same-origin' });
      var data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed');
      alert(data.message || 'Coin weights loaded! Top 5: 1.2x, next 5: 1.1x, bottom 3: 0.8x. Auto-trade will prefer higher-weighted coins.');
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }
</script>

<style>
/* Feature toggle styles */
.ft-toggle {
  display: flex; align-items: center; gap: 8px; padding: 6px 10px;
  background: rgba(15,23,42,0.5); border: 1px solid #1e2a3a; border-radius: 6px;
  color: #e5e7eb; font-size: 12px; cursor: pointer; transition: border-color 0.2s;
}
.ft-toggle:hover { border-color: #334155; }
.ft-toggle input[type=checkbox] { accent-color: #3b82f6; width: 14px; height: 14px; cursor: pointer; }
.ft-badge { padding: 1px 5px; border-radius: 3px; font-size: 9px; font-weight: 700; letter-spacing: 0.5px; }
.ft-signal { background: #3b82f622; color: #3b82f6; }
.ft-pos { background: #10b98122; color: #10b981; }
.ft-risk { background: #f59e0b22; color: #f59e0b; }
.ft-cost { background: #8b5cf622; color: #8b5cf6; }
.ft-fix { background: #ef444422; color: #ef4444; }
</style>

<%- include('partials/footer') %>
