<%- include('partials/header') %>

<div class="section-header">
  <h2 style="color:#fff;font-size:22px;">Active Trades</h2>
  <span style="color:#6b7280;font-size:13px;">Max <%= user.settings?.maxOpenTrades || 3 %> open trades | 1 per pair</span>
</div>

<% if (typeof error !== 'undefined' && error) { %>
  <div class="alert alert-error"><%= error %></div>
<% } %>
<% if (typeof success !== 'undefined' && success) { %>
  <div class="alert alert-success"><%= success %></div>
<% } %>

<% if (trades.length === 0) { %>
  <div class="empty-state">
    <h3>No Open Trades</h3>
    <p>Go to the <a href="/" style="color:#3b82f6;">Dashboard</a> to find signals and open trades.</p>
  </div>
<% } else { %>
  <div class="signals-grid">
    <% trades.forEach(function(trade) {
      var currentPriceData = prices.find(function(p) { return p.id === trade.coinId; });
      var currentPrice = currentPriceData ? currentPriceData.price : trade.entryPrice;
      var pnl, pnlPct;
      if (trade.direction === 'LONG') {
        pnl = ((currentPrice - trade.entryPrice) / trade.entryPrice) * trade.positionSize;
      } else {
        pnl = ((trade.entryPrice - currentPrice) / trade.entryPrice) * trade.positionSize;
      }
      pnlPct = (pnl / trade.margin) * 100;
      var timeHeld = Math.floor((Date.now() - new Date(trade.entryTime).getTime()) / 3600000);
      var timeStr = timeHeld >= 24 ? Math.floor(timeHeld/24) + 'd ' + (timeHeld%24) + 'h' : timeHeld + 'h';
    %>
      <div class="signal-card <%= pnl >= 0 ? 'buy' : 'sell' %>">
        <div class="card-header">
          <div class="coin-info">
            <h3><%= trade.symbol %> <span class="symbol"><%= trade.direction %></span></h3>
            <span class="signal-badge <%= trade.direction === 'LONG' ? 'badge-BUY' : 'badge-SELL' %>"><%= trade.direction %></span>
            <% if (trade.leverage > 1) { %><span class="lev-badge"><%= trade.leverage %>x</span><% } %>
          </div>
          <div class="coin-price">
            <div class="price">$<%= formatPrice(currentPrice) %></div>
            <div class="change <%= pnl >= 0 ? 'up' : 'down' %>">
              <%= pnl >= 0 ? '+' : '' %>$<%= pnl.toFixed(2) %> (<%= pnlPct.toFixed(2) %>%)
            </div>
          </div>
        </div>

        <div class="signal-meta">
          <span>Entry: <strong>$<%= formatPrice(trade.entryPrice) %></strong></span>
          <span>Size: <strong>$<%= trade.positionSize.toFixed(2) %></strong></span>
          <span>Margin: <strong>$<%= trade.margin.toFixed(2) %></strong></span>
          <span>Time: <strong><%= timeStr %></strong></span>
          <span>Score: <strong><%= trade.score || '-' %></strong></span>
        </div>

        <div class="levels">
          <div class="level"><div class="level-label">Entry</div><div class="level-value entry">$<%= formatPrice(trade.entryPrice) %></div></div>
          <div class="level"><div class="level-label">SL</div><div class="level-value sl"><%= trade.stopLoss ? '$' + formatPrice(trade.stopLoss) : '-' %></div></div>
          <div class="level"><div class="level-label">Current</div><div class="level-value <%= pnl >= 0 ? 'tp' : 'sl' %>">$<%= formatPrice(currentPrice) %></div></div>
          <div class="level"><div class="level-label">TP1</div><div class="level-value tp"><%= trade.takeProfit1 ? '$' + formatPrice(trade.takeProfit1) : '-' %></div></div>
          <div class="level"><div class="level-label">TP2</div><div class="level-value tp"><%= trade.takeProfit2 ? '$' + formatPrice(trade.takeProfit2) : '-' %></div></div>
          <div class="level"><div class="level-label">TP3</div><div class="level-value tp"><%= trade.takeProfit3 ? '$' + formatPrice(trade.takeProfit3) : '-' %></div></div>
        </div>

        <% if (trade.reasoning && trade.reasoning.length > 0) { %>
        <div class="reasoning">
          <h4>Entry Thesis</h4>
          <% trade.reasoning.forEach(function(r) { %><div class="reason"><%= r %></div><% }); %>
        </div>
        <% } %>

        <div class="trade-actions">
          <form action="/trades/close/<%= trade._id %>" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-close btn-sm">Close at Market</button>
          </form>
        </div>
      </div>
    <% }); %>
  </div>
<% } %>

<%- include('partials/footer') %>
