<%- include('partials/header') %>

<div class="section-header">
  <h2 style="color:#fff;font-size:22px;">Active Trades</h2>
  <span style="color:#6b7280;font-size:13px;">Max <%= (user.settings && user.settings.maxOpenTrades) || 3 %> open trades | 1 per pair</span>
  <span style="color:#6b7280;font-size:12px;margin-left:10px;">Time every 1s, price every 10s. Close uses live price.</span>
</div>

<% if (typeof error !== 'undefined' && error) { %>
  <div class="alert alert-error"><%= error %></div>
<% } %>
<% if (typeof success !== 'undefined' && success) { %>
  <div class="alert alert-success"><%= success %></div>
<% } %>

<% if (trades.length === 0) { %>
  <div class="empty-state">
    <h3>No Open Trades</h3>
    <p>Go to the <a href="/" style="color:#3b82f6;">Dashboard</a> to find signals and open trades.</p>
  </div>
<% } else { %>
  <div class="signals-grid">
    <% trades.forEach(function(trade) {
      var currentPriceData = prices.find(function(p) { return p.id === trade.coinId; });
      var currentPrice = currentPriceData ? currentPriceData.price : trade.entryPrice;
      var unrealizedPnl;
      if (trade.direction === 'LONG') {
        unrealizedPnl = ((currentPrice - trade.entryPrice) / trade.entryPrice) * trade.positionSize;
      } else {
        unrealizedPnl = ((trade.entryPrice - currentPrice) / trade.entryPrice) * trade.positionSize;
      }
      var partialPnl = trade.partialPnl || 0;
      var pnl = partialPnl + unrealizedPnl;
      var originalMargin = (trade.originalPositionSize || trade.positionSize) / trade.leverage;
      var pnlPct = originalMargin > 0 ? (pnl / originalMargin) * 100 : 0;
      var entryTs = trade.entryTime ? new Date(trade.entryTime).getTime() : Date.now();
      var heldMs = Date.now() - entryTs;
      var totalSecs = Math.max(0, Math.floor(heldMs / 1000));
      var secs = totalSecs % 60;
      var mins = Math.floor(totalSecs / 60) % 60;
      var hours = Math.floor(totalSecs / 3600);
      var days = Math.floor(hours / 24);
      var timeStr = days > 0
        ? days + 'd ' + (hours % 24) + 'h'
        : hours > 0
          ? hours + 'h ' + mins + 'm ' + secs + 's'
          : mins > 0
            ? mins + 'm ' + secs + 's'
            : secs + 's';
    %>
      <div class="signal-card trade-card <%= pnl >= 0 ? 'buy' : 'sell' %>"
           data-trade-id="<%= trade._id %>"
           data-coin-id="<%= trade.coinId %>"
           data-direction="<%= trade.direction %>"
           data-entry-price="<%= trade.entryPrice %>"
           data-position-size="<%= trade.positionSize %>"
           data-margin="<%= trade.margin %>"
           data-partial-pnl="<%= trade.partialPnl || 0 %>"
           data-original-margin="<%= (trade.originalPositionSize || trade.positionSize) / trade.leverage %>"
           data-entry-time="<%= trade.entryTime ? new Date(trade.entryTime).toISOString() : new Date().toISOString() %>">
        <div class="card-header">
          <div class="coin-info">
            <h3><%= trade.symbol %> <span class="symbol"><%= trade.direction %></span></h3>
            <span class="signal-badge <%= trade.direction === 'LONG' ? 'badge-BUY' : 'badge-SELL' %>"><%= trade.direction %></span>
            <% if (trade.leverage > 1) { %><span class="lev-badge"><%= trade.leverage %>x</span><% } %>
          </div>
          <div class="coin-price">
            <div class="price trade-price">$<%= formatPrice(currentPrice) %></div>
            <div class="change trade-pnl-wrap <%= pnl >= 0 ? 'up' : 'down' %>">
              <span class="trade-pnl-dollar"><%= pnl >= 0 ? '+' : '' %>$<%= pnl.toFixed(2) %></span>
              <span class="trade-pnl-pct"> (<%= pnlPct.toFixed(2) %>%)</span>
            </div>
          </div>
        </div>

        <div class="signal-meta">
          <span>Entry: <strong>$<%= formatPrice(trade.entryPrice) %></strong></span>
          <span>Size: <strong>$<%= trade.positionSize.toFixed(2) %></strong><% if (trade.originalPositionSize && trade.originalPositionSize > trade.positionSize) { %> <span style="font-size:11px;color:#6b7280;">(of $<%= trade.originalPositionSize.toFixed(2) %>)</span><% } %></span>
          <span>Margin: <strong>$<%= trade.margin.toFixed(2) %></strong></span>
          <span>Time: <strong class="trade-time"><%= timeStr %></strong></span>
          <span>Score: <strong><%= trade.score || '-' %></strong></span>
          <% if (trade.strategyType) { %><span>Strategy: <strong><%= trade.strategyType.replace(/_/g, ' ') %></strong></span><% } %>
          <% if (trade.stopLabel || trade.tpLabel) { %><span style="color:#6b7280;">Stop: <%= trade.stopLabel || 'ATR+S/R' %> · TP: <%= trade.tpLabel || 'R mult' %></span><% } %>
        </div>

        <%
          // Calculate progress toward BE (1R)
          var origSlForProgress = trade.originalStopLoss || trade.stopLoss;
          var riskForProgress = 0;
          if (origSlForProgress && trade.entryPrice) {
            riskForProgress = trade.direction === 'LONG'
              ? trade.entryPrice - origSlForProgress
              : origSlForProgress - trade.entryPrice;
          }
          if (riskForProgress <= 0 && trade.takeProfit2) {
            riskForProgress = Math.abs(trade.entryPrice - trade.takeProfit2) / 2;
          }
          var profitDist = trade.direction === 'LONG'
            ? currentPrice - trade.entryPrice
            : trade.entryPrice - currentPrice;
          var profitR = riskForProgress > 0 ? profitDist / riskForProgress : 0;
          var stopAtBE = trade.stopLoss && Math.abs(trade.stopLoss - trade.entryPrice) < 0.000001;
        %>
        <div class="trade-actions-taken">
          <% if (trade.actions && trade.actions.length > 0) {
            var latestByType = {};
            trade.actions.forEach(function(a) { if (a.type) latestByType[a.type] = a; });
            var deduped = Object.values(latestByType);
          %>
          <h4>Actions Taken</h4>
          <div class="actions-badges">
            <% deduped.forEach(function(a) {
              var displayVal = '';
              if (['BE','TS','LOCK'].includes(a.type) && a.newValue != null) {
                displayVal = ' $' + formatPrice(a.newValue);
              } else if (a.type === 'EXIT' && a.marketPrice != null) {
                displayVal = ' @$' + formatPrice(a.marketPrice);
              } else if (['PP','RP'].includes(a.type) && a.marketPrice != null) {
                displayVal = ' @$' + formatPrice(a.marketPrice);
              }
              var label = (a.type || '?') + displayVal + (a.timestamp ? ' ' + new Date(a.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '');
            %>
              <span class="action-badge action-<%= (a.type || '').toLowerCase() %>" title="<%= a.description || '' %>"><%= label %></span>
            <% }); %>
          </div>
          <% } %>
          <% if (riskForProgress > 0) { %>
          <div style="margin-top:4px;font-size:10px;color:#6b7280;">
            <% if (stopAtBE) { %>
              <span style="color:#10b981;">&#10003; Stop at breakeven</span> · <%= profitR >= 1.5 ? '<span style="color:#3b82f6;">Trailing active</span>' : 'Trailing at 1.5R (' + Math.min(100, (profitR / 1.5 * 100)).toFixed(0) + '%)' %>
            <% } else if (trade.trailingActivated) { %>
              <span style="color:#3b82f6;">&#10003; Trailing active</span> · <%= profitR.toFixed(2) %>R profit
            <% } else { %>
              BE at 1R: <strong><%= Math.min(100, Math.max(0, profitR * 100)).toFixed(0) %>%</strong>
              <% if (profitR < 0) { %><span style="color:#ef4444;"> (underwater)</span><% } %>
              <% if (profitR >= 0.5 && profitR < 1) { %><span style="color:#eab308;"> (getting close)</span><% } %>
            <% } %>
          </div>
          <% } %>
        </div>
        <div class="levels">
          <div class="level"><div class="level-label">Entry</div><div class="level-value entry">$<%= formatPrice(trade.entryPrice) %></div></div>
          <div class="level"><div class="level-label">SL</div><div class="level-value sl">
            <% if (trade.stopLoss) { %>
              $<%= formatPrice(trade.stopLoss) %>
              <% if (trade.originalStopLoss && trade.originalStopLoss !== trade.stopLoss) { %>
                <span style="font-size:11px;color:#6b7280;">(<s>$<%= formatPrice(trade.originalStopLoss) %></s> moved)</span>
              <% } %>
            <% } else { %>-<% } %>
          </div></div>
          <div class="level"><div class="level-label">Current</div><div class="level-value trade-current-level <%= pnl >= 0 ? 'tp' : 'sl' %>">$<%= formatPrice(currentPrice) %></div></div>
          <div class="level"><div class="level-label">TP1</div><div class="level-value tp"><%= trade.takeProfit1 ? '$' + formatPrice(trade.takeProfit1) : '-' %></div></div>
          <div class="level"><div class="level-label">TP2</div><div class="level-value tp"><%= trade.takeProfit2 ? '$' + formatPrice(trade.takeProfit2) : '-' %></div></div>
          <div class="level"><div class="level-label">TP3</div><div class="level-value tp"><%= trade.takeProfit3 ? '$' + formatPrice(trade.takeProfit3) : '-' %></div></div>
        </div>

        <% if (trade.reasoning && trade.reasoning.length > 0) { %>
        <div class="reasoning">
          <h4>Entry Thesis</h4>
          <% trade.reasoning.forEach(function(r) { %><div class="reason"><%= r %></div><% }); %>
        </div>
        <% } %>

        <% if (trade.scoreCheck && trade.scoreCheck.messages && trade.scoreCheck.messages.length > 0) { %>
        <div class="score-check" data-trade-id="<%= trade._id %>">
          <div class="score-check-header">
            <h4>Score Check</h4>
            <% if (trade.scoreCheck.heat) { %>
              <span class="heat-dot heat-<%= trade.scoreCheck.heat %>"></span>
            <% } %>
            <span class="score-check-time"><%= trade.scoreCheck.checkedAt ? new Date(trade.scoreCheck.checkedAt).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '' %></span>
          </div>
          <div class="score-check-summary">
            <% var isShort = trade.direction === 'SHORT'; var nowVal = isShort ? (100 - (trade.scoreCheck.currentScore || 0)) : (trade.scoreCheck.currentScore || 0); var entryVal = isShort ? (100 - (trade.scoreCheck.entryScore || 0)) : (trade.scoreCheck.entryScore || 0); %>
            <span>Now: <strong><%= nowVal %></strong></span>
            <span>Entry: <strong><%= entryVal %></strong></span>
            <% var diff = trade.scoreCheck.scoreDiffDisplay != null ? trade.scoreCheck.scoreDiffDisplay : trade.scoreCheck.scoreDiff; var fav = trade.scoreCheck.scoreDiffFavorable != null ? trade.scoreCheck.scoreDiffFavorable : (trade.direction === 'LONG' ? trade.scoreCheck.scoreDiff >= 0 : trade.scoreCheck.scoreDiff <= 0); %>
            <% if (diff > 0) { %>
              <span class="score-diff <%= fav ? 'score-diff-pos' : 'score-diff-neg' %>">+<%= diff %><%= fav ? ' ↑' : '' %></span>
            <% } else if (diff < 0) { %>
              <span class="score-diff <%= fav ? 'score-diff-pos' : 'score-diff-neg' %>"><%= diff %></span>
            <% } else { %>
              <span class="score-diff score-diff-neutral">0</span>
            <% } %>
          </div>

          <% if (trade.scoreCheck.entryProbability != null) { %>
          <div class="prob-meter">
            <div class="prob-row">
              <span class="prob-label">Win prob at entry</span>
              <div class="prob-bar-outer"><div class="prob-bar-inner prob-bar-entry" style="width:<%= trade.scoreCheck.entryProbability %>%"></div></div>
              <span class="prob-value"><%= trade.scoreCheck.entryProbability %>%</span>
            </div>
            <div class="prob-row">
              <span class="prob-label">Current probability</span>
              <div class="prob-bar-outer"><div class="prob-bar-inner prob-bar-current prob-bar-<%= trade.scoreCheck.heat || 'green' %>" style="width:<%= trade.scoreCheck.currentProbability %>%"></div></div>
              <span class="prob-value"><%= trade.scoreCheck.currentProbability %>%</span>
            </div>
          </div>
          <% } %>

          <div class="score-check-messages">
            <% trade.scoreCheck.messages.forEach(function(msg) { %>
              <span class="score-msg score-msg-<%= msg.type %>"><%= msg.text %></span>
            <% }); %>
          </div>

          <% if (trade.scoreCheck.changeReasons && trade.scoreCheck.changeReasons.length > 0) { %>
          <div class="change-reasons">
            <div class="change-reasons-title">What changed?</div>
            <% trade.scoreCheck.changeReasons.forEach(function(r) { %>
              <span class="change-reason change-reason-<%= r.type %>"><%= r.text %></span>
            <% }); %>
          </div>
          <% } %>

          <% if (trade.scoreCheck.suggestedAction) { %>
          <div class="action-ladder action-<%= trade.scoreCheck.suggestedAction.level %>">
            <span class="action-label">Action:</span>
            <span class="action-text"><%= trade.scoreCheck.suggestedAction.text %></span>
            <% var autoOn = typeof user !== 'undefined' && user && user.settings && user.settings.autoExecuteActions; %>
            <% if (autoOn) { %>
              <span style="font-size:9px;padding:2px 5px;border-radius:3px;background:rgba(16,185,129,0.15);color:#10b981;margin-left:6px;font-weight:600;">AUTO</span>
            <% } else { %>
              <span style="font-size:9px;padding:2px 5px;border-radius:3px;background:rgba(234,179,8,0.15);color:#eab308;margin-left:6px;font-weight:600;">SUGGESTION</span>
            <% } %>
          </div>
          <% if (trade.scoreCheck.lastActionDetails) { %>
          <div class="action-details" style="background:rgba(16,185,129,0.08);border-left:2px solid #10b981;padding:4px 8px;margin-top:4px;border-radius:4px;font-size:11px;color:#d1d5db;">
            <span style="color:#10b981;font-weight:600;">Executed:</span> <%= trade.scoreCheck.lastActionDetails %>
          </div>
          <% } %>
          <% if (!autoOn && ['consider_exit','reduce_position','take_partial','tighten_stop','lock_in_profit'].indexOf(trade.scoreCheck.suggestedAction.actionId) >= 0) { %>
          <div style="font-size:10px;color:#6b7280;margin-top:3px;">Enable "Auto-execute" in <a href="/performance" style="color:#3b82f6;">Settings</a> to act on this automatically</div>
          <% } %>
          <% } %>

          <% if (trade.scoreHistory && trade.scoreHistory.length > 1) { %>
          <div class="health-timeline" data-trade-id="<%= trade._id %>" data-direction="<%= trade.direction %>">
            <div class="timeline-title">Trade Health Timeline</div>
            <canvas class="timeline-canvas" width="360" height="80"></canvas>
          </div>
          <% } %>
        </div>
        <% } else { %>
        <div class="score-check score-check-pending" data-trade-id="<%= trade._id %>">
          <div class="score-check-header">
            <h4>Score Check</h4>
          </div>
          <div class="score-check-messages">
            <span class="score-msg score-msg-neutral">Awaiting first re-check...</span>
          </div>
        </div>
        <% } %>

        <div class="trade-actions">
          <% var chartUrl = '/chart/' + trade.coinId + '?tradeId=' + trade._id + '&entry=' + trade.entryPrice + (trade.stopLoss ? '&sl=' + trade.stopLoss : '') + (trade.takeProfit1 ? '&tp1=' + trade.takeProfit1 : '') + (trade.takeProfit2 ? '&tp2=' + trade.takeProfit2 : '') + (trade.takeProfit3 ? '&tp3=' + trade.takeProfit3 : ''); %>
          <a href="<%= chartUrl %>" class="btn btn-outline btn-sm" target="_blank" rel="noopener">View chart</a>
          <form action="/trades/close/<%= trade._id %>" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-close btn-sm">Close at Market</button>
          </form>
        </div>
      </div>
    <% }); %>
  </div>
<% } %>

<% if (trades.length > 0) { %>
<script>
  window.__scoreHistories = {};
  <% trades.forEach(function(trade) { %>
    <% if (trade.scoreHistory && trade.scoreHistory.length > 0) { %>
      window.__scoreHistories['<%= trade._id %>'] = <%- JSON.stringify(trade.scoreHistory) %>;
    <% } %>
  <% }); %>
</script>
<script src="/js/trades-live.js?v=5" defer></script>
<% } %>

<%- include('partials/footer') %>
