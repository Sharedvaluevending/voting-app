<%- include('partials/header') %>

<div class="section-header">
  <h2 style="color:#fff;font-size:22px;">Active Trades</h2>
  <span style="color:#6b7280;font-size:13px;">Max <%= (user.settings && user.settings.maxOpenTrades) || 3 %> open trades | 1 per pair</span>
  <span style="color:#6b7280;font-size:12px;margin-left:10px;">Time every 1s, price every 10s. Close uses live price.</span>
</div>

<% if (typeof error !== 'undefined' && error) { %>
  <div class="alert alert-error"><%= error %></div>
<% } %>
<% if (typeof success !== 'undefined' && success) { %>
  <div class="alert alert-success"><%= success %></div>
<% } %>

<% if (trades.length === 0) { %>
  <div class="empty-state">
    <h3>No Open Trades</h3>
    <p>Go to the <a href="/" style="color:#3b82f6;">Dashboard</a> to find signals and open trades.</p>
  </div>
<% } else { %>
  <div class="signals-grid">
    <% trades.forEach(function(trade) {
      var currentPriceData = prices.find(function(p) { return p.id === trade.coinId; });
      var currentPrice = currentPriceData ? currentPriceData.price : trade.entryPrice;
      var pnl, pnlPct;
      if (trade.direction === 'LONG') {
        pnl = ((currentPrice - trade.entryPrice) / trade.entryPrice) * trade.positionSize;
      } else {
        pnl = ((trade.entryPrice - currentPrice) / trade.entryPrice) * trade.positionSize;
      }
      pnlPct = (pnl / trade.margin) * 100;
      var entryTs = trade.entryTime ? new Date(trade.entryTime).getTime() : Date.now();
      var heldMs = Date.now() - entryTs;
      var totalSecs = Math.max(0, Math.floor(heldMs / 1000));
      var secs = totalSecs % 60;
      var mins = Math.floor(totalSecs / 60) % 60;
      var hours = Math.floor(totalSecs / 3600);
      var days = Math.floor(hours / 24);
      var timeStr = days > 0
        ? days + 'd ' + (hours % 24) + 'h'
        : hours > 0
          ? hours + 'h ' + mins + 'm ' + secs + 's'
          : mins > 0
            ? mins + 'm ' + secs + 's'
            : secs + 's';
    %>
      <div class="signal-card trade-card <%= pnl >= 0 ? 'buy' : 'sell' %>"
           data-trade-id="<%= trade._id %>"
           data-coin-id="<%= trade.coinId %>"
           data-direction="<%= trade.direction %>"
           data-entry-price="<%= trade.entryPrice %>"
           data-position-size="<%= trade.positionSize %>"
           data-margin="<%= trade.margin %>"
           data-stop-loss="<%= trade.stopLoss || '' %>"
           data-original-sl="<%= trade.originalStopLoss || trade.stopLoss || '' %>"
           data-entry-time="<%= trade.entryTime ? new Date(trade.entryTime).toISOString() : new Date().toISOString() %>">
        <div class="card-header">
          <div class="coin-info">
            <h3><%= trade.symbol %> <span class="symbol"><%= trade.direction %></span></h3>
            <span class="signal-badge <%= trade.direction === 'LONG' ? 'badge-BUY' : 'badge-SELL' %>"><%= trade.direction %></span>
            <% if (trade.leverage > 1) { %><span class="lev-badge"><%= trade.leverage %>x</span><% } %>
          </div>
          <div class="coin-price">
            <div class="price trade-price">$<%= formatPrice(currentPrice) %></div>
            <div class="change trade-pnl-wrap <%= pnl >= 0 ? 'up' : 'down' %>">
              <span class="trade-pnl-dollar"><%= pnl >= 0 ? '+' : '' %>$<%= pnl.toFixed(2) %></span>
              <span class="trade-pnl-pct"> (<%= pnlPct.toFixed(2) %>%)</span>
            </div>
          </div>
        </div>

        <div class="signal-meta">
          <span>Entry: <strong>$<%= formatPrice(trade.entryPrice) %></strong></span>
          <span>Size: <strong>$<%= trade.positionSize.toFixed(2) %></strong></span>
          <span>Margin: <strong>$<%= trade.margin.toFixed(2) %></strong></span>
          <span>Time: <strong class="trade-time"><%= timeStr %></strong></span>
          <span>Score: <strong><%= trade.score || '-' %></strong></span>
          <% if (trade.strategyType) { %><span>Strategy: <strong><%= trade.strategyType.replace(/_/g, ' ') %></strong></span><% } %>
          <% if (trade.stopLabel || trade.tpLabel) { %><span style="color:#6b7280;">Stop: <%= trade.stopLabel || 'ATR+S/R' %> · TP: <%= trade.tpLabel || 'R mult' %></span><% } %>
        </div>

        <div class="levels">
          <div class="level"><div class="level-label">Entry</div><div class="level-value entry">$<%= formatPrice(trade.entryPrice) %></div></div>
          <div class="level">
            <div class="level-label">SL<% if (trade.originalStopLoss && trade.stopLoss !== trade.originalStopLoss) { %> <span style="color:#3b82f6;font-size:10px;">(moved)</span><% } %></div>
            <div class="level-value sl trade-sl-value">
              <%= trade.stopLoss ? '$' + formatPrice(trade.stopLoss) : '-' %>
              <% if (trade.originalStopLoss && trade.stopLoss !== trade.originalStopLoss) { %>
                <div style="font-size:10px;color:#6b7280;text-decoration:line-through;">$<%= formatPrice(trade.originalStopLoss) %></div>
              <% } %>
            </div>
          </div>
          <div class="level"><div class="level-label">Current</div><div class="level-value trade-current-level <%= pnl >= 0 ? 'tp' : 'sl' %>">$<%= formatPrice(currentPrice) %></div></div>
          <div class="level"><div class="level-label">TP1</div><div class="level-value tp"><%= trade.takeProfit1 ? '$' + formatPrice(trade.takeProfit1) : '-' %></div></div>
          <div class="level"><div class="level-label">TP2</div><div class="level-value tp"><%= trade.takeProfit2 ? '$' + formatPrice(trade.takeProfit2) : '-' %></div></div>
          <div class="level"><div class="level-label">TP3</div><div class="level-value tp"><%= trade.takeProfit3 ? '$' + formatPrice(trade.takeProfit3) : '-' %></div></div>
        </div>

        <% if (trade.actions && trade.actions.length > 0) { %>
        <div class="trade-actions-log" style="margin:10px 0;padding:8px 12px;background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:8px;">
          <h4 style="color:#93c5fd;font-size:12px;margin:0 0 6px 0;text-transform:uppercase;letter-spacing:0.5px;">Actions Taken</h4>
          <% trade.actions.forEach(function(action) { %>
            <div style="font-size:12px;color:#d1d5db;padding:3px 0;display:flex;align-items:center;gap:6px;">
              <span style="color:<%= action.type === 'BREAKEVEN' ? '#10b981' : '#3b82f6' %>;font-size:11px;font-weight:700;"><%= action.type === 'BREAKEVEN' ? 'BE' : 'TS' %></span>
              <span><%= action.description %></span>
              <% if (action.timestamp) { %>
                <span style="color:#6b7280;font-size:10px;margin-left:auto;white-space:nowrap;"><%= new Date(action.timestamp).toLocaleString() %></span>
              <% } %>
            </div>
          <% }); %>
        </div>
        <% } else { %>
        <div class="trade-actions-log" style="margin:10px 0;padding:6px 12px;background:rgba(107,114,128,0.08);border:1px solid rgba(107,114,128,0.15);border-radius:8px;">
          <span style="font-size:11px;color:#6b7280;">No actions yet — monitoring for breakeven &amp; trailing stop triggers</span>
        </div>
        <% } %>

        <% if (trade.reasoning && trade.reasoning.length > 0) { %>
        <div class="reasoning">
          <h4>Entry Thesis</h4>
          <% trade.reasoning.forEach(function(r) { %><div class="reason"><%= r %></div><% }); %>
        </div>
        <% } %>

        <div class="trade-actions">
          <% var chartUrl = '/chart/' + trade.coinId + '?tradeId=' + trade._id; %>
          <a href="<%= chartUrl %>" class="btn btn-outline btn-sm trade-chart-link" target="_blank" rel="noopener">View chart</a>
          <form action="/trades/close/<%= trade._id %>" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-close btn-sm">Close at Market</button>
          </form>
        </div>
      </div>
    <% }); %>
  </div>
<% } %>

<% if (trades.length > 0) { %>
<script src="/js/trades-live.js?v=4" defer></script>
<% } %>

<%- include('partials/footer') %>
