<%- include('partials/header') %>

<div class="section-header">
  <h2 style="color:#fff;font-size:22px;">Active Trades</h2>
  <span style="color:#6b7280;font-size:13px;">Max <%= (user.settings && user.settings.maxOpenTrades) || 3 %> open trades | 1 per pair</span>
  <span style="color:#6b7280;font-size:12px;margin-left:10px;">Time every 1s, price every 10s. Close uses live price.</span>
</div>

<% if (typeof error !== 'undefined' && error) { %>
  <div class="alert alert-error"><%= error %></div>
<% } %>
<% if (typeof success !== 'undefined' && success) { %>
  <div class="alert alert-success"><%= success %></div>
<% } %>

<% if (trades.length === 0) { %>
  <div class="empty-state">
    <h3>No Open Trades</h3>
    <p>Go to the <a href="/" style="color:#3b82f6;">Dashboard</a> to find signals and open trades.</p>
  </div>
<% } else { %>
  <div class="signals-grid">
    <% trades.forEach(function(trade) {
      var currentPriceData = prices.find(function(p) { return p.id === trade.coinId; });
      var currentPrice = currentPriceData ? currentPriceData.price : trade.entryPrice;
      var pnl, pnlPct;
      if (trade.direction === 'LONG') {
        pnl = ((currentPrice - trade.entryPrice) / trade.entryPrice) * trade.positionSize;
      } else {
        pnl = ((trade.entryPrice - currentPrice) / trade.entryPrice) * trade.positionSize;
      }
      pnlPct = (pnl / trade.margin) * 100;
      var entryTs = trade.entryTime ? new Date(trade.entryTime).getTime() : Date.now();
      var heldMs = Date.now() - entryTs;
      var totalSecs = Math.max(0, Math.floor(heldMs / 1000));
      var secs = totalSecs % 60;
      var mins = Math.floor(totalSecs / 60) % 60;
      var hours = Math.floor(totalSecs / 3600);
      var days = Math.floor(hours / 24);
      var timeStr = days > 0
        ? days + 'd ' + (hours % 24) + 'h'
        : hours > 0
          ? hours + 'h ' + mins + 'm ' + secs + 's'
          : mins > 0
            ? mins + 'm ' + secs + 's'
            : secs + 's';
    %>
      <div class="signal-card trade-card <%= pnl >= 0 ? 'buy' : 'sell' %>"
           data-trade-id="<%= trade._id %>"
           data-coin-id="<%= trade.coinId %>"
           data-direction="<%= trade.direction %>"
           data-entry-price="<%= trade.entryPrice %>"
           data-position-size="<%= trade.positionSize %>"
           data-margin="<%= trade.margin %>"
           data-entry-time="<%= trade.entryTime ? new Date(trade.entryTime).toISOString() : new Date().toISOString() %>">
        <div class="card-header">
          <div class="coin-info">
            <h3><%= trade.symbol %> <span class="symbol"><%= trade.direction %></span></h3>
            <span class="signal-badge <%= trade.direction === 'LONG' ? 'badge-BUY' : 'badge-SELL' %>"><%= trade.direction %></span>
            <% if (trade.leverage > 1) { %><span class="lev-badge"><%= trade.leverage %>x</span><% } %>
          </div>
          <div class="coin-price">
            <div class="price trade-price">$<%= formatPrice(currentPrice) %></div>
            <div class="change trade-pnl-wrap <%= pnl >= 0 ? 'up' : 'down' %>">
              <span class="trade-pnl-dollar"><%= pnl >= 0 ? '+' : '' %>$<%= pnl.toFixed(2) %></span>
              <span class="trade-pnl-pct"> (<%= pnlPct.toFixed(2) %>%)</span>
            </div>
          </div>
        </div>

        <div class="signal-meta">
          <span>Entry: <strong>$<%= formatPrice(trade.entryPrice) %></strong></span>
          <span>Size: <strong>$<%= trade.positionSize.toFixed(2) %></strong></span>
          <span>Margin: <strong>$<%= trade.margin.toFixed(2) %></strong></span>
          <span>Time: <strong class="trade-time"><%= timeStr %></strong></span>
          <span>Score: <strong><%= trade.score || '-' %></strong></span>
          <% if (trade.strategyType) { %><span>Strategy: <strong><%= trade.strategyType.replace(/_/g, ' ') %></strong></span><% } %>
          <% if (trade.stopLabel || trade.tpLabel) { %><span style="color:#6b7280;">Stop: <%= trade.stopLabel || 'ATR+S/R' %> Â· TP: <%= trade.tpLabel || 'R mult' %></span><% } %>
        </div>

        <div class="levels">
          <div class="level"><div class="level-label">Entry</div><div class="level-value entry">$<%= formatPrice(trade.entryPrice) %></div></div>
          <div class="level"><div class="level-label">SL</div><div class="level-value sl"><%= trade.stopLoss ? '$' + formatPrice(trade.stopLoss) : '-' %></div></div>
          <div class="level"><div class="level-label">Current</div><div class="level-value trade-current-level <%= pnl >= 0 ? 'tp' : 'sl' %>">$<%= formatPrice(currentPrice) %></div></div>
          <div class="level"><div class="level-label">TP1</div><div class="level-value tp"><%= trade.takeProfit1 ? '$' + formatPrice(trade.takeProfit1) : '-' %></div></div>
          <div class="level"><div class="level-label">TP2</div><div class="level-value tp"><%= trade.takeProfit2 ? '$' + formatPrice(trade.takeProfit2) : '-' %></div></div>
          <div class="level"><div class="level-label">TP3</div><div class="level-value tp"><%= trade.takeProfit3 ? '$' + formatPrice(trade.takeProfit3) : '-' %></div></div>
        </div>

        <% if (trade.reasoning && trade.reasoning.length > 0) { %>
        <div class="reasoning">
          <h4>Entry Thesis</h4>
          <% trade.reasoning.forEach(function(r) { %><div class="reason"><%= r %></div><% }); %>
        </div>
        <% } %>

        <% if (trade.scoreCheck && trade.scoreCheck.messages && trade.scoreCheck.messages.length > 0) { %>
        <div class="score-check" data-trade-id="<%= trade._id %>">
          <div class="score-check-header">
            <h4>Score Check</h4>
            <span class="score-check-time"><%= trade.scoreCheck.checkedAt ? new Date(trade.scoreCheck.checkedAt).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '' %></span>
          </div>
          <div class="score-check-summary">
            <span>Now: <strong><%= trade.scoreCheck.currentScore %></strong></span>
            <span>Entry: <strong><%= trade.scoreCheck.entryScore %></strong></span>
            <% if (trade.scoreCheck.scoreDiff > 0) { %>
              <span class="score-diff score-diff-pos">+<%= trade.scoreCheck.scoreDiff %></span>
            <% } else if (trade.scoreCheck.scoreDiff < 0) { %>
              <span class="score-diff score-diff-neg"><%= trade.scoreCheck.scoreDiff %></span>
            <% } else { %>
              <span class="score-diff score-diff-neutral">0</span>
            <% } %>
          </div>
          <div class="score-check-messages">
            <% trade.scoreCheck.messages.forEach(function(msg) { %>
              <span class="score-msg score-msg-<%= msg.type %>"><%= msg.text %></span>
            <% }); %>
          </div>
        </div>
        <% } else { %>
        <div class="score-check score-check-pending" data-trade-id="<%= trade._id %>">
          <div class="score-check-header">
            <h4>Score Check</h4>
          </div>
          <div class="score-check-messages">
            <span class="score-msg score-msg-neutral">Awaiting first re-check...</span>
          </div>
        </div>
        <% } %>

        <div class="trade-actions">
          <% var chartUrl = '/chart/' + trade.coinId + '?entry=' + trade.entryPrice + (trade.stopLoss ? '&sl=' + trade.stopLoss : '') + (trade.takeProfit1 ? '&tp1=' + trade.takeProfit1 : '') + (trade.takeProfit2 ? '&tp2=' + trade.takeProfit2 : '') + (trade.takeProfit3 ? '&tp3=' + trade.takeProfit3 : ''); %>
          <a href="<%= chartUrl %>" class="btn btn-outline btn-sm" target="_blank" rel="noopener">View chart</a>
          <form action="/trades/close/<%= trade._id %>" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-close btn-sm">Close at Market</button>
          </form>
        </div>
      </div>
    <% }); %>
  </div>
<% } %>

<% if (trades.length > 0) { %>
<script src="/js/trades-live.js?v=3" defer></script>
<% } %>

<%- include('partials/footer') %>
