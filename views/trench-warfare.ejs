<%- include('partials/header') %>

<div class="section-header">
  <h2 style="color:#fff;font-size:22px;">Trench Warfare</h2>
  <p style="color:#9ca3af;font-size:13px;margin-top:6px;">Solana memecoin scalping — find pumping coins, quick trades. Connect Phantom to trade directly.</p>
</div>

<!-- Hero -->
<div class="section" style="margin-bottom:24px;background:rgba(15,23,42,0.6);border:1px solid #1e2a3a;border-radius:12px;">
  <h3 style="color:#e5e7eb;margin-bottom:8px;">Shitcoin Scalping Hub</h3>
  <p style="font-size:13px;color:#9ca3af;margin:0;">Trending Solana tokens from Mobula. Paper trade with fake $ or connect Phantom for real swaps. DYOR — not financial advice.</p>
  <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
    <div style="display:flex;gap:8px;">
      <button type="button" id="btn-mode-paper" class="nav-btn" style="padding:8px 16px;">Paper</button>
      <button type="button" id="btn-mode-live" class="nav-btn" style="padding:8px 16px;">Live (Phantom)</button>
    </div>
    <% if (typeof user !== 'undefined' && user) { %>
    <span id="paper-balance" style="color:#10b981;font-size:14px;font-weight:600;">Paper: $<%= (trenchPaperBalance || 1000).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) %></span>
    <button type="button" id="btn-reset-paper" class="nav-btn" style="padding:6px 12px;font-size:12px;" title="Reset to $1,000">Reset</button>
    <% } else { %>
    <span style="color:#6b7280;font-size:13px;">Login to paper trade</span>
    <% } %>
    <button type="button" id="btn-connect-wallet" class="nav-btn" style="padding:6px 12px;font-size:12px;display:none;">Connect Phantom</button>
    <span id="wallet-status" style="color:#6b7280;font-size:13px;"></span>
  </div>
</div>

<!-- Open Positions -->
<% if (typeof user !== 'undefined' && user && openPositions && openPositions.length > 0) { %>
<div class="section" style="margin-bottom:24px;">
  <h3 style="color:#e5e7eb;margin-bottom:12px;">Open Positions</h3>
  <div style="overflow-x:auto;">
    <table class="data-table">
      <thead>
        <tr><th>Token</th><th>Amount</th><th>Entry</th><th>Cost</th><th>Type</th><th>Action</th></tr>
      </thead>
      <tbody>
        <% openPositions.forEach(function(p) { %>
        <tr data-position-id="<%= p._id %>" data-token-address="<%= p.tokenAddress %>" data-is-paper="<%= p.isPaper ? '1' : '0' %>">
          <td><strong><%= p.tokenSymbol %></strong></td>
          <td><%= (p.tokenAmount || 0).toLocaleString(undefined, {maximumFractionDigits:0}) %></td>
          <td>$<%= (p.entryPrice || 0).toLocaleString(undefined, {minimumFractionDigits:6, maximumFractionDigits:8}) %></td>
          <td><%= p.isPaper ? '$' + (p.amountIn || 0).toFixed(2) : (p.amountIn || 0) + ' SOL' %></td>
          <td><%= p.isPaper ? 'Paper' : 'Live' %></td>
          <td><% if (p.isPaper) { %><button type="button" class="btn-sell-paper nav-btn" style="padding:4px 10px;font-size:12px;">Sell</button><% } else { %><span style="color:#6b7280;font-size:11px;">—</span><% } %></td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
</div>
<% } %>

<!-- Analytics -->
<% if (typeof user !== 'undefined' && user) { %>
<div class="section" style="margin-bottom:24px;">
  <h3 style="color:#e5e7eb;margin-bottom:12px;">Trench Analytics</h3>
  <div id="trench-analytics" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px;">
    <div style="padding:12px;background:rgba(15,23,42,0.6);border-radius:8px;border:1px solid #1e2a3a;">
      <div style="font-size:11px;color:#6b7280;">Total PnL</div>
      <div id="stat-total-pnl" style="font-size:18px;font-weight:600;color:#e5e7eb;">$0</div>
    </div>
    <div style="padding:12px;background:rgba(15,23,42,0.6);border-radius:8px;border:1px solid #1e2a3a;">
      <div style="font-size:11px;color:#6b7280;">Win Rate</div>
      <div id="stat-win-rate" style="font-size:18px;font-weight:600;color:#e5e7eb;">0%</div>
    </div>
    <div style="padding:12px;background:rgba(15,23,42,0.6);border-radius:8px;border:1px solid #1e2a3a;">
      <div style="font-size:11px;color:#6b7280;">Trades</div>
      <div id="stat-trades" style="font-size:18px;font-weight:600;color:#e5e7eb;">0</div>
    </div>
    <div style="padding:12px;background:rgba(15,23,42,0.6);border-radius:8px;border:1px solid #1e2a3a;">
      <div style="font-size:11px;color:#6b7280;">Best / Worst</div>
      <div id="stat-best-worst" style="font-size:14px;font-weight:600;color:#10b981;">$0 / $0</div>
    </div>
  </div>
  <div id="trench-paused" style="display:none;margin-top:12px;padding:12px;background:rgba(239,68,68,0.15);border:1px solid #ef4444;border-radius:8px;">
    <span style="color:#ef4444;">Paused: </span><span id="paused-reason"></span>
    <button type="button" id="btn-unpause" class="nav-btn" style="margin-left:12px;padding:4px 12px;">Resume</button>
  </div>
</div>
<% } %>

<!-- Auto Trade -->
<% if (typeof user !== 'undefined' && user) { %>
<div class="section" style="margin-bottom:24px;">
  <h3 style="color:#e5e7eb;margin-bottom:12px;">Auto Trade</h3>
  <p style="font-size:13px;color:#9ca3af;margin-bottom:12px;">Test with paper first, then connect a bot wallet for live. Runs every 5 min. Uses Dexscreener + LamboTrendings + CoinGecko. Set MOBULA_API_KEY for full data.</p>
  <% if (trenchAuto && trenchAuto.lastPausedAt) { %>
  <div id="paused-banner" style="margin-bottom:12px;padding:10px;background:rgba(239,68,68,0.2);border-radius:8px;color:#ef4444;font-size:13px;">Paused: <%= trenchAuto.pausedReason || 'Risk limit' %>. <button type="button" id="btn-unpause-banner" class="nav-btn" style="padding:4px 10px;font-size:12px;">Resume</button></div>
  <% } %>
  <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:center;margin-bottom:16px;">
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
      <input type="checkbox" id="auto-enabled" <%= (trenchAuto && trenchAuto.enabled) ? 'checked' : '' %>>
      <span style="color:#e5e7eb;">Enable Auto Trade</span>
    </label>
    <select id="auto-mode" style="padding:8px 12px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;">
      <option value="paper" <%= (trenchAuto && trenchAuto.mode === 'live') ? '' : 'selected' %>>Paper (test)</option>
      <option value="live" <%= (trenchAuto && trenchAuto.mode === 'live') ? 'selected' : '' %>>Live (bot wallet)</option>
    </select>
    <span id="bot-wallet-status" style="font-size:13px;color:<%= (trenchBot && trenchBot.connected) ? '#10b981' : '#6b7280' %>;"><%= (trenchBot && trenchBot.connected) ? 'Bot: ' + (trenchBot.publicKey || '').slice(0,8) + '...' : 'No bot wallet' %></span>
    <button type="button" id="btn-connect-bot" class="nav-btn" style="padding:6px 12px;font-size:12px;display:<%= (trenchBot && trenchBot.connected) ? 'none' : 'inline-block' %>;">Connect Bot Wallet</button>
    <button type="button" id="btn-disconnect-bot" class="nav-btn" style="padding:6px 12px;font-size:12px;display:<%= (trenchBot && trenchBot.connected) ? 'inline-block' : 'none' %>;">Disconnect</button>
  </div>
  <div id="bot-key-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;padding:20px;">
    <div style="background:#111827;border:1px solid #1e2a3a;border-radius:12px;padding:24px;max-width:480px;width:100%;">
      <h3 style="color:#fff;margin:0 0 12px 0;">Connect Bot Wallet</h3>
      <p style="color:#eab308;font-size:12px;margin:0 0 12px 0;">Use a dedicated wallet with limited funds. Export private key from Phantom (Settings → Security → Export Private Key).</p>
      <textarea id="bot-private-key" placeholder="Paste base58 private key" rows="3" style="width:100%;padding:10px;background:#0d1320;border:1px solid #1e2a3a;border-radius:8px;color:#e5e7eb;font-size:12px;resize:vertical;"></textarea>
      <div style="margin-top:12px;display:flex;gap:10px;">
        <button type="button" id="bot-key-cancel" class="nav-btn" style="flex:1;">Cancel</button>
        <button type="button" id="bot-key-connect" class="nav-btn primary" style="flex:1;">Connect</button>
      </div>
    </div>
  </div>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:12px;">
    <div><label style="font-size:11px;color:#6b7280;">Min Score</label><input type="number" id="auto-min-score" value="<%= (trenchAuto && trenchAuto.minTrendingScore) != null ? trenchAuto.minTrendingScore : 0 %>" min="0" max="50" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
    <div><label style="font-size:11px;color:#6b7280;">Max Positions</label><input type="number" id="auto-max-pos" value="<%= (trenchAuto && trenchAuto.maxOpenPositions) != null ? trenchAuto.maxOpenPositions : 3 %>" min="1" max="10" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
    <div><label style="font-size:11px;color:#6b7280;">$ per Trade (Paper)</label><input type="number" id="auto-amount-usd" value="<%= (trenchAuto && trenchAuto.amountPerTradeUsd) != null ? trenchAuto.amountPerTradeUsd : 20 %>" min="5" max="500" step="5" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
    <div><label style="font-size:11px;color:#6b7280;">SOL per Trade (Live)</label><input type="number" id="auto-amount-sol" value="<%= (trenchAuto && trenchAuto.amountPerTradeSol) != null ? trenchAuto.amountPerTradeSol : 0.05 %>" min="0.01" max="1" step="0.01" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
    <div><label style="font-size:11px;color:#6b7280;">Check (min)</label><input type="number" id="auto-check-min" value="<%= (trenchAuto && trenchAuto.checkIntervalMinutes) != null ? trenchAuto.checkIntervalMinutes : 15 %>" min="5" max="60" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
  </div>
  <details style="margin-top:16px;padding:12px;background:rgba(15,23,42,0.4);border-radius:8px;border:1px solid #1e2a3a;">
    <summary style="cursor:pointer;color:#e5e7eb;font-weight:600;">Profit Locking</summary>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin-top:12px;">
      <div><label style="font-size:11px;color:#6b7280;">TP %</label><input type="number" id="auto-tp" value="<%= (trenchAuto && trenchAuto.tpPercent) != null ? trenchAuto.tpPercent : 15 %>" min="5" max="100" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
      <div><label style="font-size:11px;color:#6b7280;">SL %</label><input type="number" id="auto-sl" value="<%= (trenchAuto && trenchAuto.slPercent) != null ? trenchAuto.slPercent : 10 %>" min="3" max="50" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
      <div><label style="font-size:11px;color:#6b7280;">Trailing %</label><input type="number" id="auto-trailing" value="<%= (trenchAuto && trenchAuto.trailingStopPercent) != null ? trenchAuto.trailingStopPercent : 10 %>" min="3" max="30" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
      <div><label style="font-size:11px;color:#6b7280;">Partial TP %</label><input type="number" id="auto-partial-tp" value="<%= (trenchAuto && trenchAuto.partialTpPercent) != null ? trenchAuto.partialTpPercent : 50 %>" min="0" max="100" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
      <div><label style="font-size:11px;color:#6b7280;">Partial at %</label><input type="number" id="auto-partial-at" value="<%= (trenchAuto && trenchAuto.partialTpAtPercent) != null ? trenchAuto.partialTpAtPercent : 15 %>" min="5" max="50" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
      <div><label style="font-size:11px;color:#6b7280;">Breakeven at %</label><input type="number" id="auto-breakeven-at" value="<%= (trenchAuto && trenchAuto.breakevenAtPercent) != null ? trenchAuto.breakevenAtPercent : 5 %>" min="2" max="20" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
      <div><label style="font-size:11px;color:#6b7280;">Max hold (min)</label><input type="number" id="auto-max-hold" value="<%= (trenchAuto && trenchAuto.maxHoldMinutes) != null ? trenchAuto.maxHoldMinutes : 60 %>" min="15" max="480" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;grid-column:1/-1;"><input type="checkbox" id="auto-use-trailing" <%= (trenchAuto && trenchAuto.useTrailingStop !== false) ? 'checked' : '' %>><span style="color:#e5e7eb;">Trailing stop</span></label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;grid-column:1/-1;"><input type="checkbox" id="auto-use-breakeven" <%= (trenchAuto && trenchAuto.useBreakevenStop !== false) ? 'checked' : '' %>><span style="color:#e5e7eb;">Breakeven stop</span></label>
    </div>
  </details>
  <details style="margin-top:8px;padding:12px;background:rgba(15,23,42,0.4);border-radius:8px;border:1px solid #1e2a3a;">
    <summary style="cursor:pointer;color:#e5e7eb;font-weight:600;">Entry Filters</summary>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin-top:12px;">
      <div><label style="font-size:11px;color:#6b7280;">Min Liq $</label><input type="number" id="auto-min-liq" value="<%= (trenchAuto && trenchAuto.minLiquidityUsd) != null ? trenchAuto.minLiquidityUsd : 0 %>" min="0" max="1000000" title="0 = no filter" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
      <div><label style="font-size:11px;color:#6b7280;">Max Top10 %</label><input type="number" id="auto-max-top10" value="<%= (trenchAuto && trenchAuto.maxTop10HoldersPercent) != null ? trenchAuto.maxTop10HoldersPercent : 100 %>" min="50" max="100" title="100 = no filter" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
      <div><label style="font-size:11px;color:#6b7280;">Max 24h %</label><input type="number" id="auto-max-24h" value="<%= (trenchAuto && trenchAuto.maxPriceChange24hPercent) != null ? trenchAuto.maxPriceChange24hPercent : 5000 %>" min="200" max="10000" title="Reject tokens that pumped more than this (default 5000 for memecoins)" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
      <div><label style="font-size:11px;color:#6b7280;">Cooldown (hr)</label><input type="number" id="auto-cooldown" value="<%= (trenchAuto && trenchAuto.cooldownHours) != null ? trenchAuto.cooldownHours : 4 %>" min="0" max="48" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;grid-column:1/-1;"><input type="checkbox" id="auto-use-filters" <%= (trenchAuto && trenchAuto.useEntryFilters !== false) ? 'checked' : '' %>><span style="color:#e5e7eb;">Use entry filters</span></label>
    </div>
  </details>
  <details style="margin-top:8px;padding:12px;background:rgba(15,23,42,0.4);border-radius:8px;border:1px solid #1e2a3a;">
    <summary style="cursor:pointer;color:#e5e7eb;font-weight:600;">Risk Controls</summary>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin-top:12px;">
      <div><label style="font-size:11px;color:#6b7280;">Max daily loss %</label><input type="number" id="auto-max-daily-loss" value="<%= (trenchAuto && trenchAuto.maxDailyLossPercent) != null ? trenchAuto.maxDailyLossPercent : 15 %>" min="0" max="50" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
      <div><label style="font-size:11px;color:#6b7280;">Pause after losses</label><input type="number" id="auto-consec-losses" value="<%= (trenchAuto && trenchAuto.consecutiveLossesToPause) != null ? trenchAuto.consecutiveLossesToPause : 3 %>" min="0" max="10" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
      <div><label style="font-size:11px;color:#6b7280;">Min SOL (live)</label><input type="number" id="auto-min-sol" value="<%= (trenchAuto && trenchAuto.minSolBalance) != null ? trenchAuto.minSolBalance : 0.05 %>" min="0.01" max="1" step="0.01" style="width:100%;padding:8px;background:#1e293b;border:1px solid #1e2a3a;border-radius:6px;color:#e5e7eb;"></div>
    </div>
  </details>
  <details style="margin-top:8px;padding:12px;background:rgba(15,23,42,0.4);border-radius:8px;border:1px solid #1e2a3a;">
    <summary style="cursor:pointer;color:#e5e7eb;font-weight:600;">Notifications</summary>
    <div style="margin-top:12px;">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="auto-notify-open" <%= (trenchAuto && trenchAuto.trenchNotifyTradeOpen !== false) ? 'checked' : '' %>><span style="color:#e5e7eb;">Notify on buy</span></label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-top:8px;"><input type="checkbox" id="auto-notify-close" <%= (trenchAuto && trenchAuto.trenchNotifyTradeClose !== false) ? 'checked' : '' %>><span style="color:#e5e7eb;">Notify on sell</span></label>
    </div>
  </details>
  <button type="button" id="btn-save-auto" class="nav-btn primary" style="margin-top:12px;padding:8px 16px;">Save Auto Settings</button>
  <button type="button" id="btn-run-now" class="nav-btn" style="margin-top:12px;margin-left:8px;padding:8px 16px;" title="Trigger auto trade run immediately">Run Now</button>
  <button type="button" id="btn-debug" class="nav-btn" style="margin-top:12px;margin-left:8px;padding:8px 16px;font-size:12px;">Debug</button>
  <% if (trenchAuto && trenchAuto.lastRunAt) { %>
  <p style="font-size:12px;color:#6b7280;margin-top:12px;">Last run: <%= new Date(trenchAuto.lastRunAt).toLocaleString() %></p>
  <% } %>
</div>
<% } %>

<!-- Trade History -->
<% if (typeof user !== 'undefined' && user) { %>
<div class="section" style="margin-bottom:24px;">
  <h3 style="color:#e5e7eb;margin-bottom:12px;">Trade History</h3>
  <div id="trade-history-container" style="overflow-x:auto;">
    <p style="color:#6b7280;font-size:13px;">Loading...</p>
  </div>
</div>
<% } %>

<!-- Trending Now -->
<div class="section" style="margin-bottom:24px;">
  <h3 style="color:#e5e7eb;margin-bottom:12px;">Trending Now (Solana)</h3>
  <p style="font-size:13px;color:#9ca3af;margin-bottom:12px;">Updated every 15 min. Click Buy to swap SOL for token (requires Phantom).</p>
  <% if (trendings && trendings.length > 0) { %>
  <div style="overflow-x:auto;">
    <table class="data-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Token</th>
          <th>Price</th>
          <th>24h %</th>
          <th>Score</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% trendings.forEach(function(t, i) {
          var chg = (t.priceChange24h || 0);
          var chgClass = chg >= 0 ? 'up' : 'down';
        %>
        <tr>
          <td><%= i + 1 %></td>
          <td>
            <% if (t.logo) { %><img src="<%= t.logo %>" alt="" style="width:24px;height:24px;border-radius:50%;vertical-align:middle;margin-right:8px;"><% } %>
            <strong style="color:#e5e7eb;"><%= t.symbol %></strong>
            <span style="color:#6b7280;font-size:11px;"><%= t.name %></span>
          </td>
          <td>$<%= (t.price || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 8 }) %></td>
          <td class="<%= chgClass %>"><%= chg >= 0 ? '+' : '' %><%= Number(chg).toFixed(2) %>%</td>
          <td><%= (t.trendingScore || 0).toFixed(1) %></td>
          <td>
            <% if (t.tokenAddress) { %>
            <button type="button" class="btn-buy-token nav-btn" style="padding:4px 10px;font-size:12px;" data-token-address="<%= t.tokenAddress %>" data-symbol="<%= t.symbol %>" data-name="<%= t.name %>" data-price="<%= t.price || 0 %>">Buy</button>
            <% if (typeof user !== 'undefined' && user) { %>
            <button type="button" class="btn-block-token nav-btn" style="padding:4px 8px;font-size:11px;margin-left:4px;" data-token-address="<%= t.tokenAddress %>" data-symbol="<%= t.symbol %>" title="Block from auto-trade">Block</button>
            <% } %>
            <% } else { %>
            <span style="color:#6b7280;font-size:11px;">—</span>
            <% } %>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
  <% } else { %>
  <p style="color:#6b7280;font-size:13px;">No trending data. Check Mobula API or try again later.</p>
  <% } %>
</div>

<!-- Quick Links -->
<div class="section" style="margin-bottom:24px;">
  <h3 style="color:#e5e7eb;margin-bottom:12px;">Quick Links</h3>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;">
    <a href="https://dexscreener.com/solana" target="_blank" rel="noopener" style="padding:10px 14px;background:#1e293b;border:1px solid #1e2a3a;border-radius:8px;color:#3b82f6;text-decoration:none;font-size:13px;">Dexscreener</a>
    <a href="https://pump.fun" target="_blank" rel="noopener" style="padding:10px 14px;background:#1e293b;border:1px solid #1e2a3a;border-radius:8px;color:#3b82f6;text-decoration:none;font-size:13px;">pump.fun</a>
    <a href="https://jup.ag" target="_blank" rel="noopener" style="padding:10px 14px;background:#1e293b;border:1px solid #1e2a3a;border-radius:8px;color:#3b82f6;text-decoration:none;font-size:13px;">Jupiter</a>
    <a href="https://birdeye.so" target="_blank" rel="noopener" style="padding:10px 14px;background:#1e293b;border:1px solid #1e2a3a;border-radius:8px;color:#3b82f6;text-decoration:none;font-size:13px;">Birdeye</a>
    <a href="https://mobula.io" target="_blank" rel="noopener" style="padding:10px 14px;background:#1e293b;border:1px solid #1e2a3a;border-radius:8px;color:#3b82f6;text-decoration:none;font-size:13px;">Mobula</a>
  </div>
</div>

<!-- Scalping Criteria -->
<div class="section" style="margin-bottom:24px;">
  <h3 style="color:#e5e7eb;margin-bottom:12px;">Scalping Criteria</h3>
  <p style="font-size:13px;color:#9ca3af;margin-bottom:12px;">Key filters for shitcoin scalps.</p>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;">
    <div style="padding:10px 14px;background:#1e293b;border-radius:8px;border-left:3px solid #10b981;"><strong style="color:#e5e7eb;">Liquidity</strong><br><span style="font-size:12px;color:#9ca3af;">$50k+ pool, volume spike</span></div>
    <div style="padding:10px 14px;background:#1e293b;border-radius:8px;border-left:3px solid #3b82f6;"><strong style="color:#e5e7eb;">Momentum</strong><br><span style="font-size:12px;color:#9ca3af;">5m/15m % change, not parabolic</span></div>
    <div style="padding:10px 14px;background:#1e293b;border-radius:8px;border-left:3px solid #a78bfa;"><strong style="color:#e5e7eb;">Smart Money</strong><br><span style="font-size:12px;color:#9ca3af;">Whale buys, sniper activity</span></div>
    <div style="padding:10px 14px;background:#1e293b;border-radius:8px;border-left:3px solid #eab308;"><strong style="color:#e5e7eb;">Security</strong><br><span style="font-size:12px;color:#9ca3af;">No honeypot, holder distribution</span></div>
    <div style="padding:10px 14px;background:#1e293b;border-radius:8px;border-left:3px solid #f97316;"><strong style="color:#e5e7eb;">Timing</strong><br><span style="font-size:12px;color:#9ca3af;">Volume before price, pullback entry</span></div>
    <div style="padding:10px 14px;background:#1e293b;border-radius:8px;border-left:3px solid #ef4444;"><strong style="color:#e5e7eb;">Exit</strong><br><span style="font-size:12px;color:#9ca3af;">10–25% TP, 5–10% SL, time stop</span></div>
  </div>
</div>

<!-- Buy Modal -->
<div id="buy-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;padding:20px;">
  <div style="background:#111827;border:1px solid #1e2a3a;border-radius:12px;padding:24px;max-width:400px;width:100%;">
    <h3 style="color:#fff;margin:0 0 16px 0;">Buy <span id="modal-token-symbol"></span></h3>
    <p id="modal-desc" style="color:#9ca3af;font-size:12px;margin:0 0 12px 0;">Paper: spend USD. Live: swap SOL via Phantom.</p>
    <div id="modal-amount-row" style="margin-bottom:12px;">
      <label style="display:block;color:#9ca3af;font-size:12px;margin-bottom:4px;">Amount (<span id="modal-amount-label">USD</span>)</label>
      <input type="number" id="modal-amount" step="0.01" min="0.01" placeholder="10" style="width:100%;padding:10px 12px;background:#0d1320;border:1px solid #1e2a3a;border-radius:8px;color:#e5e7eb;font-size:14px;">
    </div>
    <div id="modal-slippage-row" style="margin-bottom:16px;display:none;">
      <label style="display:block;color:#9ca3af;font-size:12px;margin-bottom:4px;">Slippage (%)</label>
      <input type="number" id="modal-slippage" value="5" min="1" max="50" style="width:100%;padding:10px 12px;background:#0d1320;border:1px solid #1e2a3a;border-radius:8px;color:#e5e7eb;font-size:14px;">
    </div>
    <div style="display:flex;gap:10px;">
      <button type="button" id="modal-cancel" class="nav-btn" style="flex:1;">Cancel</button>
      <button type="button" id="modal-confirm" class="nav-btn primary" style="flex:1;">Confirm Buy</button>
    </div>
    <div id="modal-status" style="margin-top:12px;font-size:12px;color:#9ca3af;"></div>
  </div>
</div>

<script>window.__TRENDINGS__ = <%- JSON.stringify((trendings || []).map(function(t){ return { tokenAddress: t.tokenAddress, price: t.price }; })) %>;</script>
<script src="https://unpkg.com/@solana/web3.js@1.95.4/lib/index.iife.min.js"></script>
<script src="/js/trench-phantom.js"></script>
<script>
(function() {
  var walletPubkey = null;
  var modalToken = null;
  var isPaperMode = true;

  function setMode(paper) {
    isPaperMode = !!paper;
    var paperBtn = document.getElementById('btn-mode-paper');
    var liveBtn = document.getElementById('btn-mode-live');
    if (paperBtn) paperBtn.className = isPaperMode ? 'nav-btn primary' : 'nav-btn';
    if (liveBtn) liveBtn.className = !isPaperMode ? 'nav-btn primary' : 'nav-btn';
    document.getElementById('modal-slippage-row').style.display = isPaperMode ? 'none' : 'block';
    document.getElementById('modal-amount-label').textContent = isPaperMode ? 'USD' : 'SOL';
    document.getElementById('modal-amount').placeholder = isPaperMode ? '10' : '0.1';
  }

  function showModal(token) {
    modalToken = token;
    document.getElementById('modal-token-symbol').textContent = token.symbol;
    document.getElementById('modal-amount').value = isPaperMode ? '10' : '0.1';
    document.getElementById('modal-slippage').value = '5';
    document.getElementById('modal-status').textContent = '';
    document.getElementById('modal-slippage-row').style.display = isPaperMode ? 'none' : 'block';
    document.getElementById('modal-amount-label').textContent = isPaperMode ? 'USD' : 'SOL';
    document.getElementById('buy-modal').style.display = 'flex';
  }

  function hideModal() {
    document.getElementById('buy-modal').style.display = 'none';
    modalToken = null;
  }

  function getPriceForToken(addr) {
    var list = window.__TRENDINGS__ || [];
    for (var i = 0; i < list.length; i++) {
      if (list[i].tokenAddress === addr) return list[i].price || 0;
    }
    return 0;
  }

  document.getElementById('btn-mode-paper').addEventListener('click', function() { setMode(true); });
  document.getElementById('btn-mode-live').addEventListener('click', function() {
    setMode(false);
    document.getElementById('btn-connect-wallet').style.display = 'inline-block';
  });
  document.getElementById('btn-connect-wallet').addEventListener('click', function() {
    if (window.TrenchPhantom && window.TrenchPhantom.connect) {
      window.TrenchPhantom.connect().then(function(pk) {
        walletPubkey = pk;
        document.getElementById('wallet-status').textContent = 'Connected: ' + (pk ? pk.slice(0,4) + '...' + pk.slice(-4) : '');
      }).catch(function(err) {
        document.getElementById('wallet-status').textContent = 'Error: ' + (err.message || 'Install Phantom');
      });
    } else {
      document.getElementById('wallet-status').textContent = 'Phantom not found.';
    }
  });
  setMode(true);

  document.getElementById('btn-reset-paper').addEventListener('click', function() {
    if (!confirm('Reset trench paper balance to $1,000? Close all positions first.')) return;
    fetch('/api/trench-warfare/paper/reset', { method: 'POST', credentials: 'same-origin' })
      .then(function(r) { return r.json(); })
      .then(function(d) {
        if (d.success) { document.getElementById('paper-balance').textContent = 'Paper: $' + d.trenchPaperBalance.toFixed(2); location.reload(); }
      });
  });

  document.querySelectorAll('.btn-buy-token').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var tokenAddress = this.getAttribute('data-token-address');
      var symbol = this.getAttribute('data-symbol');
      var name = this.getAttribute('data-name');
      var price = parseFloat(this.getAttribute('data-price')) || 0;
      if (isPaperMode) {
        if (!<%= typeof user !== 'undefined' && user ? 'true' : 'false' %>) { alert('Login to paper trade.'); return; }
        if (!price || price <= 0) { alert('Token price not available.'); return; }
        showModal({ tokenAddress: tokenAddress, symbol: symbol, name: name, price: price });
      } else {
        if (!walletPubkey) { alert('Connect Phantom first (click Live).'); return; }
        showModal({ tokenAddress: tokenAddress, symbol: symbol, name: name, price: price });
      }
    });
  });

  document.querySelectorAll('.btn-block-token').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var addr = this.getAttribute('data-token-address');
      var sym = this.getAttribute('data-symbol');
      if (!addr || !confirm('Block ' + sym + ' from auto-trade?')) return;
      fetch('/api/trench-warfare/blacklist/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ tokenAddress: addr })
      }).then(function(r) { return r.json(); }).then(function(d) {
        if (d.success) { btn.style.opacity = '0.5'; btn.disabled = true; btn.textContent = 'Blocked'; }
      });
    });
  });

  document.querySelectorAll('.btn-sell-paper').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var row = this.closest('tr');
      var posId = row.getAttribute('data-position-id');
      var tokenAddr = row.getAttribute('data-token-address');
      var price = getPriceForToken(tokenAddr);
      if (!price || price <= 0) { alert('Price not found. Refresh page to update.'); return; }
      fetch('/api/trench-warfare/paper/sell', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ positionId: posId, currentPrice: price })
      }).then(function(r) { return r.json(); }).then(function(d) {
        if (d.error) alert(d.error);
        else location.reload();
      });
    });
  });

  document.getElementById('modal-cancel').addEventListener('click', hideModal);

  document.getElementById('modal-confirm').addEventListener('click', function() {
    if (!modalToken) return;
    var amount = parseFloat(document.getElementById('modal-amount').value);
    if (!amount || amount <= 0) {
      document.getElementById('modal-status').textContent = 'Enter valid amount.';
      return;
    }
    var statusEl = document.getElementById('modal-status');

    if (isPaperMode) {
      statusEl.textContent = 'Buying...';
      fetch('/api/trench-warfare/paper/buy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({
          tokenAddress: modalToken.tokenAddress,
          tokenSymbol: modalToken.symbol,
          tokenName: modalToken.name,
          amountUsd: amount,
          price: modalToken.price || 0
        })
      }).then(function(r) { return r.json();       }).then(function(d) {
        if (d.error) statusEl.textContent = d.error;
        else { statusEl.textContent = 'Done!'; document.getElementById('paper-balance').textContent = 'Paper: $' + d.trenchPaperBalance.toFixed(2); if (typeof loadAnalytics === 'function') loadAnalytics(); setTimeout(function(){ hideModal(); location.reload(); }, 500); }
      }).catch(function(e) { statusEl.textContent = 'Error: ' + e.message; });
      return;
    }

    if (!walletPubkey) { statusEl.textContent = 'Connect Phantom first.'; return; }
    var slippage = parseFloat(document.getElementById('modal-slippage').value) || 5;
    statusEl.textContent = 'Getting quote...';
    fetch('/api/trench-warfare/swap/quote', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        tokenOut: modalToken.tokenAddress,
        amount: amount,
        walletAddress: walletPubkey,
        slippage: slippage
      })
    }).then(function(r) { return r.json(); }).then(function(quote) {
      if (quote.error) throw new Error(quote.error);
      var solana = quote.data && quote.data.solana;
      var serialized = solana && solana.transaction && solana.transaction.serialized;
      if (!serialized) throw new Error('No transaction in quote');
      statusEl.textContent = 'Sign in Phantom...';
      return window.TrenchPhantom.signAndSendTransaction(serialized);
    }).then(function(signedB64) {
      statusEl.textContent = 'Sending...';
      return fetch('/api/trench-warfare/swap/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          signedTransaction: signedB64,
          tokenAddress: modalToken.tokenAddress,
          tokenSymbol: modalToken.symbol,
          tokenName: modalToken.name,
          amountIn: amount,
          side: 'BUY',
          walletAddress: walletPubkey
        })
      });
    }).then(function(r) { return r.json(); }).then(function(result) {
      if (result.error) throw new Error(result.error);
      var data = result.data || result;
      if (data.success && data.transactionHash) {
        statusEl.innerHTML = 'Done! <a href="https://solscan.io/tx/' + data.transactionHash + '" target="_blank" rel="noopener" style="color:#3b82f6;">View tx</a>';
        hideModal();
      } else {
        statusEl.textContent = 'Failed: ' + (result.error || 'Unknown');
      }
    }).catch(function(err) {
      statusEl.textContent = 'Error: ' + (err.message || err);
    });
  });

  document.getElementById('buy-modal').addEventListener('click', function(e) {
    if (e.target === this) hideModal();
  });

  var btnConnectBot = document.getElementById('btn-connect-bot');
  var btnDisconnectBot = document.getElementById('btn-disconnect-bot');
  var btnSaveAuto = document.getElementById('btn-save-auto');
  if (btnConnectBot) {
    btnConnectBot.addEventListener('click', function() {
      document.getElementById('bot-key-modal').style.display = 'flex';
    });
  }
  var botKeyModal = document.getElementById('bot-key-modal');
  if (document.getElementById('bot-key-cancel')) {
    document.getElementById('bot-key-cancel').addEventListener('click', function() {
      if (botKeyModal) botKeyModal.style.display = 'none';
    });
  }
  if (botKeyModal) {
    botKeyModal.addEventListener('click', function(e) {
      if (e.target === botKeyModal) botKeyModal.style.display = 'none';
    });
  }
  if (document.getElementById('bot-key-connect')) {
    document.getElementById('bot-key-connect').addEventListener('click', function() {
      var pk = (document.getElementById('bot-private-key').value || '').trim();
      if (!pk) { alert('Paste your private key'); return; }
      fetch('/api/trench-warfare/bot/connect', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ privateKeyBase58: pk })
      }).then(function(r) { return r.json(); }).then(function(d) {
        if (d.error) alert(d.error);
        else { document.getElementById('bot-key-modal').style.display = 'none'; document.getElementById('bot-private-key').value = ''; location.reload(); }
      });
    });
  }
  if (btnDisconnectBot) {
    btnDisconnectBot.addEventListener('click', function() {
      if (!confirm('Disconnect bot wallet? Auto live trading will stop.')) return;
      fetch('/api/trench-warfare/bot/disconnect', { method: 'POST', credentials: 'same-origin' })
        .then(function(r) { return r.json(); }).then(function() { location.reload(); });
    });
  }
  if (btnSaveAuto) {
    btnSaveAuto.addEventListener('click', function() {
      var payload = {
        enabled: document.getElementById('auto-enabled').checked,
        mode: document.getElementById('auto-mode').value,
        minTrendingScore: parseInt(document.getElementById('auto-min-score').value, 10),
        maxOpenPositions: parseInt(document.getElementById('auto-max-pos').value, 10),
        amountPerTradeUsd: parseFloat(document.getElementById('auto-amount-usd').value),
        amountPerTradeSol: parseFloat(document.getElementById('auto-amount-sol').value),
        checkIntervalMinutes: parseInt(document.getElementById('auto-check-min')?.value || 15, 10),
        tpPercent: parseFloat(document.getElementById('auto-tp')?.value || 15),
        slPercent: parseFloat(document.getElementById('auto-sl')?.value || 10),
        trailingStopPercent: parseFloat(document.getElementById('auto-trailing')?.value || 10),
        useTrailingStop: document.getElementById('auto-use-trailing')?.checked !== false,
        partialTpPercent: parseFloat(document.getElementById('auto-partial-tp')?.value || 50),
        partialTpAtPercent: parseFloat(document.getElementById('auto-partial-at')?.value || 15),
        breakevenAtPercent: parseFloat(document.getElementById('auto-breakeven-at')?.value || 5),
        useBreakevenStop: document.getElementById('auto-use-breakeven')?.checked !== false,
        maxHoldMinutes: parseInt(document.getElementById('auto-max-hold')?.value || 60, 10),
        minLiquidityUsd: parseFloat(document.getElementById('auto-min-liq')?.value || 10000),
        maxTop10HoldersPercent: parseFloat(document.getElementById('auto-max-top10')?.value || 80),
        maxPriceChange24hPercent: parseFloat(document.getElementById('auto-max-24h')?.value || 5000),
        cooldownHours: parseFloat(document.getElementById('auto-cooldown')?.value || 4),
        useEntryFilters: document.getElementById('auto-use-filters')?.checked !== false,
        maxDailyLossPercent: parseFloat(document.getElementById('auto-max-daily-loss')?.value || 15),
        consecutiveLossesToPause: parseInt(document.getElementById('auto-consec-losses')?.value || 3, 10),
        minSolBalance: parseFloat(document.getElementById('auto-min-sol')?.value || 0.05),
        trenchNotifyTradeOpen: document.getElementById('auto-notify-open')?.checked !== false,
        trenchNotifyTradeClose: document.getElementById('auto-notify-close')?.checked !== false
      };
      fetch('/api/trench-warfare/auto/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      }).then(function(r) { return r.json(); }).then(function(d) {
        if (d.error) alert(d.error);
        else alert('Auto settings saved.');
      });
    });
  }

  function loadAnalytics() {
    fetch('/api/trench-warfare/analytics', { credentials: 'same-origin' })
      .then(function(r) { return r.json(); })
      .then(function(d) {
        if (d.error) return;
        var el = document.getElementById('stat-total-pnl');
        if (el) { el.textContent = '$' + (d.totalPnl || 0).toFixed(2); el.style.color = (d.totalPnl || 0) >= 0 ? '#10b981' : '#ef4444'; }
        el = document.getElementById('stat-win-rate');
        if (el) el.textContent = (d.winRate || 0) + '%';
        el = document.getElementById('stat-trades');
        if (el) el.textContent = d.totalTrades || 0;
        el = document.getElementById('stat-best-worst');
        if (el) { el.innerHTML = '<span style="color:#10b981">$' + (d.bestTrade || 0).toFixed(2) + '</span> / <span style="color:#ef4444">$' + (d.worstTrade || 0).toFixed(2) + '</span>'; }
        var paused = document.getElementById('trench-paused');
        if (paused && d.paused) { paused.style.display = 'block'; document.getElementById('paused-reason').textContent = d.pausedReason || ''; }
        var hist = document.getElementById('trade-history-container');
        if (hist && d.closedTrades && d.closedTrades.length > 0) {
          hist.innerHTML = '<table class="data-table"><thead><tr><th>Token</th><th>Side</th><th>Type</th><th>Entry</th><th>Exit</th><th>PnL</th><th>Date</th></tr></thead><tbody>' +
            d.closedTrades.slice(0, 20).map(function(t) {
              var pnl = (t.pnl || 0);
              var pnlCl = pnl >= 0 ? '#10b981' : '#ef4444';
              return '<tr><td><strong>' + (t.tokenSymbol || '') + '</strong></td><td>' + (t.side || '') + '</td><td>' + (t.isPaper ? 'Paper' : 'Live') + '</td><td>$' + (t.entryPrice || 0).toFixed(8) + '</td><td>$' + (t.exitPrice || 0).toFixed(8) + '</td><td style="color:' + pnlCl + '">$' + pnl.toFixed(2) + '</td><td>' + (t.exitTime ? new Date(t.exitTime).toLocaleString() : '') + '</td></tr>';
            }).join('') + '</tbody></table>';
        } else if (hist) {
          hist.innerHTML = '<p style="color:#6b7280;font-size:13px;">No closed trades yet.</p>';
        }
      }).catch(function() {});
  }
  if (document.getElementById('trench-analytics')) {
    loadAnalytics();
    setInterval(loadAnalytics, 20000);
  }

  var btnRunNow = document.getElementById('btn-run-now');
  var btnDebug = document.getElementById('btn-debug');
  if (btnDebug) btnDebug.addEventListener('click', function() {
    fetch('/api/trench-warfare/auto/debug', { credentials: 'same-origin' })
      .then(function(r) { return r.json(); })
      .then(function(d) {
        if (d.error) alert(d.error);
        else alert('Trendings: ' + d.trendings + '\nBalance: $' + d.balance + '\nOpen: ' + d.openCount + '/' + d.maxPositions + '\nCan buy: ' + d.canBuy + '\nAuto: ' + (d.autoEnabled ? 'ON' : 'OFF') + ' (' + (d.mode || 'paper') + ')\nSample: ' + (d.sample ? d.sample.symbol + ' $' + d.sample.price : 'none'));
      });
  });

  if (btnRunNow) btnRunNow.addEventListener('click', function() {
    btnRunNow.disabled = true;
    btnRunNow.textContent = 'Running...';
    var payload = { enabled: true, mode: (document.getElementById('auto-mode') || {}).value || 'paper' };
    fetch('/api/trench-warfare/auto/run-now', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify(payload) })
      .then(function(r) { return r.json(); })
      .then(function(d) {
        if (d.error) { alert(d.error); btnRunNow.disabled = false; btnRunNow.textContent = 'Run Now'; return; }
        var trades = d.trades || 0;
        var msg = 'Done. ' + (trades === 0 ? 'No trades executed.' : trades + ' trade' + (trades === 1 ? '' : 's') + ' executed.') + ' ' + (d.trendings || 0) + ' tokens scanned.';
        if (d.reason) msg += ' (' + d.reason + ')';
        alert(msg);
        location.reload();
      })
      .catch(function(e) { alert('Error: ' + (e.message || e)); btnRunNow.disabled = false; btnRunNow.textContent = 'Run Now'; });
    return;
  });

  ['btn-unpause', 'btn-unpause-banner'].forEach(function(id) {
    var btn = document.getElementById(id);
    if (btn) btn.addEventListener('click', function() {
      fetch('/api/trench-warfare/unpause', { method: 'POST', credentials: 'same-origin' })
        .then(function(r) { return r.json(); }).then(function(d) { if (d.success) location.reload(); });
    });
  });
})();
</script>

<%- include('partials/footer') %>
